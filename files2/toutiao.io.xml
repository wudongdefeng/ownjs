<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>å¼€å‘è€…å¤´æ¡</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>1caa30ebfd7f8b3a492dd697916734b9</guid>
<title>Javaæ— åƒåœ¾ç¨³æ€è®¾è®¡</title>
<link>https://toutiao.io/k/ly1kfiv</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content &quot; id=&quot;js_content&quot;&gt;
                    

                    
                    
                    
                    &lt;p&gt;&lt;span&gt;æœ€è¿‘åœ¨é‡æ„&lt;/span&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247484045&amp;amp;idx=2&amp;amp;sn=25cf3c0399cf92edbd57e207f18afea3&amp;amp;chksm=fafde823cd8a61354d12e2355829b78b0a84b422ec4d3569bbbff711cb9b1cb3315eafaef9ac&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;ã€Šç®€æ˜æ—¥å¿—è§„èŒƒã€‹&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot; wah-hotarea=&quot;click&quot;&gt;ã€Šç®€æ˜æ—¥å¿—è§„èŒƒã€‹&lt;/a&gt;&lt;span&gt;ï¼Œå°±æ˜¯é‡æ„æˆ‘è‡ªå·±ä¹‹å‰å¼€æºçš„ä¸€ä¸ªç»Ÿä¸€æ—¥å¿—çš„ç»„ä»¶ã€‚å¯¹äºæ‰“å°æ—¥å¿—ï¼Œæœ€é‡è¦çš„æˆ‘è®¤ä¸ºæœ‰ä¸¤ç‚¹ï¼šç¬¬ä¸€ç‚¹æ˜¯å¼‚æ­¥ï¼Œä¸èƒ½å› ä¸ºæ‰“å°æ—¥å¿—è€Œå½±å“æ­£å¸¸çš„ç¨‹åºæ‰§è¡Œï¼Œå¯¼è‡´ç­‰å¾…IOå¡é¡¿ï¼›ç¬¬äºŒç‚¹æ˜¯å°½é‡å‡å°‘åƒåœ¾ï¼Œ&lt;span&gt;æ‰€è°“åƒåœ¾æ˜¯è¯´&lt;/span&gt;&lt;span&gt;è®¸å¤šæ—¥å¿—åº“åœ¨æ—¥å¿—è®°å½•æœŸé—´åˆ†é…ä¸´æ—¶å¯¹è±¡ï¼Œå¦‚æ—¥å¿—äº‹ä»¶å¯¹è±¡ï¼Œå­—ç¬¦ä¸²ï¼Œå­—ç¬¦æ•°ç»„ï¼Œå­—èŠ‚æ•°ç»„ç­‰ã€‚è¿™ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆå‹åŠ›å¹¶å¢åŠ GCæš‚åœå‘ç”Ÿçš„é¢‘ç‡ã€‚&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span/&gt;å…¶ä¸­ï¼Œå¼‚æ­¥è®¾è®¡å·²ç»æ˜¯å¾ˆæˆç†Ÿçš„é¢†åŸŸäº†ã€‚&lt;/span&gt;ä½†æ˜¯ä½åƒåœ¾ã€æ— åƒåœ¾çš„ç ”ç©¶è¿˜æ¯”è¾ƒå°‘ã€‚&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;span/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;åœ¨&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247486299&amp;amp;idx=1&amp;amp;sn=34ea00ad39901a51331bfd95dee0c641&amp;amp;chksm=fafde1f5cd8a68e31c7b8d5fa5b21fc70f5e49663f4cd6e6ea0a0639696556bc197b97ea241b&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;ã€Šåº”ç”¨ç¨‹åºæ€æ ·åˆ’åˆ†æ¨¡å—ï¼Ÿã€‹&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;ã€Šåº”ç”¨ç¨‹åºæ€æ ·åˆ’åˆ†æ¨¡å—ï¼Ÿã€‹&lt;/a&gt;é‡Œæˆ‘æåˆ°ä½¿ç”¨ç™»é«˜ç±»æ¯”æ³•è¿›è¡Œä¸šç•Œè°ƒç ”ã€‚ä¸šç•Œè°ƒç ”è‡ªç„¶ä¸ä¼šæ”¾è¿‡Log4jã€Logbackè¿™äº›éƒ½å¹¿æ³›è®¤å¯çš„ä¼˜ç§€æ—¥å¿—ç»„ä»¶ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Log4j2ä»ç‰ˆæœ¬2.6å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»¥â€œæ— åƒåœ¾â€æ¨¡å¼è¿è¡Œã€‚&lt;/span&gt;&lt;span&gt;æ— åƒ&lt;/span&gt;åœ¾åŸç†å°±æ˜¯&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247486339&amp;amp;idx=1&amp;amp;sn=ca9b6a4ba1a98a9182b7ff9e81a7e7ea&amp;amp;chksm=fafde12dcd8a683b385853e053fb7444ef3772f09d39c977c1a69581e4ff294a45e8ab8fd53b&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;ã€ŠThreadLocal&amp;amp;MDCå†…å­˜æ³„æ¼é—®é¢˜ã€‹&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;ã€ŠThreadLocal&amp;amp;MDCå†…å­˜æ³„æ¼é—®é¢˜ã€‹&lt;/a&gt;ä¸­ä»‹ç»çš„ThreadLocalã€‚&lt;span&gt;å› ä¸º&lt;/span&gt;&lt;span&gt;é‡ç”¨å¯¹è±¡å’Œç¼“å†²åŒºï¼Œå¹¶ä¸”å°½å¯èƒ½ä¸åˆ†é…ä¸´æ—¶å¯¹è±¡ã€‚ä»ç‰©ç†å±‚é¢ä¸Šï¼Œå¯¹è±¡çš„å†…å­˜åŒºåŸŸæ˜¯é€šè¿‡æ•°æ®è¦†ç›–ï¼Œè€Œä¸æ˜¯åƒåœ¾å›æ”¶æ¥è¾¾åˆ°æ—¥å¿—è¯»å†™å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ä¿å­˜çš„ç›®çš„ã€‚&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ä»¥ä¸‹æ˜¯å®˜ç½‘å¯¹æ— åƒåœ¾è®°å½•å“åº”æ—¶é—´è¡Œä¸ºè¿›è¡Œçš„è¯•éªŒï¼š&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h1/&gt;&lt;p&gt;ä¸‹å›¾å°† Log4j çš„å¼‚æ­¥ Logger çš„â€œç»å…¸â€è®°å½•ä¸æ— åƒåœ¾è®°å½•å“åº”æ—¶é—´è¡Œä¸ºè¿›è¡Œäº†æ¯”è¾ƒã€‚åœ¨å›¾ä¸­ï¼Œâ€œ 100kâ€è¡¨ç¤ºä»¥ 100,000 æ¶ˆæ¯/ç§’çš„æŒç»­è´Ÿè½½è¿›è¡Œè®°å½•ï¼Œâ€œ 800kâ€è¡¨ç¤º 800,000 æ¶ˆæ¯/ç§’çš„æŒç»­è´Ÿè½½ã€‚&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.6&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRl8YTHlRBJKRc4TjDgKxu4dID6miansD3hOFLlr2C9B6EvibFWLaEnCMsJ4HGPRKZGtkpN0Zu2X4cZcA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;800&quot;/&gt;&lt;/p&gt;&lt;p&gt;åœ¨â€œç»å…¸â€æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å¤§é‡æ¬¡è¦åƒåœ¾å›æ”¶ï¼Œè¿™äº›åƒåœ¾å›æ”¶ä¼šä½¿åº”ç”¨ç¨‹åºçº¿ç¨‹æš‚åœ 3 æ¯«ç§’æˆ–æ›´é•¿æ—¶é—´ã€‚è¿™å¾ˆå¿«å°±å¢åŠ äº†å°†è¿‘ 10 æ¯«ç§’çš„å“åº”æ—¶é—´å»¶è¿Ÿã€‚å¦‚æ‚¨åœ¨å›¾è¡¨ä¸­æ‰€è§ï¼Œå¢åŠ è´Ÿè½½å°†æ›²çº¿å‘å·¦ç§»åŠ¨(å­˜åœ¨æ›´å¤šå°–å³°)ã€‚è¿™æ˜¯æœ‰é“ç†çš„ï¼šæ›´å¤šçš„æ—¥å¿—è®°å½•æ„å‘³ç€å¯¹åƒåœ¾æ”¶é›†å™¨æ–½åŠ æ›´å¤§çš„å‹åŠ›ï¼Œä»è€Œå¯¼è‡´æ›´å°çš„ GC æš‚åœã€‚æˆ‘ä»¬åšäº†ä¸€äº›å®éªŒï¼Œå°†è´Ÿè½½å‡å°‘åˆ° 50,000 ç”šè‡³ 5000 æ¡æ¶ˆæ¯/ç§’ï¼Œä½†è¿™å¹¶æ²¡æœ‰æ¶ˆé™¤ 3 æ¯«ç§’çš„æš‚åœï¼Œåªæ˜¯ä½¿å®ƒä»¬çš„å‘ç”Ÿé¢‘ç‡é™ä½äº†ã€‚è¯·æ³¨æ„ï¼Œæ­¤æµ‹è¯•ä¸­çš„æ‰€æœ‰ GC æš‚åœéƒ½æ˜¯æ¬¡è¦çš„ GC æš‚åœã€‚æˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°ä»»ä½•å®Œæ•´çš„åƒåœ¾å›æ”¶ã€‚&lt;/p&gt;&lt;p&gt;åœ¨â€œæ— åƒåœ¾â€æ¨¡å¼ä¸‹ï¼Œåœ¨å„ç§è´Ÿè½½ä¸‹ï¼Œæœ€å¤§å“åº”æ—¶é—´ä»è¿œä½äº 1 æ¯«ç§’ã€‚(æœ€å¤§ 780 usï¼Œ800,000 æ¶ˆæ¯/ç§’ï¼Œæœ€å¤§ 407 usï¼Œ600,000 æ¶ˆæ¯/ç§’ï¼Œå…¶ä¸­ 99ï¼…å›´ç»• 5 us è¾¾åˆ° 800,000 æ¶ˆæ¯/ç§’çš„æ‰€æœ‰è´Ÿè½½.)å¢åŠ æˆ–å‡å°‘è´Ÿè½½ä¸ä¼šæ”¹å˜å“åº”æ—¶é—´ã€‚æˆ‘ä»¬æ²¡æœ‰è°ƒæŸ¥åœ¨è¿™äº›æµ‹è¯•ä¸­çœ‹åˆ°çš„ 200-300 å¾®ç§’æš‚åœçš„åŸå› ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;å½“æˆ‘ä»¬è¿›ä¸€æ­¥å¢åŠ è´Ÿè½½æ—¶ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹åˆ°ç»å…¸å’Œæ— åƒåœ¾è®°å½•çš„å“åº”æ—¶é—´éƒ½æœ‰è¾ƒå¤§çš„æš‚åœã€‚åœ¨ 100 ä¸‡æ¡æ¶ˆæ¯/ç§’æˆ–æ›´å¤šçš„æŒç»­è´Ÿè½½ä¸‹ï¼Œæˆ‘ä»¬å¼€å§‹æ¥è¿‘åº•å±‚ RandomAccessFile Appender çš„æœ€å¤§ååé‡(è¯·å‚è§ä¸‹é¢çš„åŒæ­¥æ—¥å¿—è®°å½•ååé‡å›¾è¡¨)ã€‚åœ¨è¿™äº›è´Ÿè½½ä¸‹ï¼Œç¯å½¢ç¼“å†²åŒºå¼€å§‹å¡«æ»¡ï¼Œåå‹å¼€å§‹èµ·ä½œç”¨ï¼šåœ¨ç¯å½¢ç¼“å†²åŒºå·²æ»¡æ—¶å°è¯•æ·»åŠ å¦ä¸€æ¡æ¶ˆæ¯å°†é˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨æ’æ§½å¯ç”¨ä¸ºæ­¢ã€‚æˆ‘ä»¬å¼€å§‹çœ‹åˆ°å“åº”æ—¶é—´ä¸ºæ•°åæ¯«ç§’æˆ–æ›´é•¿ï¼›å°è¯•è¿›ä¸€æ­¥å¢åŠ è´Ÿè½½ä¼šå¯¼è‡´è¶Šæ¥è¶Šå¤§çš„å“åº”æ—¶é—´å³°å€¼ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;è¯•éªŒå¯ä»¥çœ‹å‡ºæ— åƒåœ¾æ¨¡å¼å¯¹æ€§èƒ½æå‡ä¸Šæœ‰æå¤§çš„å¥½å¤„ã€‚é‚£å¦‚æœæ˜¯è‡ªåˆ¶ç»“æ„åŒ–æ—¥å¿—ç»„ä»¶æ€ä¹ˆå®ç°æ— åƒåœ¾æ¨¡å¼å‘¢ï¼Ÿ&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;æˆ‘è‡ªå·±åšçš„ç®€æ˜æ—¥å¿—ç»„ä»¶æ˜¯ä¸ºäº†å…¬å¸çš„ç»“æ„åŒ–æ—¥å¿—åšæŠ½è±¡è€Œäº§ç”Ÿã€‚æˆ‘å°†ç»“æ„åŒ–æ—¥å¿—è¦æ‰“å°çš„åˆ—å®šä¹‰ä¸ºä¸€ä¸ªå¯¹è±¡LogBuilderã€‚å±æ€§å°±æ˜¯æ—¥å¿—è¦è¾“å‡ºçš„å†…å®¹ã€‚è¿™æ ·å¤§å®¶å°±å¯ä»¥ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥ç»„è£…æ—¥å¿—å¯¹è±¡äº†ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;LogBuilderçš„å˜é‡æœ‰ä¸‰ç§æƒ…å†µï¼š&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ç¬¬ä¸€ç§æ˜¯å…¨å±€å˜é‡ï¼Œæ¯”å¦‚æœºæˆ¿ä¿¡æ¯ï¼ŒæœåŠ¡å¯åŠ¨æ—¶æœºæˆ¿å°±å›ºå®šä¸å˜äº†ã€‚è¿™ç§å˜é‡å¯ä»¥å®šä¹‰ä¸ºé™æ€å˜é‡ï¼Œå…¨å±€å”¯ä¸€ï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å¤„ç†ã€‚&lt;/p&gt;&lt;p&gt;class LogBuilderÂ {&lt;/p&gt;&lt;p&gt;Â  Â Â private static String idc;Â &lt;/p&gt;&lt;p&gt;Â  Â  static {&lt;/p&gt;&lt;p&gt;Â Â  Â  Â  Â  idc =Â ä»é…ç½®æ–‡ä»¶ç­‰å¤„è¯»å–å¹¶åˆå§‹åŒ–ï¼›&lt;/p&gt;&lt;p&gt;Â  Â  }&lt;/p&gt;&lt;p&gt;}&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ç¬¬äºŒç§æ˜¯çº¿ç¨‹å”¯ä¸€ï¼Œæ¯”å¦‚çº¿ç¨‹è¿½è¸ªå·ï¼Œè¿™ç§ä¿¡æ¯å¯ä»¥é€šè¿‡åˆ‡é¢åœ¨è¯·æ±‚å…¥å£å¤„è®¾ç½®ä¸€æ¬¡ä¿å­˜åˆ°MDCä¸­ï¼Œä½¿ç”¨æ—¶ä»MDCä¸­å–å¾—ï¼Œ&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUzNjAxODg4MQ==&amp;amp;mid=2247486339&amp;amp;idx=1&amp;amp;sn=ca9b6a4ba1a98a9182b7ff9e81a7e7ea&amp;amp;chksm=fafde12dcd8a683b385853e053fb7444ef3772f09d39c977c1a69581e4ff294a45e8ab8fd53b&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;ã€ŠThreadLocal&amp;amp;MDCå†…å­˜æ³„æ¼é—®é¢˜ã€‹&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;ã€ŠThreadLocal&amp;amp;MDCå†…å­˜æ³„æ¼é—®é¢˜ã€‹&lt;/a&gt;ä¸­æœ‰ä»‹ç»ï¼ŒMDCç›¸å¯¹å®‰å…¨æ— å†…å­˜æ³„æ¼é£é™©ã€‚MDCç”±äºè·Ÿç€çº¿ç¨‹èµ°ï¼Œçº¿ç¨‹é‡‡ç”¨çº¿ç¨‹æ± æ—¶å®ƒå¯ä»¥è¢«å¤å†™æ— éœ€åƒåœ¾å›æ”¶ã€‚&lt;/p&gt;&lt;p&gt;classÂ LogBuilderÂ {&lt;/p&gt;&lt;p&gt;Â  Â  privateÂ static String traceId;Â &lt;/p&gt;&lt;p&gt;Â  Â Â &lt;/p&gt;&lt;p&gt;Â  Â  publicÂ void static setTraceId(String traceId) {&lt;/p&gt;&lt;p&gt;Â  Â Â Â  Â  Â MDC.set(&quot;traceId&quot;, traceId);&lt;/p&gt;&lt;p&gt;Â  Â  }&lt;/p&gt;&lt;p&gt;}&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ç¬¬ä¸‰ç§æ˜¯çº¿ç¨‹å†…å˜åŒ–çš„ï¼Œæ¯”å¦‚æ‰§è¡Œé˜¶æ®µï¼Œè¿™ç§å¯¹è±¡åªèƒ½è·Ÿç€LogBuilderçš„å®ä¾‹å¯¹è±¡èµ°ï¼Œä¸­é—´å¯ä»¥è¢«é‡æ–°èµ‹å€¼å¹¶æ‰“å°ã€‚è¿™æ—¶å€™å°±éœ€è¦æŠŠæ•´ä¸ªLogBuilderå¯¹è±¡æ”¾åˆ°ThreadLocalä¸­ï¼Œè®©å®ƒä¹Ÿè·Ÿç€å¯¹è±¡å®ä¾‹èµ°ã€‚ä½†æ˜¯è¿™é‡Œé¢æœ‰ä¸ªå…³é”®ï¼Œå°±æ˜¯å¯¹è±¡çš„toStringæ–¹æ³•è¢«è°ƒç”¨åè¿™ä¸ªæ‰“å°çš„stringå°±ä¼šè¢«å›æ”¶ã€‚æ‰€ä»¥æˆ‘ä»¬æ‰“å°æ—¥å¿—æ—¶ç»„è£…çš„å­—ç¬¦ä¸²æœ€å¥½ä¸ç”¨toStringï¼Œè€Œæ˜¯æ–°å†™ä¸€ä¸ªæ–¹æ³•æ¥ç”Ÿæˆå¹¶å°†ç»“æœä¿å­˜åˆ°LogBuilderçš„å±€éƒ¨å˜é‡ä¸­ã€‚è¿™æ ·æ‰“å°å®Œæˆå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ã€‚è€Œæ˜¯åœ¨ä¸‹æ¬¡ä½¿ç”¨æ—¶è¢«å¤å†™ã€‚&lt;/p&gt;&lt;p&gt;@Data&lt;/p&gt;&lt;p&gt;classÂ LogBuilderÂ {&lt;/p&gt;&lt;p&gt;Â  Â  private static ThreadLocalÂ threadLocal =Â new ThreadLocal();&lt;/p&gt;&lt;p&gt;Â  Â Â privateÂ static String idc;Â &lt;/p&gt;&lt;p&gt;Â Â  Â privateÂ staticÂ String traceId;Â &lt;/p&gt;&lt;p&gt;Â  Â  privateÂ String step;Â &lt;/p&gt;&lt;p&gt;Â  Â  privateÂ String toString;&lt;/p&gt;&lt;p&gt;Â Â  Â &lt;/p&gt;&lt;p&gt;Â  Â  public static LogBuilder getInstance() {&lt;/p&gt;&lt;p&gt;Â  Â  Â  Â  Â  if(threadLocal.get()==null) {&lt;/p&gt;&lt;p&gt;Â Â Â  Â  Â  Â Â Â  threadLocal.set(new LogBuilder());&lt;/p&gt;&lt;p&gt;Â  Â  Â  Â  Â  }&lt;br/&gt;Â  Â  Â  Â  Â  returnÂ threadLocal.get();&lt;/p&gt;&lt;p&gt;Â  Â Â }&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;Â  Â  publicÂ StringÂ buildString() {&lt;/p&gt;&lt;p&gt;Â  Â  Â  Â toStringÂ = idc+&quot;|&quot;+traceId+&quot;|&quot;+step;&lt;/p&gt;&lt;p&gt;Â  Â  }&lt;/p&gt;&lt;p&gt;}&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;å½“ç„¶è¿™é‡Œåªæ˜¯ä¸ºäº†è¯´æ˜æ— åƒåœ¾å†™çš„ç¤ºä¾‹ä»£ç ï¼Œå®é™…ä¸Šçš„å®ç°ä½¿ç”¨äº†ä¸€äº›åå°„ç­‰æŠ€æœ¯ï¼Œä»£ç å¾ˆç²¾ç®€ï¼Œé€šç”¨æ€§å¼ºã€‚å®é™…åŸç†å’ŒLog4j2çš„æ— åƒåœ¾ç¨³æ€åŸç†ä¸€è‡´ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;æ€»ç»“å’Œå°æŠ€å·§&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;LogBuilderå¯¹è±¡æœ€åˆæˆ‘çš„è®¾è®¡æ˜¯ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•newå‡ºæ¥çš„ã€‚è¿™ä¹Ÿæ˜¯ã€Šæœ‰æ•ˆçš„Javaã€‹æ¨èçš„æ–¹å¼ï¼Œå¯ä»¥å¾ˆå¥½çš„è¿›è¡Œå®ä¾‹æ§åˆ¶ï¼Œä¿æŒæ¸…æ™°æ€§å’Œç®€æ´æ€§ã€‚åæ¥åŠ å…¥äº†ThreadLocalæ¥è¿›è¡Œæ— åƒåœ¾ç¨³æ€è®¾è®¡ã€‚è¿™æ—¶è¦æ³¨æ„æä¾›clearæ–¹æ³•æ¸…ç©ºå±æ€§å€¼ï¼Œå› ä¸ºå’Œä¸»é¢˜æ— å…³ï¼Œæˆ‘åœ¨ä»£ç ä¸­çœç•¥äº†è¿™ä¸€éƒ¨åˆ†ã€‚å…³é”®æ¥äº†ï¼Œæ€§èƒ½æå‡äº†ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘äº†æ€ä¹ˆæ¥æµ‹è¯•éªŒè¯å‘¢ï¼Ÿ&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;æˆ‘ä½¿ç”¨äº†jolå·¥å…·æ¥ç›‘æ§å†…å­˜æƒ…å†µï¼Œä½¿ç”¨æ–¹æ³•ï¼Œå…ˆä¸Šmavenåæ ‡ï¼š&lt;/p&gt;&lt;pre&gt;&amp;lt;dependency&amp;gt;&lt;br/&gt;    &amp;lt;groupId&amp;gt;org.openjdk.jol&amp;lt;/groupId&amp;gt;&lt;br/&gt;    &amp;lt;artifactId&amp;gt;jol-core&amp;lt;/artifactId&amp;gt;&lt;br/&gt;    &amp;lt;version&amp;gt;0.14&amp;lt;/version&amp;gt;&lt;br/&gt;&amp;lt;/dependency&amp;gt;&lt;/pre&gt;&lt;p&gt;ä»£ç ä¸­ä½¿ç”¨æ—¶&lt;/p&gt;&lt;pre&gt;&lt;span&gt;log&lt;/span&gt;.info(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;å†…éƒ¨ä¿¡æ¯ï¼š&lt;/span&gt;&lt;span&gt;[{}]&quot;&lt;/span&gt;, ClassLayout.&lt;span&gt;parseInstance&lt;/span&gt;(pojo).toPrintable());&lt;br/&gt;&lt;span&gt;log&lt;/span&gt;.info(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;å¤–éƒ¨ä¿¡æ¯&lt;/span&gt;&lt;span&gt;[{}]&quot;&lt;/span&gt;, GraphLayout.&lt;span&gt;parseInstance&lt;/span&gt;(pojo).toPrintable());&lt;br/&gt;&lt;span&gt;log&lt;/span&gt;.info(&lt;span&gt;&quot;totalSize[{}]&quot;&lt;/span&gt;, GraphLayout.&lt;span&gt;parseInstance&lt;/span&gt;(pojo).totalSize());&lt;/pre&gt;&lt;p&gt;å…¶ä¸­pojoæ˜¯è‡ªå·±è¦ç›‘æ§çš„å¯¹è±¡ï¼Œæœ‰ç©ºä¸å¦¨è¯•ä¸€è¯•ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ä¸è¦å‡å®šï¼Œè¦è¯æ˜ï¼-----ã€Šç¨‹åºå‘˜ä¿®ç‚¼ä¹‹é“ã€‹&lt;/p&gt;
                &lt;/div&gt;

                

                



                
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>fd8c0844bee20cecab258bb572eb5ca0</guid>
<title>æŠ€æœ¯å¹²è´§ï½œç¼“å­˜ä¸€è‡´æ€§æœ€ä½³å®è·µ</title>
<link>https://toutiao.io/k/zgmi04u</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4382826&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTbbFu7n3GktsBgczeVd0RHngWc5I6Wvf01FzUtDwQibTQEpYeZSM64W8Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;559&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;èƒŒæ™¯Â &lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;æ¦‚è¿°&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;æœ€è¿‘å›¢é˜Ÿé‡Œæˆ‘ä»¬åœ¨å¯†é›†çš„è®¨è®ºRedisç¼“å­˜ä¸€è‡´æ€§ç›¸å…³çš„é—®é¢˜ï¼Œç”µå•†æ ¸å¿ƒçš„åŸŸå¦‚å•†å“ã€è¥é”€ã€åº“å­˜ã€è®¢å•ç­‰å®é™…ä¸Šåœ¨ç¼“å­˜çš„é€‰æ‹©ä¸Šå„æœ‰ç‰¹è‰²ï¼Œé‚£ä¹ˆåœ¨è¿™äº›å·®å¼‚çš„ä¸šåŠ¡èƒŒåï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä¸€äº›æœ€ä½³å®è·µå¯ä¾›å‚è€ƒå‘¢ï¼Ÿ&lt;/p&gt;&lt;p&gt;æœ¬æ–‡å°è¯•ç€æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç»™å‡ºä¸€äº›å»ºè®®ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;åœ¨è®¨è®ºä¹‹å‰ï¼Œæœ‰ä¸¤ä¸ªé‡ç‚¹æˆ‘ä»¬éœ€è¦è¾¾æˆä¸€è‡´ï¼š&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;åˆ†å¸ƒå¼åœºæ™¯ä¸‹æ— æ³•åšåˆ°å¼ºä¸€è‡´&lt;/span&gt;&lt;/strong&gt;&lt;span&gt;ï¼š&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;ä¸åŒäºCPUç¡¬ä»¶ç¼“å­˜ä½“ç³»é‡‡ç”¨çš„MESIåè®®ä»¥åŠç¡¬ä»¶çš„å¼ºæ—¶é’Ÿæ§åˆ¶ï¼Œåˆ†å¸ƒå¼åœºæ™¯ä¸‹æˆ‘ä»¬æ— æ³•åšåˆ°ç¼“å­˜ä¸åº•å±‚æ•°æ®åº“çš„å¼ºä¸€è‡´ï¼Œå³æŠŠç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®å˜æ›´åšæˆä¸€ä¸ªåŸå­æ“ä½œã€‚&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;ç¡¬ä»¶å·¥ç¨‹å¸ˆè®¾è®¡äº†å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰çš„æ¦‚å¿µï¼Œæä¾›ç»™è½¯ä»¶å¼€å‘è€…ä¸åŒçš„ä¸€è‡´æ€§é€‰é¡¹åœ¨æ€§èƒ½ä¸ä¸€è‡´æ€§ä¸Šè¿›è¡Œæƒè¡¡ã€‚&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;å°±ç®—æ˜¯è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ä¹Ÿå¾ˆéš¾&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œè¦åšåˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼Œå°±è¦æ±‚ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ï¼ˆæˆ–è€…ç¼“å­˜ä¸ºç©ºï¼‰ï¼Œè€Œä¸”æ˜¯åœ¨æ•°æ®åº“æ›´æ–°åå¾ˆè¿…é€Ÿçš„å°±è¦è¾¾åˆ°è¿™ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ï¼Œè¦åšåˆ°æ˜¯æå…¶å›°éš¾çš„ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬ä¼šé¢ä¸´ç¡¬ä»¶ã€è½¯ä»¶ã€é€šä¿¡ç­‰ç­‰ç»„ä»¶éå¸¸å¤šçš„å¼‚å¸¸æƒ…å†µã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5409836&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTbvSxeCUz3xV2YIUErVqjzgbHHKuhWXsU0JyWT3jfkpKJPI1Z14xiatxA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;976&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;CPUçš„ç¼“å­˜ç»“æ„&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;ç¼“å­˜çš„ä¸€è‡´æ€§é—®é¢˜&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;ä¸€èˆ¬åŒ–æ¥è¯´ï¼Œæˆ‘ä»¬é¢ä¸´çš„æ˜¯è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°æ®åº“çš„æ•°æ®ä¼šæœ‰5æ¬¡æ›´æ–°ï¼Œäº§ç”Ÿ6ä¸ªç‰ˆæœ¬ï¼ŒV1~V6ï¼Œå›¾ä¸­æ¯ä¸ªæ–¹æ¡†çš„é•¿åº¦ä»£è¡¨è¿™ä¸ªç‰ˆæœ¬æŒç»­çš„æ—¶é—´ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬æœŸæœ›ï¼Œåœ¨æ•°æ®åº“ä¸­çš„æ•°æ®å˜åŒ–åï¼Œç¼“å­˜å±‚éœ€è¦å°½å¿«çš„æ„ŸçŸ¥åˆ°å¹¶ä½œå‡ºååº”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¼“å­˜å±‚æ–¹æ¡†ä¸­çš„é—´éš”ä»£è¡¨è¿™ä¸ªæ—¶é—´æ®µç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼ŒV2ã€V3ä»¥åŠV5ç‰ˆæœ¬åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨å¹¶ä¸ä¼šç ´åæˆ‘ä»¬çš„æœ€ç»ˆä¸€è‡´æ€§è¦æ±‚ï¼Œåªè¦æ•°æ®åº“çš„æœ€ç»ˆç‰ˆæœ¬å’Œç¼“å­˜çš„æœ€ç»ˆç‰ˆæœ¬æ˜¯ç›¸åŒçš„å°±å¯ä»¥äº†ã€‚&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.2796296&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTbpcFMVGBvhuLoH4m6rYIj8yhttcP7lbiaonk7s2MgEjNyQmj9zOCXE1w/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;ç¼“å­˜æ˜¯å¦‚ä½•å†™å…¥çš„&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;ç¼“å­˜å†™å…¥çš„ä»£ç é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯å’Œç¼“å­˜ä½¿ç”¨çš„ä»£ç æ”¾åœ¨ä¸€èµ·çš„ï¼ŒåŒ…å«4ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šW1è¯»å–ç¼“å­˜ï¼ŒW2åˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼ŒW3ç»„è£…ç¼“å­˜æ•°æ®ï¼ˆè¿™é€šå¸¸éœ€è¦å‘æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ï¼‰ï¼ŒW4å†™å…¥ç¼“å­˜ã€‚&lt;/p&gt;&lt;p&gt;æ¯ä¸€ä¸ªæ­¥éª¤é—´å¯èƒ½ä¼šåœé¡¿å¤šä¹…æ˜¯æ²¡æœ‰åŠæ³•æ§åˆ¶çš„ï¼Œå°¤å…¶æ˜¯W3ã€W4ä¹‹é—´çš„åœé¡¿æœ€ä¸ºè¦å‘½ï¼Œå®ƒå¾ˆå¯èƒ½è®©æˆ‘ä»¬å°†æ—§ç‰ˆæœ¬çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;br/&gt;æˆ‘ä»¬å¯èƒ½ä¼šæƒ³ï¼ŒW4æ­¥çš„å†™å…¥ï¼Œå¸¦ä¸ŠW2çš„å‡è®¾ï¼Œå³ä½¿ç”¨WriteIfNotExistsè¯­ä¹‰ï¼Œä¼šä¸ä¼šæœ‰æ‰€æ”¹å–„ï¼Ÿ&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3916667&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTb20FjhyT48qhUfho2h4bwblJcIsFVibcSh0dgWLCqB0hicJ8EDgk8VUyw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;è€ƒè™‘å¦‚ä¸‹çš„æƒ…å½¢ï¼Œå‡è®¾æœ‰3ä¸ªç¼“å­˜å†™å…¥çš„å¹¶å‘æ‰§è¡Œï¼Œç”±äºçŸ­æ—¶é—´æ•°æ®åº“å¤§é‡çš„æ›´æ–°ï¼Œå®ƒä»¬åˆ†åˆ«ç»„è£…çš„æ˜¯V1ã€V2ã€V3ç‰ˆæœ¬çš„æ•°æ®ã€‚&lt;/p&gt;&lt;p&gt;ä½¿ç”¨WriteIfNotExistsè¯­ä¹‰ï¼Œå…¶ä¸­å¿…ç„¶æœ‰2ä¸ªæ‰§è¡Œä¼šå¤±è´¥ï¼Œå“ªä¸€ä¸ªä¼šæˆåŠŸæ ¹æœ¬æ— æ³•ä¿è¯ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬æ— æ³•ç®€å•çš„åšå†³ç­–ï¼Œéœ€è¦å†æ¬¡å°†ç¼“å­˜è¯»å–å‡ºæ¥ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æˆ‘ä»¬å³å°†å†™å…¥çš„ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·é‚£å°±å¾ˆç®€å•ï¼›å¦‚æœä¸ä¸€æ ·çš„è¯ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§é€‰æ‹©ï¼š&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;å°†ç¼“å­˜åˆ é™¤ï¼Œè®©åç»­åˆ«çš„è¯·æ±‚æ¥å¤„ç†å†™å…¥ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;ä½¿ç”¨ç¼“å­˜æä¾›çš„åŸå­æ“ä½œï¼Œä»…åœ¨æˆ‘ä»¬çš„æ•°æ®æ˜¯è¾ƒæ–°ç‰ˆæœ¬æ—¶å†™å…¥ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.27833&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTbxFk3v9PuJ3VBXYmdBKGOcvrMXAyRjrqiaXlId1X7Q849lA9Gbon5dpg/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1006&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;å¦‚ä½•æ„ŸçŸ¥æ•°æ®åº“çš„å˜åŒ–&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;æ•°æ®åº“çš„æ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬å¦‚ä½•æ„ŸçŸ¥åˆ°å¹¶è¿›è¡Œæœ‰æ•ˆçš„ç¼“å­˜ç®¡ç†å‘¢ï¼Ÿ&lt;/p&gt;&lt;p&gt;é€šå¸¸æƒ…å†µä¸‹æœ‰å¦‚ä¸‹çš„3ç§åšæ³•ï¼š&lt;/p&gt;&lt;ul class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ä»£ç æ‰§è¡Œæµ&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;é€šå¸¸æˆ‘ä»¬ä¼šåœ¨æ•°æ®åº“æ“ä½œå®Œæˆåï¼Œæ‰§è¡Œä¸€äº›ç¼“å­˜æ“ä½œçš„ä»£ç ã€‚&lt;/p&gt;&lt;p&gt;è¿™ç§æ–¹å¼æœ€å¤§çš„é—®é¢˜æ˜¯å¯é æ€§ä¸é«˜ï¼Œåº”ç”¨é‡å¯ã€æœºå™¨æ„å¤–å½“æœºç­‰æƒ…å†µéƒ½ä¼šå¯¼è‡´åç»­çš„ä»£ç æ— æ³•æ‰§è¡Œã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;ä½œä¸ºä½¿ç”¨ä»£ç æ‰§è¡Œæµçš„æ”¹è¿›ï¼Œåœ¨æ•°æ®åº“æ“ä½œå®Œæˆåå‘å‡ºäº‹åŠ¡æ¶ˆæ¯ï¼Œç„¶ååœ¨æ¶ˆæ¯çš„æ¶ˆè´¹é€»è¾‘é‡Œæ‰§è¡Œç¼“å­˜çš„ç®¡ç†æ“ä½œã€‚&lt;/p&gt;&lt;p&gt;å¯é æ€§çš„é—®é¢˜å°±è§£å†³äº†ï¼Œåªæ˜¯ä¸šåŠ¡ä¾§è¦ä¸ºæ­¤å¢åŠ äº‹åŠ¡æ¶ˆæ¯çš„é€»è¾‘ï¼Œä»¥åŠè¿è¡Œæˆæœ¬ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;ä½¿ç”¨æ•°æ®å˜æ›´æ—¥å¿—&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;æ•°æ®åº“äº§å“é€šå¸¸éƒ½æ”¯æŒåœ¨æ•°æ®å˜æ›´åäº§ç”Ÿå˜æ›´æ—¥å¿—ï¼Œæ¯”å¦‚MySQLçš„binlogã€‚&lt;/p&gt;&lt;p&gt;å¯ä»¥è®©ä¸­é—´ä»¶å›¢é˜Ÿå†™ä¸€æ¬¾äº§å“ï¼Œåœ¨æ¥æ”¶åˆ°å˜æ›´åæ‰§è¡Œç¼“å­˜çš„ç®¡ç†æ“ä½œï¼Œæ¯”å¦‚é˜¿é‡Œçš„ç²¾å«ã€‚&lt;/p&gt;&lt;p&gt;å¯é æ€§æœ‰ä¿è¯ï¼ŒåŒæ—¶è¿˜å¯ä»¥è¿›è¡ŒæŸä¸ªæ—¶é—´æ®µå˜æ›´æ—¥å¿—çš„å›æ”¾ï¼ŒåŠŸèƒ½å°±æ¯”è¾ƒå¼ºå¤§äº†ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;æœ€ä½³å®è·µä¸€ï¼šæ•°æ®åº“å˜æ›´åå¤±æ•ˆç¼“å­˜&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;è¿™æ˜¯æœ€å¸¸ç”¨å’Œç®€å•çš„æ–¹å¼ï¼Œåº”è¯¥è¢«ä½œä¸ºé¦–é€‰çš„æ–¹æ¡ˆï¼Œæ•´ä½“çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5731481&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTbuFnDYpEbhQKFJQVPGlOAZaJibTSPEQ0ag8mIn1J78yhhBfdYOlLhBibA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;W4æ­¥ä½¿ç”¨æœ€åŸºæœ¬çš„putè¯­ä¹‰ï¼Œè¿™é‡Œçš„å‡è®¾æ˜¯å†™å…¥è¾ƒæ™šçš„è¯·æ±‚å¾€å¾€ä¹Ÿæ˜¯æºå¸¦çš„æœ€æ–°çš„æ•°æ®ï¼Œè¿™åœ¨å¤§å¤šçš„æƒ…å½¢ä¸‹éƒ½æ˜¯æˆç«‹çš„ã€‚&lt;/p&gt;&lt;p&gt;D1æ­¥ä½¿ç”¨ç›‘å¬DB binlogçš„æ–¹å¼æ¥åˆ é™¤ç¼“å­˜ï¼Œå³å‰è¿°ä½¿ç”¨æ•°æ®å˜æ›´æ—¥å¿—ä¸­ä»‹ç»çš„æ–¹æ³•ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯&lt;/strong&gt;ï¼šåœ¨æ•°æ®åº“æ•°æ®å­˜åœ¨é«˜å¹¶å‘æ›´æ–°ä¸”ç¼“å­˜è¯»å–æµé‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰å°æ¦‚ç‡å­˜åœ¨ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æ—§ç‰ˆæœ¬æ•°æ®çš„æƒ…å†µã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;é€šå¸¸çš„è§£æ³•æœ‰å››ç§ï¼š&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;é™åˆ¶ç¼“å­˜æœ‰æ•ˆæ—¶é—´&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;è®¾å®šç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚15åˆ†é’Ÿã€‚å³è¡¨ç¤ºæˆ‘ä»¬æœ€å¤šæ¥å—ç¼“å­˜åœ¨15åˆ†é’Ÿçš„æ—¶é—´èŒƒå›´å†…æ˜¯æ—§çš„ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;å°æ¦‚ç‡ç¼“å­˜é‡åŠ è½½&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;æ ¹æ®æµé‡æ¯”è®¾å®šä¸€å®šæ¯”ä¾‹çš„ç¼“å­˜é‡åŠ è½½ï¼Œä»¥ä¿è¯å¤§æµé‡æƒ…å†µä¸‹çš„ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ã€‚&lt;/p&gt;&lt;p&gt;æ¯”å¦‚1%çš„æ¯”ä¾‹ï¼Œè¿™åŒæ—¶è¿˜å¯ä»¥å¸®åŠ©æ•°æ®åº“å¾—åˆ°å……åˆ†çš„é¢„çƒ­ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;ç»“åˆä¸šåŠ¡ç‰¹ç‚¹&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;æ ¹æ®ä¸šåŠ¡çš„ç‰¹ç‚¹åšä¸€äº›è®¾è®¡ï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;&lt;/li&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;é’ˆå¯¹è¥é”€çš„åœºæ™¯&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;åœ¨å•†å“è¯¦æƒ…é¡µ/ç¡®è®¤è®¢å•é¡µçš„ä¼˜æƒ è®¡ç®—æ—¶ä½¿ç”¨ç¼“å­˜ï¼Œè€Œåœ¨ä¸‹å•æ—¶ä¸ä½¿ç”¨ç¼“å­˜ã€‚&lt;/p&gt;&lt;p&gt;è¿™å¯ä»¥è®©æç«¯æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¸äº§ç”Ÿè¿‡å¤§çš„ä¸šåŠ¡æŸå¤±ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;é’ˆå¯¹åº“å­˜çš„åœºæ™¯&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;è¯»å–åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®åªæ˜¯ä¼šåœ¨å•†å“å·²å”®ç½„çš„æƒ…å†µä¸‹è®©å¤šä½™çš„æµé‡è¿›å…¥åˆ°ä¸‹å•è€Œå·²ï¼Œä¸‹å•æ—¶çš„åº“å­˜æ‰£å‡æ˜¯æ“ä½œæ•°æ®åº“çš„ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä¸šåŠ¡ä¸Šçš„æŸå¤±ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;ä¸¤æ¬¡åˆ é™¤&lt;/strong&gt;ï¼š&lt;/p&gt;&lt;p&gt;D1æ­¥åˆ é™¤ç¼“å­˜çš„æ“ä½œæ‰§è¡Œä¸¤æ¬¡ï¼Œä¸”ä¸­é—´æœ‰ä¸€å®šçš„é—´éš”ï¼Œæ¯”å¦‚30ç§’ã€‚&lt;/p&gt;&lt;p&gt;è¿™ä¸¤æ¬¡åŠ¨ä½œçš„è§¦å‘éƒ½æ˜¯ç”±â€œç¼“å­˜ç®¡ç†ç»„ä»¶â€å‘èµ·çš„ï¼Œæ‰€ä»¥å¯ä»¥ç”±å®ƒæ”¯æŒã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;æœ€ä½³å®è·µäºŒï¼šå¸¦ç‰ˆæœ¬å†™å…¥&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;é’ˆå¯¹è±¡å•†å“ä¿¡æ¯ç¼“å­˜è¿™ç§æ›´æ–°é¢‘ç‡ä½ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜ä¸”ç¼“å­˜è¯»å–æµé‡å¾ˆé«˜çš„åœºæ™¯ï¼Œé€šå¸¸ä¼šé‡‡ç”¨å¸¦ç‰ˆæœ¬æ›´æ–°çš„æ–¹å¼ï¼Œæ•´ä½“çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹å›¾å¦‚ç¤ºï¼š&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6055556&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/AAQtmjCc74ACnsfKcnFDT8Uf8XcCHKTblN4aNHDMTub6GiboN4tIj5MlIj1sSpEiamGf0A9Pu2VBmPRF9fjxcayA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1080&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;å’Œâ€œæ•°æ®åº“å˜æ›´åå¤±æ•ˆç¼“å­˜â€æ–¹æ¡ˆæœ€å¤§çš„å·®å¼‚åœ¨W4æ­¥å’ŒD1æ­¥ï¼Œéœ€è¦ç¼“å­˜å±‚æä¾›å¸¦ç‰ˆæœ¬å†™å…¥çš„APIï¼Œå³ä»…å½“å†™å…¥æ•°æ®ç‰ˆæœ¬è¾ƒæ–°æ—¶å¯ä»¥å†™å…¥æˆåŠŸï¼Œå¦åˆ™å†™å…¥å¤±è´¥ã€‚&lt;/p&gt;&lt;p&gt;è¿™åŒæ—¶ä¹Ÿè¦æ±‚æˆ‘ä»¬åœ¨æ•°æ®åº“å¢åŠ æ•°æ®ç‰ˆæœ¬çš„ä¿¡æ¯ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;è¿™ä¸ªæ–¹æ¡ˆçš„æœ€ç»ˆä¸€è‡´æ€§æ•ˆæœæ¯”è¾ƒå¥½ï¼Œä»…åœ¨æç«¯æƒ…å†µä¸‹ï¼ˆæ–°ç‰ˆæœ¬å†™å…¥åæ•°æ®ä¸¢å¤±äº†ï¼Œåç»­æ—§ç‰ˆæœ¬çš„å†™å…¥å°±ä¼šæˆåŠŸï¼‰å­˜åœ¨ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æ—§ç‰ˆæœ¬æ•°æ®çš„å¯èƒ½ã€‚&lt;/p&gt;&lt;p&gt;åœ¨D1æ­¥ä½¿ç”¨å†™å…¥è€Œä¸æ˜¯ä½¿ç”¨åˆ é™¤å¯ä»¥æå¤§ç¨‹åº¦çš„é¿å…è¿™ä¸ªæç«¯æƒ…å†µçš„å‡ºç°ï¼ŒåŒæ—¶ç”±äºè¯¥æ–¹æ¡ˆé€‚ç”¨äºç¼“å­˜è¯»å–æµé‡å¾ˆé«˜çš„åœºæ™¯ï¼Œè¿˜å¯ä»¥é¿å…ç¼“å­˜è¢«åˆ é™¤åW3æ­¥çŸ­æ—¶é—´å¤§é‡è¯·æ±‚ç©¿é€åˆ°DBã€‚&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;strong&gt;æ€»ç»“ä¸å±•æœ›&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;å¯¹äºç¼“å­˜ä¸æ•°æ®åº“åˆ†ç¦»çš„åœºæ™¯ï¼Œåœ¨ç»“åˆäº†ä¸šç•Œå¤šå®¶å…¬å¸çš„å®è·µç»éªŒä»¥åŠROIæƒè¡¡ä¹‹åï¼Œå‰è¿°çš„ä¸¤ä¸ªæœ€ä½³å®è·µæ˜¯è¢«åº”ç”¨çš„æœ€ä¸ºå¹¿æ³›çš„ï¼Œå°¤å…¶æ˜¯æœ€ä½³å®è·µä¸€ï¼Œåº”è¯¥ä½œä¸ºæˆ‘ä»¬æ—¥å¸¸åº”ç”¨çš„é¦–é€‰ã€‚&lt;/p&gt;&lt;p&gt;åŒæ—¶ï¼Œä¸ºäº†æœ€å¤§é™åº¦çš„é¿å…æ¯ä¸ªæœ€ä½³å®è·µèƒŒåå¯èƒ½å‘ç”Ÿçš„ä¸ä¸€è‡´æ€§é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ‡åˆä¸šåŠ¡çš„ç‰¹ç‚¹ï¼Œåœ¨å…³é”®çš„åœºæ™¯ä¸Šåšä¸€äº›ä¿éšœä¸€è‡´æ€§çš„è®¾è®¡ï¼ˆæ¯”å¦‚å‰è¿°çš„è¥é”€åœ¨ä¸‹å•æ—¶ä½¿ç”¨æ•°æ®åº“è¯»è€Œä¸æ˜¯ç¼“å­˜è¯»ï¼‰ï¼Œè¿™ä¹Ÿæ˜¾å¾—å°¤ä¸ºé‡è¦ï¼ˆæ¯•ç«Ÿå¦‚â€œèƒŒæ™¯â€ä¸­æ‰€è¿°ï¼Œå¹¶ä¸å­˜åœ¨å®Œç¾çš„æŠ€æœ¯æ–¹æ¡ˆï¼‰ã€‚&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;é™¤äº†ç¼“å­˜ä¸æ•°æ®åº“åˆ†ç¦»çš„æ–¹æ¡ˆï¼Œè¿˜æœ‰ä¸¤ä¸ªä¸šç•Œå·²ç»åº”ç”¨çš„æ–¹æ¡ˆä¹Ÿå€¼å¾—æˆ‘ä»¬å€Ÿé‰´ï¼š&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;é˜¿é‡ŒXKV&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;ç®€å•æ¥è®²å°±æ˜¯åœ¨æ•°æ®åº“ä¸Šéƒ¨ç½²ä¸€ä¸ªMemcacheçš„Serverï¼Œå®ƒç›´æ¥ç»•è¿‡æ•°æ®åº“å±‚ç›´æ¥è®¿é—®å­˜å‚¨å¼•æ“å±‚ï¼ˆå¦‚ï¼šInnoDBï¼‰ï¼ŒåŒæ—¶ä½¿ç”¨KV clientæ¥è¿›è¡Œæ•°æ®çš„è®¿é—®ã€‚&lt;/p&gt;&lt;p&gt;å®ƒçš„ç‰¹ç‚¹æ˜¯æ•°æ®å®é™…ä¸Šä¸æ•°æ®åº“æ˜¯å¼ºä¸€è‡´çš„ï¼Œæ€§èƒ½å¯ä»¥æ¯”ä½¿ç”¨SQLè®¿é—®æ•°æ®åº“æå‡5ï½10å€ã€‚&lt;/p&gt;&lt;p&gt;ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåªèƒ½é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€é”®æ¥è®¿é—®æ•°æ®ï¼ˆè¿™åªæ˜¯ç›¸å¯¹SQLæ¥è¯´çš„ï¼Œå¤§å¤šæ•°ç¼“å­˜æœ¬æ¥ä¹Ÿå°±æ˜¯KVè®¿é—®åè®®ï¼‰ã€‚&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;&lt;strong&gt;è…¾è®¯DCache&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;svg viewbox=&quot;0 0 1 1&quot;/&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;section powered-by=&quot;xiumi.us&quot;&gt;&lt;p&gt;ä¸ç”¨è‡ªè¡Œç»´æŠ¤ç¼“å­˜ä¸æ•°æ®åº“ä¸¤å¥—å­˜å‚¨ï¼Œç»™å¼€å‘äººå‘˜ç»Ÿä¸€çš„ä¸€å¥—æ•°æ®è§†å›¾ï¼Œç”±DCacheåœ¨ç¼“å­˜æ›´æ–°åè‡ªè¡ŒæŒä¹…åŒ–æ•°æ®ã€‚&lt;/p&gt;&lt;p&gt;ç¼ºç‚¹æ˜¯æ”¯æŒçš„æ•°æ®ç»“æ„æœ‰é™ï¼ˆ key-valueï¼Œk-k-rowï¼Œlistï¼Œsetï¼Œzset ï¼‰ï¼Œæœªæ¥ä¹Ÿå¾ˆéš¾æ”¯æŒå½¢å¦‚æ•°æ®åº“è¡¨ä¸€æ ·å¤æ‚çš„æ•°æ®ç»“æ„ã€‚&lt;span/&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;
                &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>e31cf957d8b89d5f30073ca19e705e5e</guid>
<title>é¢è¯•å®˜é—®: è¯´ä¸€è¯´ReentrantReadWriteLockçš„å®ç°åŸç†ä¸é”è·å–è¿‡ç¨‹</title>
<link>https://toutiao.io/k/001uotl</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;preview&quot;&gt;&lt;h2&gt;ä¸€.é¢è¯•é¢˜åˆ†æ&lt;/h2&gt;

&lt;p&gt;åœ¨æœ‰äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¤§å¤šåœ¨è¯»å–æ•°æ®ï¼Œå¾ˆå°‘å†™å…¥æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä»ä½¿ç”¨ç‹¬å é”ï¼Œæ•ˆç‡å°†åŠå…¶ä½ä¸‹ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒJavaæä¾›äº†è¯»å†™é”â€”â€”ReentrantReadWriteLockæœ‰ç‚¹ç±»ä¼¼MySQLæ•°æ®åº“ä¸ºä»£è¡¨çš„è¯»å†™åˆ†ç¦»æœºåˆ¶ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†è¯»å†™é”æ˜¯ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚é‚£é—®é¢˜æ¥äº†ï¼ŒReentrantReadWriteLockæ˜¯æ€æ ·æ¥å®ç°çš„å‘¢ï¼Œå®ƒä¸ReentrantLockçš„å®ç°åˆæœ‰ä»€ä¹ˆçš„åŒºåˆ«å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h2&gt;äºŒ.ReentrantReadWriteLockç®€ä»‹&lt;/h2&gt;

&lt;p&gt;å¾ˆå¤šæƒ…å†µä¸‹æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼šå¯¹å…±äº«èµ„æºæœ‰è¯»å’Œå†™çš„æ“ä½œï¼Œä¸”å†™æ“ä½œæ²¡æœ‰è¯»æ“ä½œé‚£ä¹ˆé¢‘ç¹ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æ²¡æœ‰å†™æ“ä½œçš„æ—¶å€™ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥åº”è¯¥å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å…±äº«èµ„æºï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™è¿™äº›å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å…è®¸å…¶ä»–çº¿ç¨‹å¯¹è¯¥èµ„æºè¿›è¡Œè¯»å’Œå†™çš„æ“ä½œäº†ã€‚&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹è¿™ç§åœºæ™¯ï¼ŒJAVAçš„å¹¶å‘åŒ…æä¾›äº†è¯»å†™é”ReentrantReadWriteLockï¼Œå®ƒè¡¨ç¤ºä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯è¯»æ“ä½œç›¸å…³çš„é”ï¼Œç§°ä¸ºå…±äº«é”ï¼›ä¸€ä¸ªæ˜¯å†™ç›¸å…³çš„é”ï¼Œç§°ä¸ºæ’ä»–é”ã€‚&lt;/p&gt;

&lt;h2&gt;ä¸‰.ReentrantReadWriteLockç‰¹æ€§&lt;/h2&gt;

&lt;p&gt;å…¬å¹³æ€§ï¼šè¯»å†™é”æ”¯æŒéå…¬å¹³å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œéå…¬å¹³é”çš„ååé‡ä¼˜äºå…¬å¹³é”çš„ååé‡ï¼Œé»˜è®¤æ„é€ çš„æ˜¯éå…¬å¹³é”&lt;/p&gt;

&lt;p&gt;å¯é‡å…¥ï¼šåœ¨çº¿ç¨‹è·å–è¯»é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯»é”ï¼Œä½†æ˜¯ä¸èƒ½è·å–å†™é”ï¼Œè€Œçº¿ç¨‹åœ¨è·å–å†™é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–å†™é”ï¼ŒåŒæ—¶ä¹Ÿèƒ½è·å–è¯»é”&lt;/p&gt;

&lt;p&gt;é”é™çº§ï¼šçº¿ç¨‹è·å–å†™é”ä¹‹åè·å–è¯»é”ï¼Œå†é‡Šæ”¾å†™é”ï¼Œè¿™æ ·å®ç°äº†å†™é”å˜ä¸ºè¯»é”ï¼Œä¹Ÿå«é”é™çº§&lt;/p&gt;

&lt;h2&gt;å››.ReentrantReadWriteLockçš„ä¸»è¦æˆå‘˜å’Œç»“æ„å›¾&lt;/h2&gt;

&lt;h3&gt;1. ReentrantReadWriteLockçš„ç»§æ‰¿å…³ç³»&lt;/h3&gt;

&lt;p&gt;è¯»å†™é” ReadWriteLock&lt;/p&gt;

&lt;p&gt;è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹ç›¸å…³çš„é”ï¼Œä¸€ä¸ªç”¨äºåªè¯»æ“ä½œï¼Œä¸€ä¸ªç”¨äºå†™å…¥æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;åªè¦æ²¡æœ‰å†™å…¥ï¼Œè¯»å–é”å¯ä»¥ç”±å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶ä¿æŒ,å†™å…¥é”æ˜¯ç‹¬å çš„ã€‚&lt;/p&gt;

&lt;h3&gt;2.ReentrantReadWriteLockçš„æ ¸å¿ƒå˜é‡&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;https://storage.bytearch.com/images/reentranrwl/1.jpeg&quot; alt=&quot;file&quot;/&gt;&lt;/p&gt;

&lt;pre lang=&quot;java&quot;&gt;&lt;code&gt;public interface ReadWriteLock {
   /**
   * Returns the lock used for reading.
   *
   * @return the lock used for reading.
   */
   Lock readLock();
   /**
   * Returns the lock used for writing.
   *
   * @return the lock used for writing.
   */
   Lock writeLock();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;ReentrantReadWriteLockç±»åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå˜é‡ï¼š&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ReaderLockï¼šè¯»é”,å®ç°äº†Lockæ¥å£&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;WriterLockï¼šå†™é”,ä¹Ÿå®ç°äº†Lockæ¥å£&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Syncï¼šç»§æ‰¿è‡ªAbstractQueuedSynchronize(AQS),å¯ä»¥ä¸ºå…¬å¹³é”FairSync æˆ– éå…¬å¹³é”NonfairSync&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3&gt;3.ReentrantReadWriteLockçš„æˆå‘˜å˜é‡å’Œæ„é€ å‡½æ•°&lt;/h3&gt;

&lt;pre lang=&quot;java&quot;&gt;&lt;code&gt; /**
     * å†…éƒ¨æä¾›çš„è¯»é”
     */
    private final ReentrantReadWriteLock.ReadLock readerLock;
    /**
     * å†…éƒ¨æä¾›çš„å†™é”
     */
    private final ReentrantReadWriteLock.WriteLock writerLock;
    /**
     * AQSæ¥å®ç°çš„åŒæ­¥å™¨
     */
    final Sync sync;

    /*** Creates a new {@code ReentrantReadWriteLock} with * é»˜è®¤åˆ›å»ºéå…¬å¹³çš„è¯»å†™é” */
    public ReentrantReadWriteLock() {
        this(false);
    }

    /*** Creates a new {@code ReentrantReadWriteLock} with * the given fairness policy. ** @param fair {@code true} if this lock should use a fair ordering policy */
    public ReentrantReadWriteLock(boolean fair) {
        sync = fair ? new FairSync() : new NonfairSync();
        readerLock = new ReadLock(this);
        writerLock = new WriteLock(this);
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;äº”.ReentrantReadWriteLockçš„æ ¸å¿ƒå®ç°&lt;/h2&gt;

&lt;h3&gt;ReentrantReadWriteLockå®ç°å…³é”®ç‚¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š&lt;/h3&gt;

&lt;p&gt;è¯»å†™çŠ¶æ€çš„è®¾è®¡&lt;/p&gt;

&lt;p&gt;å†™é”çš„è·å–ä¸é‡Šæ”¾&lt;/p&gt;

&lt;p&gt;è¯»é”çš„è·å–ä¸é‡Šæ”¾&lt;/p&gt;

&lt;p&gt;é”é™çº§&lt;/p&gt;

&lt;h3&gt;1.è¯»å†™çŠ¶æ€çš„è®¾è®¡&lt;/h3&gt;

&lt;p&gt;ä¹‹å‰è°ˆReentrantLockçš„æ—¶å€™,Syncç±»æ˜¯ç»§æ‰¿äºAQSï¼Œä¸»è¦ä»¥int stateä¸ºçº¿ç¨‹é”çŠ¶æ€,0è¡¨ç¤ºæ²¡æœ‰è¢«çº¿ç¨‹å ç”¨ï¼Œ 1 è¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹å ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;åŒæ ·ReentrantReadWriteLockä¹Ÿæ˜¯ç»§æ‰¿äºAQSæ¥å®ç°åŒæ­¥ï¼Œé‚£int stateæ€æ ·åŒæ—¶æ¥åŒºåˆ†è¯»é”å’Œå†™é”çš„ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å¦‚æœåœ¨ä¸€ä¸ªæ•´å‹å˜é‡ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€ï¼Œå°±ä¸€å®šéœ€è¦â€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€è¿™ä¸ªå˜é‡ï¼Œ&lt;/p&gt;

&lt;h3&gt;ReentrantReadWriteLockå°†intç±»å‹çš„stateå°†å˜é‡åˆ‡å‰²æˆä¸¤éƒ¨åˆ†ï¼š&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;https://storage.bytearch.com/images/reentranrwl/2.png&quot; alt=&quot;file&quot;/&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;é«˜ 16 ä½è®°å½•è¯»é”çŠ¶æ€&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ä½ 16 ä½è®°å½•å†™é”çŠ¶æ€&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre lang=&quot;java&quot;&gt;&lt;code&gt;abstract static class Sync extends AbstractQueuedSynchronizer {
                // ç‰ˆæœ¬åºåˆ—å·
         private static final long serialVersionUID = 6317671515068378041L;
                // é«˜ 16 ä½ä¸ºè¯»é”ï¼Œä½ 16 ä½ä¸ºå†™é”
                static final int SHARED_SHIFT = 16 ;
                // è¯»é”å•ä½
                static final int SHARED_UNIT = ( 1 &amp;lt;&amp;lt; SHARED_SHIFT);
                // è¯»é”æœ€å¤§æ•°é‡
                static final int MAX_COUNT = ( 1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1 ;
                // å†™é”æœ€å¤§æ•°é‡
                static final int EXCLUSIVE_MASK = ( 1 &amp;lt;&amp;lt; SHARED_SHIFT) - 1 ;
                // æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨
                private transient ThreadLocalHoldCounter readHolds;
                // ç¼“å­˜çš„è®¡æ•°å™¨
                private transient HoldCounter cachedHoldCounter;
        // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ 
        private transient Thread firstReader = null; 
        // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹çš„è®¡æ•° 
        private transient int firstReaderHoldCount;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;2.å†™é”çš„è·å–ä¸é‡Šæ”¾&lt;/h3&gt;

&lt;pre lang=&quot;java&quot;&gt;&lt;code&gt; protected final boolean tryAcquire(int acquires) {
            /*
             * Walkthrough:
             * 1. If read count nonzero or write count nonzero
             *    and owner is a different thread, fail.
             * 2. If count would saturate, fail. (This can only
             *    happen if count is already nonzero.)
             * 3. Otherwise, this thread is eligible for lock if
             *    it is either a reentrant acquire or
             *    queue policy allows it. If so, update state
             *    and set owner.
             */
            Thread current = Thread.currentThread();
            int c = getState();
           //è·å–ç‹¬å é”(å†™é”)çš„è¢«è·å–çš„æ•°é‡
            int w = exclusiveCount(c);
            if (c != 0) {
                // (Note: if c != 0 and w == 0 then shared count != 0)
              //1.å¦‚æœåŒæ­¥çŠ¶æ€ä¸ä¸º0ï¼Œä¸”å†™çŠ¶æ€ä¸º0,åˆ™è¡¨ç¤ºå½“å‰åŒæ­¥çŠ¶æ€è¢«è¯»é”è·å–
              //2.æˆ–è€…å½“å‰æ‹¥æœ‰å†™é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹
                if (w == 0 || current != getExclusiveOwnerThread())
                    return false;
                if (w + exclusiveCount(acquires) &amp;gt; MAX_COUNT)
                    throw new Error(&quot;Maximum lock count exceeded&quot;);
                // Reentrant acquire
                setState(c + acquires);
                return true;
            }
            if (writerShouldBlock() ||
                !compareAndSetState(c, c + acquires))
                return false;
            setExclusiveOwnerThread(current);
            return true;
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1)cæ˜¯è·å–å½“å‰é”çŠ¶æ€,wæ˜¯è·å–å†™é”çš„çŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;2)å¦‚æœé”çŠ¶æ€ä¸ä¸ºé›¶ï¼Œè€Œå†™é”çš„çŠ¶æ€ä¸º 0 ï¼Œåˆ™è¡¨ç¤ºè¯»é”çŠ¶æ€ä¸ä¸º 0 ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹ä¸èƒ½è·å–å†™é”ã€‚æˆ–è€…&lt;/p&gt;

&lt;p&gt;é”çŠ¶æ€ä¸ä¸ºé›¶ï¼Œè€Œå†™é”çš„çŠ¶æ€ä¹Ÿä¸ä¸º 0 ï¼Œä½†æ˜¯è·å–å†™é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¸èƒ½è·å–å†™é”ã€‚&lt;/p&gt;

&lt;p&gt;3)å†™é”æ˜¯ä¸€ä¸ªå¯é‡å…¥çš„æ’å®ƒé”ï¼Œåœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¢åŠ äº†ä¸€ä¸ªè¯»é”æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ã€‚&lt;/p&gt;

&lt;p&gt;å†™é”çš„é‡Šæ”¾ä¸ReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å°†å†™çŠ¶æ€å‡ 1 ï¼Œç›´åˆ°å†™çŠ¶æ€ä¸º 0 æ—¶ï¼Œæ‰è¡¨ç¤ºè¯¥å†™é”è¢«é‡Šæ”¾äº†ã€‚&lt;/p&gt;

&lt;h3&gt;3.è¯»é”çš„è·å–ä¸é‡Šæ”¾&lt;/h3&gt;

&lt;pre lang=&quot;java&quot;&gt;&lt;code&gt;
    protected final int tryAcquireShared(int unused) {
        for (; ; ) {
            int c = getState();
            int nextc = c + (1 &amp;lt;&amp;lt; 16);
            if (nextc &amp;lt; c) {
                throw new Error(&quot;Maxumum lock count exceeded&quot;);
            }
            if (exclusiveCount(c) != 0 &amp;amp;&amp;amp; owner != Thread.currentThread()) return -1;
            if (compareAndSetState(c, nextc)) return 1;
        }
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1)è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ã€‚&lt;/p&gt;

&lt;p&gt;2)åœ¨æ²¡æœ‰å†™çŠ¶æ€ä¸º 0 æ—¶ï¼Œè¯»é”æ€»ä¼šè¢«æˆåŠŸè·å–ï¼Œè€Œæ‰€åšçš„ä¹Ÿåªæ˜¯å¢åŠ è¯»çŠ¶æ€ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
3)è¯»çŠ¶æ€æ˜¯æ‰€æœ‰çº¿ç¨‹è·å–è¯»é”æ¬¡æ•°çš„æ€»å’Œï¼Œè€Œæ¯ä¸ªçº¿ç¨‹å„è‡ªè·å–è¯»é”çš„æ¬¡æ•°åªèƒ½é€‰æ‹©ä¿å­˜åœ¨ThreadLocalä¸­ï¼Œç”±çº¿ç¨‹è‡ªèº«ç»´æŠ¤ã€‚è¯»é”çš„æ¯æ¬¡é‡Šæ”¾å‡å‡å°çŠ¶æ€ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶é‡Šæ”¾é”ï¼‰ï¼Œå‡å°çš„å€¼æ˜¯1&amp;lt;&amp;lt; 16 .&lt;/p&gt;

&lt;h3&gt;4. é”é™çº§&lt;/h3&gt;

&lt;p&gt;é™çº§æ˜¯æŒ‡å½“å‰æŠŠæŒä½å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾(å…ˆå‰æ‹¥æœ‰çš„)å†™é”çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;é”é™çº§è¿‡ç¨‹ä¸­çš„è¯»é”çš„è·å–æ˜¯å¦æœ‰å¿…è¦ï¼Œç­”æ¡ˆæ˜¯å¿…è¦çš„ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸è·å–è¯»é”è€Œç›´æ¥é‡Šæ”¾å†™é”ï¼Œå‡è®¾æ­¤åˆ»å¦ä¸€ä¸ªçº¿ç¨‹è·å–çš„å†™é”ï¼Œå¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±æ­¥ä¼æ„ŸçŸ¥åˆ°çº¿ç¨‹Tçš„æ•°æ®æ›´æ–°ï¼Œå¦‚æœå½“å‰çº¿ç¨‹éµå¾ªé”é™çº§çš„æ­¥éª¤ï¼Œé‚£ä¹ˆçº¿ç¨‹Tå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹ä½¿æ•°æ®å¹¶é‡Šæ”¾è¯»é”ä¹‹åï¼Œçº¿ç¨‹Tæ‰èƒ½è·å–å†™é”è¿›è¡Œæ•°æ®æ›´æ–°ã€‚&lt;/p&gt;

&lt;h3&gt;5.è¯»é”ä¸å†™é”çš„æ•´ä½“æµç¨‹&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;https://storage.bytearch.com/images/reentranrwl/3.png&quot; alt=&quot;file&quot;/&gt;&lt;/p&gt;

&lt;h2&gt;å…­.ReentrantReadWriteLockæ€»ç»“&lt;/h2&gt;

&lt;p&gt;æœ¬ç¯‡è¯¦ç»†ä»‹ç»äº†ReentrantReadWriteLockçš„ç‰¹å¾ã€å®ç°ã€é”çš„è·å–è¿‡ç¨‹ï¼Œé€šè¿‡ 4 ä¸ªå…³é”®ç‚¹çš„æ ¸å¿ƒè®¾è®¡ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;è¯»å†™çŠ¶æ€çš„è®¾è®¡&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å†™é”çš„è·å–ä¸é‡Šæ”¾&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;è¯»é”çš„è·å–ä¸é‡Šæ”¾&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;é”é™çº§&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»è€Œæ‰èƒ½å®ç°ï¼šå…±äº«èµ„æºæœ‰è¯»å’Œå†™çš„æ“ä½œï¼Œä¸”å†™æ“ä½œæ²¡æœ‰è¯»æ“ä½œé‚£ä¹ˆé¢‘ç¹çš„åº”ç”¨åœºæ™¯ã€‚&lt;/p&gt;

&lt;h2&gt;å·å¤–å·å¤–&lt;/h2&gt;

&lt;p&gt;ç»™å¤§å®¶æ•´ç†äº†Javaæœ€æ–°å¤§å‚é¢è¯•é¢˜åŠç­”æ¡ˆï¼Œå¹¶ä¸”æ•´ç†æˆäº†PDFæ ¼å¼æ–¹ä¾¿é˜…è¯»ã€‚ æ¬¢è¿å¤§å®¶å…³æ³¨â€æµ…è°ˆæ¶æ„â€œ å…¬ä¼—å· (åå°ç§ä¿¡â€é¢è¯•â€œå³å¯è·å–)ã€‚å¦å¤–éœ€è¦å¤§å‚å†…æ¨åŒå­¦ä¹Ÿå¯ä»¥ç§ä¿¡æˆ‘ã€‚ &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://storage.bytearch.com/images/mianshiti.png&quot; alt=&quot;file&quot;/&gt;&lt;/p&gt;
&lt;/div&gt;
  &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>6727b3603d72053c4b0aa881a60de4d9</guid>
<title>å·¥å•†é“¶è¡Œå®æ—¶å¤§æ•°æ®å¹³å°å»ºè®¾å†ç¨‹åŠå±•æœ›</title>
<link>https://toutiao.io/k/mf1lxng</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;weui-dialog&quot;&gt;
      &lt;p class=&quot;weui-dialog__hd&quot;&gt;&lt;strong class=&quot;weui-dialog__title&quot;&gt;&quot;Top Stories&quot; is disabled&lt;/strong&gt;&lt;/p&gt;
      &lt;p class=&quot;weui-dialog__bd&quot;&gt;
        Enable &quot;Top Stories&quot; in &quot;Settings&quot; &amp;gt; &quot;General&quot; &amp;gt; &quot;Manage Discover&quot;      &lt;/p&gt;
      
    &lt;/div&gt;
  &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>a2fd199ac1f04a0a4690a877dcea66c5</guid>
<title>ç›˜ç‚¹Linux Epollé‚£äº›è‡´å‘½å¼±ç‚¹</title>
<link>https://toutiao.io/k/pslbv0b</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section&gt;&lt;blockquote&gt;&lt;p&gt;å¾®ä¿¡å…¬ä¼—å·ï¼š&lt;strong&gt;å°æ¢ç¼–ç¨‹æ±‡&lt;/strong&gt;&lt;br/&gt;&lt;strong&gt;ç‚¹å‡»ğŸ‘†ğŸ»ï¼Œå…³æ³¨ä½œè€…&lt;/strong&gt;å¯äº†è§£æ›´å¤šæŠ€æœ¯å¹²è´§ï¼›&lt;br/&gt;å› æœªå¼€é€šç•™è¨€ï¼Œé—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ç§ä¿¡ç•™è¨€ï¼›&lt;/p&gt;&lt;/blockquote&gt;&lt;h3&gt;&lt;span&gt;å†…å®¹ç›®å½•&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;1. å¼•è¨€&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;2. è„‰ç»œ&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;3 epoll å¤šçº¿ç¨‹æ‰©å±•æ€§&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;3.1ç‰¹å®šTCP listen fdçš„accept(2) çš„é—®é¢˜&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.1.1 æ°´å¹³è§¦å‘çš„é—®é¢˜ï¼šä¸å¿…è¦çš„å”¤é†’&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.1.2 è¾¹ç¼˜è§¦å‘çš„é—®é¢˜ï¼šä¸å¿…è¦çš„å”¤é†’ä»¥åŠé¥¥é¥¿&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.1.3 æ€æ ·æ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼Ÿ&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.1.4 å…¶ä»–æ–¹æ¡ˆ&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;3.2 å¤§é‡TCPè¿æ¥çš„read(2)çš„é—®é¢˜&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.2.1 æ°´å¹³è§¦å‘çš„é—®é¢˜ï¼šæ•°æ®ä¹±åº&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.2.2 è¾¹ç¼˜è§¦å‘çš„é—®é¢˜ï¼šæ•°æ®ä¹±åº&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;3.2.3 æ€æ ·æ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼Ÿ&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;3.3 epoll load balance æ€»ç»“&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;4. epollä¹‹file descriptorä¸file description&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;4.1 æ€»ç»“&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;5 å¼•ç”¨&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3&gt;&lt;span&gt;1Â å¼•è¨€&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;æœ¬æ–‡æ¥è‡ª Marekâ€™s åšå®¢ä¸­ I/O multiplexing part ç³»åˆ—ä¹‹ä¸‰å’Œå››ï¼ŒåŸæ–‡ä¸€å…±æœ‰å››ç¯‡ï¼Œä¸»è¦è®² Linux ä¸Š IO å¤šè·¯å¤ç”¨çš„ä¸€äº›é—®é¢˜ï¼Œæœ¬æ–‡åŠ å…¥äº†æˆ‘çš„ä¸€äº›ä¸ªäººç†è§£ï¼Œå¦‚æœ‰ä¸å¯¹ä¹‹å¤„æ•¬è¯·æŒ‡å‡ºã€‚åŸæ–‡é“¾æ¥å¦‚ä¸‹ï¼š&lt;span/&gt;&lt;/p&gt;&lt;section&gt;TheÂ historyÂ ofÂ theÂ Select(2)Â syscallÂ &lt;span&gt;[1]&lt;/span&gt;&lt;/section&gt;&lt;section&gt;Select(2)Â isÂ fundamentallyÂ brokenÂ &lt;span&gt;[2]&lt;/span&gt;&lt;/section&gt;&lt;section&gt;EpollÂ isÂ fundamentallyÂ brokenÂ 1/2Â &lt;span&gt;[3]&lt;/span&gt;&lt;/section&gt;&lt;section&gt;EpollÂ isÂ fundamentallyÂ brokenÂ 2/2Â &lt;span&gt;[4]&lt;/span&gt;&lt;/section&gt;&lt;h3&gt;&lt;span&gt;2Â è„‰ç»œ&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;ç³»åˆ—ä¸‰å’Œç³»åˆ—å››åˆ†åˆ«è®² epoll(2) å­˜åœ¨çš„ä¸¤ä¸ªä¸åŒçš„é—®é¢˜ï¼š&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;ç³»åˆ—ä¸‰ä¸»è¦è®² epoll çš„å¤šçº¿ç¨‹æ‰©å±•æ€§çš„é—®é¢˜&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;ç³»åˆ—å››ä¸»è¦è®² epoll æ‰€æ³¨å†Œçš„ fd (file descriptor) å’Œå®é™…å†…æ ¸ä¸­æ§åˆ¶çš„ç»“æ„ file description æ‹¥æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸ&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;æˆ‘ä»¬åœ¨æ­¤ä¹ŸæŒ‰ç…§è¯¥é¡ºåºè¿›è¡Œé˜è¿°ã€‚&lt;/p&gt;&lt;h3&gt;&lt;span&gt;3 epoll å¤šçº¿ç¨‹æ‰©å±•æ€§&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;epoll çš„å¤šçº¿ç¨‹æ‰©å±•æ€§çš„é—®é¢˜ä¸»è¦ä½“ç°åœ¨åšå¤šæ ¸ä¹‹é—´è´Ÿè½½å‡è¡¡ä¸Šï¼Œæœ‰ä¸¤ä¸ªå…¸å‹çš„åœºæ™¯ï¼š&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;ä¸€ä¸ª TCP æœåŠ¡å™¨ï¼Œå¯¹åŒä¸€ä¸ª listen fd åœ¨å¤šä¸ª CPU ä¸Šè°ƒç”¨ &lt;code&gt;accept(2)&lt;/code&gt; ç³»ç»Ÿè°ƒç”¨&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;å¤§é‡ TCP è¿æ¥è°ƒç”¨ &lt;code&gt;read(2)&lt;/code&gt; ç³»ç»Ÿè°ƒç”¨ä¸Š&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h3&gt;&lt;span&gt;3.1 ç‰¹å®š TCP listen fd çš„ accept(2) çš„é—®é¢˜&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯ä¸€ä¸ªéœ€è¦å¤„ç†å¤§é‡çŸ­è¿æ¥çš„ HTTP 1.0 æœåŠ¡å™¨ï¼Œç”±äºéœ€è¦ accept() å¤§é‡çš„ TCP å»ºè¿è¯·æ±‚ï¼Œæ‰€ä»¥å¸Œæœ›æŠŠè¿™äº› accept() åˆ†å‘åˆ°ä¸åŒçš„ CPU ä¸Šæ¥å¤„ç†ï¼Œä»¥å……åˆ†åˆ©ç”¨å¤š CPU çš„èƒ½åŠ›ã€‚&lt;/p&gt;&lt;p&gt;è¿™åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒæ˜¯å­˜åœ¨çš„ï¼Œ Tom Herbert æŠ¥å‘Šæœ‰åº”ç”¨éœ€è¦å¤„ç†æ¯ç§’ 4 ä¸‡ä¸ªå»ºè¿è¯·æ±‚ï¼›å½“æœ‰è¿™ä¹ˆå¤šè¯·æ±‚çš„æ—¶å€™ï¼Œå¾ˆæ˜¾ç„¶ï¼Œå°†å…¶åˆ†æ•£åˆ°ä¸åŒçš„ CPU ä¸Šæ˜¯åˆç†çš„ã€‚&lt;/p&gt;&lt;p&gt;ç„¶åå®é™…ä¸Šï¼Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œç›´åˆ° Linux 4.5 å†…æ ¸ï¼Œéƒ½æ— æ³•é€šè¿‡ epoll(2) æŠŠè¿™äº›è¯·æ±‚æ°´å¹³æ‰©å±•åˆ°å…¶ä»– CPU ä¸Šã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ epoll çš„ä¸¤ç§æ¨¡å¼ LT(level trigger, æ°´å¹³è§¦å‘) å’Œ ET(edge trigger, è¾¹ç¼˜è§¦å‘) åœ¨å¤„ç†è¿™ç§æƒ…å†µä¸‹çš„é—®é¢˜ã€‚&lt;/p&gt;&lt;h4&gt;&lt;span&gt;3.1.1 æ°´å¹³è§¦å‘çš„é—®é¢˜ï¼šä¸å¿…è¦çš„å”¤é†’&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;ä¸€ä¸ªæ„šè ¢çš„åšæ³•æ˜¯æ˜¯å°†åŒä¸€ä¸ª epoll fd æ”¾åˆ°ä¸åŒçš„çº¿ç¨‹ä¸Šæ¥ epoll_wait()ï¼Œè¿™æ ·åšæ˜¾ç„¶è¡Œä¸é€šï¼ŒåŒæ ·ï¼Œå°†åŒä¸€ä¸ªç”¨äº accept çš„ fd åŠ åˆ°ä¸åŒçš„çº¿ç¨‹ä¸­çš„ epoll fd ä¸­ä¹Ÿè¡Œä¸é€šã€‚&lt;/p&gt;&lt;p&gt;è¿™æ˜¯å› ä¸º epoll çš„æ°´å¹³è§¦å‘æ¨¡å¼å’Œ &lt;code&gt;select(2)&lt;/code&gt; ä¸€æ ·å­˜åœ¨ â€œæƒŠç¾¤æ•ˆåº”â€ï¼Œåœ¨ä¸åŠ ç‰¹æ®Šæ ‡å¿—çš„æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œå½“ä¸€ä¸ªæ–°å»ºè¿æ¥è¯·æ±‚è¿‡æ¥æ—¶ï¼Œæ‰€æœ‰çš„ worker çº¿ç¨‹éƒ½éƒ½ä¼šè¢«å”¤é†’ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªè¿™ç§ case çš„ä¾‹å­ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;1. å†…æ ¸ï¼šæ”¶åˆ°ä¸€ä¸ªæ–°å»ºè¿æ¥çš„è¯·æ±‚&lt;br/&gt;&lt;span&gt;2&lt;/span&gt;2. å†…æ ¸ï¼šç”±äºÂ &quot;æƒŠç¾¤æ•ˆåº”&quot;Â ï¼Œå”¤é†’ä¸¤ä¸ªæ­£åœ¨ epoll_wait()Â çš„çº¿ç¨‹ A å’Œçº¿ç¨‹ B&lt;br/&gt;&lt;span&gt;3&lt;/span&gt;3. çº¿ç¨‹Aï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt;4&lt;/span&gt;4. çº¿ç¨‹Bï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt;5&lt;/span&gt;5. çº¿ç¨‹Aï¼šæ‰§è¡Œ accept()Â å¹¶ä¸”æˆåŠŸ&lt;br/&gt;&lt;span&gt;6&lt;/span&gt;6. çº¿ç¨‹Bï¼šæ‰§è¡Œ accept()Â å¤±è´¥ï¼Œaccept()Â è¿”å› EAGAIN&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å…¶ä¸­ï¼Œçº¿ç¨‹ B çš„å”¤é†’å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œä»…ä»…åªæ˜¯æµªè´¹å®è´µçš„ CPU èµ„æºè€Œå·²ï¼Œæ°´å¹³è§¦å‘æ¨¡å¼çš„ epoll çš„æ‰©å±•æ€§å¾ˆå·®ã€‚&lt;/p&gt;&lt;h4&gt;&lt;span&gt;3.1.2 è¾¹ç¼˜è§¦å‘çš„é—®é¢˜ï¼šä¸å¿…è¦çš„å”¤é†’ä»¥åŠé¥¥é¥¿&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;æ—¢ç„¶æ°´å¹³è§¦å‘æ¨¡å¼ä¸è¡Œï¼Œé‚£æ˜¯ä¸æ˜¯è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¼šæ›´å¥½å‘¢ï¼Ÿå®é™…ä¸Šå¹¶æ²¡æœ‰ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;1. å†…æ ¸ï¼šæ”¶åˆ°ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚ã€‚çº¿ç¨‹ A å’ŒÂ çº¿ç¨‹ B ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ epoll_wait()Â ä¸Šç­‰å¾…ã€‚ç”±äºé‡‡ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæ”¶åˆ°é€šçŸ¥ã€‚è¿™é‡Œå‡å®šçº¿ç¨‹ A æ”¶åˆ°é€šçŸ¥&lt;br/&gt;&lt;span&gt;2&lt;/span&gt;2. çº¿ç¨‹Aï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt;3&lt;/span&gt;3. çº¿ç¨‹Aï¼šè°ƒç”¨ accpet()Â å¹¶ä¸”æˆåŠŸ&lt;br/&gt;&lt;span&gt;4&lt;/span&gt;4. å†…æ ¸ï¼šæ­¤æ—¶ accept queue ä¸ºç©ºï¼Œæ‰€ä»¥å°†è¾¹ç¼˜è§¦å‘çš„ socket çš„çŠ¶æ€ä»å¯è¯»ç½®æˆä¸å¯è¯»&lt;br/&gt;&lt;span&gt;5&lt;/span&gt;5. å†…æ ¸ï¼šæ”¶åˆ°ç¬¬äºŒä¸ªå»ºè¿è¯·æ±‚&lt;br/&gt;&lt;span&gt;6&lt;/span&gt;6. å†…æ ¸ï¼šæ­¤æ—¶ï¼Œç”±äºçº¿ç¨‹ A è¿˜åœ¨æ‰§è¡Œ accept()Â å¤„ç†ï¼Œåªå‰©ä¸‹çº¿ç¨‹ B åœ¨ç­‰å¾… epoll_wait()ï¼Œäºæ˜¯å”¤é†’çº¿ç¨‹ B&lt;br/&gt;&lt;span&gt;7&lt;/span&gt;7. çº¿ç¨‹Aï¼šç»§ç»­æ‰§è¡Œ accept()Â ç›´åˆ°è¿”å› EAGAIN&lt;br/&gt;&lt;span&gt;8&lt;/span&gt;8. çº¿ç¨‹Bï¼šæ‰§è¡Œ accept()ï¼Œå¹¶è¿”å› EAGAINï¼Œæ­¤æ—¶çº¿ç¨‹ B å¯èƒ½æœ‰ç‚¹å›°æƒ‘(&quot;æ˜æ˜é€šçŸ¥æˆ‘æœ‰äº‹ä»¶ï¼Œç»“æœå´è¿”å› EAGAIN&quot;)&lt;br/&gt;&lt;span&gt;9&lt;/span&gt;9. çº¿ç¨‹Aï¼šå†æ¬¡æ‰§è¡Œ accept()ï¼Œè¿™æ¬¡ç»ˆäºè¿”å› EAGAIN&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œçº¿ç¨‹ B çš„å”¤é†’æ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦çš„ã€‚å¦å¤–ï¼Œäº‹å®ä¸Šè¾¹ç¼˜è§¦å‘æ¨¡å¼è¿˜å­˜åœ¨é¥¥é¥¿çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;1. å†…æ ¸ï¼šæ¥æ”¶åˆ°ä¸¤ä¸ªå»ºè¿è¯·æ±‚ã€‚çº¿ç¨‹ A å’ŒÂ çº¿ç¨‹ B ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰åœ¨ epoll_wait()ã€‚ç”±äºé‡‡ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œæˆ‘ä»¬è¿™é‡Œå‡å®šçº¿ç¨‹ A å…ˆè¢«å”¤é†’&lt;br/&gt;&lt;span&gt;2&lt;/span&gt;2. çº¿ç¨‹Aï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt;3&lt;/span&gt;3. çº¿ç¨‹Aï¼šè°ƒç”¨ accpet()Â å¹¶ä¸”æˆåŠŸ&lt;br/&gt;&lt;span&gt;4&lt;/span&gt;4. å†…æ ¸ï¼šæ”¶åˆ°ç¬¬ä¸‰ä¸ªå»ºè¿è¯·æ±‚ã€‚ç”±äºçº¿ç¨‹ A è¿˜æ²¡æœ‰å¤„ç†å®Œ(æ²¡æœ‰è¿”å› EAGAIN)ï¼Œå½“å‰ socket è¿˜å¤„äºå¯è¯»çš„çŠ¶æ€ï¼Œç”±äºæ˜¯è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œæ‰€æœ‰ä¸ä¼šäº§ç”Ÿæ–°çš„äº‹ä»¶&lt;br/&gt;&lt;span&gt;5&lt;/span&gt;5. çº¿ç¨‹Aï¼šç»§ç»­æ‰§è¡Œ accept()Â å¸Œæœ›è¿”å› EAGAIN å†è¿›å…¥ epoll_wait()Â ç­‰å¾…ï¼Œç„¶è€Œå®ƒåˆ accept()Â æˆåŠŸå¹¶å¤„ç†äº†ä¸€ä¸ªæ–°è¿æ¥&lt;br/&gt;&lt;span&gt;6&lt;/span&gt;6. å†…æ ¸ï¼šåˆæ”¶åˆ°äº†ç¬¬å››ä¸ªå»ºè¿è¯·æ±‚&lt;br/&gt;&lt;span&gt;7&lt;/span&gt;7. çº¿ç¨‹Aï¼šåˆç»§ç»­æ‰§è¡Œ accept()ï¼Œç»“æœåˆè¿”å›æˆåŠŸ&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;åœ¨è¿™ä¸ªä¾‹å­ä¸­ä¸ªï¼Œè¿™ä¸ª socket åªæœ‰ä¸€æ¬¡ä»ä¸å¯è¯»çŠ¶æ€å˜æˆå¯è¯»çŠ¶æ€ï¼Œç”±äº socket å¤„äºè¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œå†…æ ¸åªä¼šå”¤é†’ epoll_wait() ä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ä¸ªï¼Œæ‰€æœ‰çš„å»ºè¿è¯·æ±‚å…¨éƒ½ä¼šç»™çº¿ç¨‹ Aï¼Œå¯¼è‡´è¿™ä¸ªè´Ÿè½½å‡è¡¡æ ¹æœ¬æ²¡æœ‰ç”Ÿæ•ˆï¼Œçº¿ç¨‹ A å¾ˆå¿™è€Œçº¿ç¨‹ B æ²¡æœ‰æ´»å¹²ã€‚&lt;/p&gt;&lt;h4&gt;&lt;span&gt;3.1.3 æ€æ ·æ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼Ÿ&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;æ—¢ç„¶æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘éƒ½ä¸è¡Œï¼Œé‚£æ€æ ·æ‰æ˜¯æ­£ç¡®çš„åšæ³•å‘¢ï¼Ÿæœ‰ä¸¤ç§ workaround çš„æ–¹å¼:&lt;/p&gt;&lt;ol class=&quot;list-paddingleft-2&quot;&gt;&lt;li&gt;&lt;p&gt;æœ€å¥½çš„ä¹Ÿæ˜¯å”¯ä¸€æ”¯æŒå¯æ‰©å±•çš„æ–¹å¼æ˜¯ä½¿ç”¨ä» Linux 4.5+ å¼€å§‹å‡ºç°çš„æ°´å¹³è§¦å‘æ¨¡å¼æ–°å¢çš„ &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; æ ‡å¿—ï¼Œè¿™ä¸ªæ ‡å¿—ä¼šä¿è¯ä¸€ä¸ªäº‹ä»¶åªæœ‰ä¸€ä¸ª epoll_wait() ä¼šè¢«å”¤é†’ï¼Œé¿å…äº† â€œæƒŠç¾¤æ•ˆåº”â€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å¤šä¸ª CPU ä¹‹é—´å¾ˆå¥½çš„æ°´å¹³æ‰©å±•ã€‚&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;å½“å†…æ ¸ä¸æ”¯æŒ&lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; æ—¶ï¼Œå¯ä»¥é€šè¿‡ ET æ¨¡å¼ä¸‹çš„ &lt;code&gt;EPOLLONESHOT&lt;/code&gt; æ¥æ¨¡æ‹Ÿ LT + &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; çš„æ•ˆæœï¼Œå½“ç„¶è¿™æ ·æ˜¯æœ‰ä»£ä»·çš„ï¼Œéœ€è¦åœ¨æ¯ä¸ªäº‹ä»¶å¤„ç†å®Œä¹‹åé¢å¤–å¤šè°ƒç”¨ä¸€æ¬¡ epoll_ctl(EPOLL_CTL_MOD) é‡ç½®è¿™ä¸ª fdã€‚è¿™æ ·åšå¯ä»¥å°†è´Ÿè½½å‡åˆ†åˆ°ä¸åŒçš„ CPU ä¸Šï¼Œä½†æ˜¯åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ª worker è°ƒç”¨ accept(2)ã€‚æ˜¾ç„¶ï¼Œè¿™æ ·åˆé™åˆ¶äº†å¤„ç† accept(2) çš„ååã€‚ä¸‹é¢æ˜¯è¿™æ ·åšçš„ä¾‹å­ï¼š&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;å†…æ ¸ï¼šæ¥æ”¶åˆ°ä¸¤ä¸ªå»ºè¿è¯·æ±‚ã€‚çº¿ç¨‹ A å’Œ çº¿ç¨‹ B ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰åœ¨ epoll_wait()ã€‚ç”±äºé‡‡ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œæˆ‘ä»¬è¿™é‡Œå‡å®šçº¿ç¨‹ A å…ˆè¢«å”¤é†’&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;çº¿ç¨‹Aï¼šepoll_wait() è¿”å›&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;çº¿ç¨‹Aï¼šè°ƒç”¨ accpet() å¹¶ä¸”æˆåŠŸ&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;çº¿ç¨‹Aï¼šè°ƒç”¨ epoll_ctl(EPOLL_CTL_MOD)ï¼Œè¿™æ ·ä¼šé‡ç½® EPOLLONESHOT çŠ¶æ€å¹¶å°†è¿™ä¸ª socket fd é‡æ–°å‡†å¤‡å¥½ â€œ&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h4&gt;&lt;span&gt;3.1.4 å…¶ä»–æ–¹æ¡ˆ&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;å½“ç„¶ï¼Œå¦‚æœä¸ä¾èµ–äº epoll() çš„è¯ï¼Œä¹Ÿè¿˜æœ‰å…¶ä»–æ–¹æ¡ˆã€‚ä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ &lt;code&gt;SO_REUSEPORT&lt;/code&gt; è¿™ä¸ª socket optionï¼Œåˆ›å»ºå¤šä¸ª listen socket å…±ç”¨ä¸€ä¸ªç«¯å£å·ï¼Œä¸è¿‡è¿™ç§æ–¹æ¡ˆå…¶å®ä¹Ÿå­˜åœ¨é—®é¢˜: å½“ä¸€ä¸ª listen socket fd è¢«å…³äº†ï¼Œå·²ç»è¢«åˆ†åˆ°è¿™ä¸ª listen socket fd çš„ accept é˜Ÿåˆ—ä¸Šçš„è¯·æ±‚ä¼šè¢«ä¸¢æ‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ https://engineeringblog.yelp.com/2015/04/true-zero-downtime-haproxy-reloads.html å’Œ LWN ä¸Šçš„ comment&lt;span&gt;[5]&lt;/span&gt;&lt;/p&gt;&lt;p&gt;ä» Linux 4.5 å¼€å§‹å¼•å…¥äº† &lt;code&gt;SO_ATTACH_REUSEPORT_CBPF&lt;/code&gt; å’Œ &lt;code&gt;SO_ATTACH_REUSEPORT_EBPF&lt;/code&gt; è¿™ä¸¤ä¸ª BPF ç›¸å…³çš„ socket optionã€‚é€šè¿‡å·§å¦™çš„è®¾è®¡ï¼Œåº”è¯¥å¯ä»¥é¿å…æ‰å»ºè¿è¯·æ±‚è¢«ä¸¢æ‰çš„æƒ…å†µã€‚&lt;/p&gt;&lt;h3&gt;&lt;span&gt;3.2 å¤§é‡ TCP è¿æ¥çš„ read(2) çš„é—®é¢˜&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;é™¤äº† 3.1 ä¸­è¯´çš„ accept(2) çš„é—®é¢˜ä¹‹å¤–ï¼Œ æ™®é€šçš„ read(2) åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šä¹Ÿä¼šæœ‰æ‰©å±•æ€§çš„é—®é¢˜ã€‚è®¾æƒ³ä»¥ä¸‹åœºæ™¯ï¼šä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œéœ€è¦è·Ÿå¤§é‡çš„ HTTP client é€šä¿¡ï¼Œä½ å¸Œæœ›å°½å¿«çš„å¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚è€Œæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„è¯·æ±‚çš„å¤„ç†æ—¶é—´å¯èƒ½å¹¶ä¸ä¸€æ ·ï¼Œæœ‰äº›å¿«æœ‰äº›æ…¢ï¼Œå¹¶ä¸”ä¸å¯é¢„æµ‹ï¼Œå› æ­¤ç®€å•çš„å°†è¿™äº›è¿æ¥åˆ‡åˆ†åˆ°ä¸åŒçš„ CPU ä¸Šï¼Œå¯èƒ½å¯¼è‡´å¹³å‡å“åº”æ—¶é—´å˜é•¿ã€‚ä¸€ç§æ›´å¥½çš„æ’é˜Ÿç­–ç•¥å¯èƒ½æ˜¯ï¼šç”¨ä¸€ä¸ª epoll fd æ¥ç®¡ç†è¿™äº›è¿æ¥å¹¶è®¾ç½® &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt;ï¼Œç„¶åå¤šä¸ª worker çº¿ç¨‹æ¥ epoll_wait()ï¼Œå–å‡ºå°±ç»ªçš„è¿æ¥å¹¶å¤„ç†[æ³¨1]ã€‚æ²¹ç®¡ä¸Šæœ‰ä¸ªè§†é¢‘ä»‹ç»è¿™ç§ç§°ä¹‹ä¸º â€œcombined queueâ€ çš„æ¨¡å‹ã€‚&lt;/p&gt;&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ epoll å¤„ç†è¿™ç§æ¨¡å‹ä¸‹çš„é—®é¢˜ï¼š&lt;/p&gt;&lt;h4&gt;&lt;span&gt;3.2.1 æ°´å¹³è§¦å‘çš„é—®é¢˜ï¼šæ•°æ®ä¹±åº&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;å®é™…ä¸Šï¼Œç”±äºæ°´å¹³è§¦å‘å­˜åœ¨çš„ â€œæƒŠç¾¤æ•ˆåº”â€ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³ç”¨è¯¥æ¨¡å‹ã€‚å¦å¤–ï¼Œå³ä½¿åŠ ä¸Š &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; æ ‡å¿—ï¼Œä»ç„¶å­˜åœ¨æ•°æ®ç«äº‰çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;1. å†…æ ¸ï¼šæ”¶åˆ° 2047 å­—èŠ‚çš„æ•°æ®&lt;br/&gt;&lt;span&gt;2&lt;/span&gt;2. å†…æ ¸ï¼šçº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ epoll_wait()ï¼Œç”±äºè®¾ç½®äº† EPOLLEXCLUSIVEï¼Œå†…æ ¸åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡è®¾è¿™é‡Œå…ˆå”¤é†’çº¿ç¨‹ A&lt;br/&gt;&lt;span&gt;3&lt;/span&gt;3. çº¿ç¨‹Aï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt;4&lt;/span&gt;4. å†…æ ¸ï¼šå†…æ ¸åˆæ”¶åˆ° 2 ä¸ªå­—èŠ‚çš„æ•°æ®&lt;br/&gt;&lt;span&gt;5&lt;/span&gt;5. å†…æ ¸ï¼šçº¿ç¨‹ A è¿˜åœ¨å¹²æ´»ï¼Œå½“å‰åªæœ‰çº¿ç¨‹ B åœ¨ epoll_wait()ï¼Œå†…æ ¸å”¤é†’çº¿ç¨‹ B&lt;br/&gt;&lt;span&gt;6&lt;/span&gt;6. çº¿ç¨‹Aï¼šè°ƒç”¨ read(2048)Â å¹¶è¯»èµ° 2048 å­—èŠ‚æ•°æ®&lt;br/&gt;&lt;span&gt;7&lt;/span&gt;7. çº¿ç¨‹Bï¼šè°ƒç”¨ read(2048)Â å¹¶è¯»èµ°å‰©ä¸‹çš„ 1 å­—èŠ‚æ•°æ®&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿™ä¸Šè¿°åœºæ™¯ä¸­ï¼Œæ•°æ®ä¼šè¢«åˆ†ç‰‡åˆ°ä¸¤ä¸ªä¸åŒçš„çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰é”ä¿æŠ¤çš„è¯ï¼Œæ•°æ®å¯èƒ½ä¼šå­˜åœ¨ä¹±åºã€‚&lt;/p&gt;&lt;h4&gt;&lt;span&gt;3.2.2 è¾¹ç¼˜è§¦å‘çš„é—®é¢˜ï¼šæ•°æ®ä¹±åº&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;æ—¢ç„¶æ°´å¹³è§¦å‘æ¨¡å‹ä¸è¡Œï¼Œé‚£ä¹ˆè¾¹ç¼˜è§¦å‘å‘¢ï¼Ÿå®é™…ä¸Šä¹Ÿå­˜åœ¨ç›¸åŒçš„ç«äº‰ï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt; 1&lt;/span&gt;1. å†…æ ¸ï¼šæ”¶åˆ° 2048 å­—èŠ‚çš„æ•°æ®&lt;br/&gt;&lt;span&gt; 2&lt;/span&gt;2. å†…æ ¸ï¼šçº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ epoll_wait()ï¼Œç”±äºè®¾ç½®äº† EPOLLEXCLUSIVEï¼Œå†…æ ¸åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡è®¾è¿™é‡Œå…ˆå”¤é†’çº¿ç¨‹ A&lt;br/&gt;&lt;span&gt; 3&lt;/span&gt;3. çº¿ç¨‹Aï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt; 4&lt;/span&gt;4. çº¿ç¨‹Aï¼šè°ƒç”¨ read(2048)Â å¹¶è¿”å› 2048 å­—èŠ‚æ•°æ®&lt;br/&gt;&lt;span&gt; 5&lt;/span&gt;5. å†…æ ¸ï¼šç¼“å†²åŒºæ•°æ®å…¨éƒ¨å·²ç»è¯»å®Œï¼Œåˆé‡æ–°å°†è¯¥ fd æŒ‚åˆ° epoll é˜Ÿåˆ—ä¸Š&lt;br/&gt;&lt;span&gt; 6&lt;/span&gt;6. å†…æ ¸ï¼šæ”¶åˆ° 1 å­—èŠ‚çš„æ•°æ®&lt;br/&gt;&lt;span&gt; 7&lt;/span&gt;7. å†…æ ¸ï¼šçº¿ç¨‹ A è¿˜åœ¨å¹²æ´»ï¼Œå½“å‰åªæœ‰çº¿ç¨‹ B åœ¨ epoll_wait()ï¼Œå†…æ ¸å”¤é†’çº¿ç¨‹ B&lt;br/&gt;&lt;span&gt; 8&lt;/span&gt;8. çº¿ç¨‹Bï¼šepoll_wait()Â è¿”å›&lt;br/&gt;&lt;span&gt; 9&lt;/span&gt;9. çº¿ç¨‹Bï¼šè°ƒç”¨ read(2048)Â å¹¶ä¸”åªè¯»åˆ°äº† 1 å­—èŠ‚æ•°æ®&lt;br/&gt;&lt;span&gt;10&lt;/span&gt;10. çº¿ç¨‹Aï¼šå†æ¬¡è°ƒç”¨ read(2048)ï¼Œæ­¤æ—¶ç”±äºå†…æ ¸ç¼“å†²åŒºå·²ç»æ²¡æœ‰æ•°æ®ï¼Œè¿”å› EAGAIN&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4&gt;&lt;span&gt;3.2.3 æ€æ ·æ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼Ÿ&lt;/span&gt;&lt;/h4&gt;&lt;p&gt;å®é™…ä¸Šï¼Œè¦ä¿è¯åŒä¸€ä¸ªè¿æ¥çš„æ•°æ®å§‹ç»ˆè½åˆ°åŒä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œåœ¨ä¸Šè¿° epoll æ¨¡å‹ä¸‹ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ epoll_ctl çš„æ—¶å€™åŠ ä¸Š &lt;code&gt;EPOLLONESHOT&lt;/code&gt; æ ‡å¿—ï¼Œç„¶ååœ¨æ¯æ¬¡å¤„ç†å®Œé‡æ–°æŠŠè¿™ä¸ª socket fd åŠ åˆ° epoll é‡Œé¢å»ã€‚&lt;/p&gt;&lt;h3&gt;&lt;span&gt;3.3 epoll load balance æ€»ç»“&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;è¦æ­£ç¡®çš„ç”¨å¥½ epoll(2) å¹¶ä¸å®¹æ˜“ï¼Œè¦ç”¨ epoll å®ç°è´Ÿè½½å‡è¡¡å¹¶ä¸”é¿å…æ•°æ®ç«äº‰ï¼Œå¿…é¡»æŒæ¡å¥½ &lt;code&gt;EPOLLONESHOT&lt;/code&gt; å’Œ &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; è¿™ä¸¤ä¸ªæ ‡å¿—ã€‚è€Œ &lt;code&gt;EPOLLEXCLUSIVE&lt;/code&gt; åˆæ˜¯ä¸ª epoll åæ¥æ–°åŠ çš„æ ‡å¿—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ epoll æœ€åˆè®¾è®¡æ—¶ï¼Œå¹¶æ²¡æœ‰æƒ³ç€æ”¯æŒè¿™ç§å¤šçº¿ç¨‹è´Ÿè½½å‡è¡¡çš„åœºæ™¯ã€‚&lt;/p&gt;&lt;h3&gt;&lt;span&gt;4. epoll ä¹‹ file descriptor ä¸ file description&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;è¿™ä¸€ç« æˆ‘ä»¬ä¸»è¦è®¨è®º epoll çš„å¦ä¸€ä¸ªå¤§é—®é¢˜ï¼šfile descriptor ä¸ file description ç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´çš„é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;Foom åœ¨ LWN&lt;span&gt;[6]&lt;/span&gt; ä¸Šè¯´é“ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;æ˜¾ç„¶ epoll å­˜åœ¨å·¨å¤§çš„è®¾è®¡ç¼ºé™·ï¼Œä»»ä½•æ‡‚å¾— file descriptor çš„äººåº”è¯¥éƒ½èƒ½çœ‹å¾—å‡ºæ¥ã€‚äº‹å®ä¸Šå½“ä½ å›æœ› epoll çš„å†å²ï¼Œä½ ä¼šå‘ç°å½“æ—¶å®ç° epoll çš„äººä»¬æ˜¾ç„¶å¹¶ä¸æ€ä¹ˆäº†è§£ file descriptor å’Œ file description çš„åŒºåˆ«ã€‚:(&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å®é™…ä¸Šï¼Œepoll() çš„è¿™ä¸ªé—®é¢˜ä¸»è¦åœ¨äºå®ƒæ··æ·†äº†ç”¨æˆ·æ€çš„ file descriptor (æˆ‘ä»¬å¹³å¸¸è¯´çš„æ•°å­— fd) å’Œå†…æ ¸æ€ä¸­çœŸæ­£ç”¨äºå®ç°çš„ file descriptionã€‚å½“è¿›ç¨‹è°ƒç”¨ close(2) å…³é—­ä¸€ä¸ª fd æ—¶ï¼Œè¿™ä¸ªé—®é¢˜å°±ä¼šä½“ç°å‡ºæ¥ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;epoll_ctl(EPOLL_CTL_ADD)&lt;/code&gt; å®é™…ä¸Šå¹¶ä¸æ˜¯æ³¨å†Œä¸€ä¸ª file descriptor (fd)ï¼Œè€Œæ˜¯å°† fd å’Œ ä¸€ä¸ªæŒ‡å‘å†…æ ¸ file description çš„æŒ‡é’ˆçš„å¯¹ (tuple) ä¸€å—æ³¨å†Œç»™äº† epollï¼Œå¯¼è‡´é—®é¢˜çš„æ ¹æºåœ¨äºï¼Œepoll é‡Œç®¡ç†çš„ fd çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸æ˜¯ fd æœ¬èº«çš„ï¼Œè€Œæ˜¯å†…æ ¸ä¸­ç›¸åº”çš„ file description çš„ã€‚&lt;/p&gt;&lt;p&gt;å½“ä½¿ç”¨ close(2) è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å…³æ‰ä¸€ä¸ª fd æ—¶ï¼Œå¦‚æœè¿™ä¸ª fd æ˜¯å†…æ ¸ä¸­ file description çš„å”¯ä¸€å¼•ç”¨æ—¶ï¼Œå†…æ ¸ä¸­çš„ file description ä¹Ÿä¼šè·Ÿç€ä¸€å¹¶è¢«åˆ é™¤ï¼Œè¿™æ ·æ˜¯ OK çš„ï¼›ä½†æ˜¯å½“å†…æ ¸ä¸­çš„ file description è¿˜æœ‰å…¶ä»–å¼•ç”¨æ—¶ï¼Œclose å¹¶ä¸ä¼šåˆ é™¤è¿™ä¸ª file descrptionã€‚è¿™æ ·ä¼šå¯¼è‡´å½“è¿™ä¸ª fd è¿˜æ²¡æœ‰ä» epoll ä¸­æŒªå‡ºå°±è¢«ç›´æ¥ close æ—¶ï¼Œepoll() è¿˜ä¼šåœ¨è¿™ä¸ªå·²ç» close() æ‰äº†çš„ fd ä¸Šä¸ŠæŠ¥äº‹ä»¶ã€‚&lt;/p&gt;&lt;p&gt;è¿™é‡Œä»¥ dup(2) ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹æ¥å±•ç¤ºè¿™ä¸ªé—®é¢˜ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt; 1&lt;/span&gt;rfd,Â wfdÂ =Â pipe()&lt;br/&gt;&lt;span&gt; 2&lt;/span&gt;write(wfd,Â &quot;a&quot;)Â Â Â Â Â Â Â Â Â Â Â Â Â #Â MakeÂ theÂ &quot;rfd&quot;Â readable&lt;br/&gt;&lt;span&gt; 3&lt;/span&gt;&lt;br/&gt;&lt;span&gt; 4&lt;/span&gt;epfdÂ =Â epoll_create()&lt;br/&gt;&lt;span&gt; 5&lt;/span&gt;epoll_ctl(efpd,Â EPOLL_CTL_ADD,Â rfd,Â (EPOLLIN,Â rfd))&lt;br/&gt;&lt;span&gt; 6&lt;/span&gt;&lt;br/&gt;&lt;span&gt; 7&lt;/span&gt;rfd2Â =Â dup(rfd)&lt;br/&gt;&lt;span&gt; 8&lt;/span&gt;close(rfd)&lt;br/&gt;&lt;span&gt; 9&lt;/span&gt;&lt;br/&gt;&lt;span&gt;10&lt;/span&gt;rÂ =Â epoll_wait(epfd,Â -1ms)Â Â #Â WhatÂ willÂ happen?&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç”±äº close(rfd) å…³æ‰äº†è¿™ä¸ª rfdï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºè¿™ä¸ª epoll_wait() ä¼šä¸€ç›´é˜»å¡ä¸è¿”å›ï¼Œè€Œå®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ã€‚ç”±äºè°ƒç”¨äº† dup()ï¼Œå†…æ ¸ä¸­ç›¸åº”çš„ file description ä»ç„¶è¿˜æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°è€Œæ²¡æœ‰è¢«åˆ é™¤ï¼Œæ‰€ä»¥è¿™ä¸ª file descption çš„äº‹ä»¶ä»ç„¶ä¼šä¸ŠæŠ¥ç»™ epollã€‚å› æ­¤ &lt;code&gt;epoll_wait()&lt;/code&gt; ä¼šç»™ä¸€ä¸ªå·²ç»ä¸å­˜åœ¨çš„ fd ä¸ŠæŠ¥äº‹ä»¶ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œä¸€æ—¦ä½  close() äº†è¿™ä¸ª fdï¼Œå†ä¹Ÿæ²¡æœ‰æœºä¼šæŠŠè¿™ä¸ªæ­»æ‰çš„ fd ä» epoll ä¸Šæ‘˜é™¤äº†ï¼Œä¸‹é¢çš„åšæ³•éƒ½ä¸è¡Œï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;epoll_ctl(efpd,Â EPOLL_CTL_DEL,Â rfd)&lt;br/&gt;&lt;span&gt;2&lt;/span&gt;epoll_ctl(efpd,Â EPOLL_CTL_DEL,Â rfd2)&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Marc Lehmann ä¹Ÿæåˆ°è¿™ä¸ªé—®é¢˜ï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;å› æ­¤ï¼Œå­˜åœ¨ close æ‰äº†ä¸€ä¸ª fdï¼Œå´è¿˜ä¸€ç›´ä»è¿™ä¸ª fd ä¸Šæ”¶åˆ° epoll äº‹ä»¶çš„å¯èƒ½æ€§ã€‚å¹¶ä¸”è¿™ç§æƒ…å†µä¸€æ—¦å‘ç”Ÿï¼Œä¸ç®¡ä½ åšä»€ä¹ˆéƒ½æ— æ³•æ¢å¤äº†ã€‚&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å› æ­¤ï¼Œå¹¶ä¸èƒ½ä¾èµ–äº &lt;code&gt;close()&lt;/code&gt; æ¥åšæ¸…ç†å·¥ä½œï¼Œä¸€æ—¦è°ƒç”¨äº† close()ï¼Œè€Œæ­£å¥½å†…æ ¸é‡Œé¢çš„ file description è¿˜æœ‰å¼•ç”¨ï¼Œè¿™ä¸ª epoll fd å°±å†ä¹Ÿä¿®ä¸å¥½äº†ï¼Œå”¯ä¸€çš„åšæ³•æ˜¯æŠŠçš„ epoll fd ç»™å¹²æ‰ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„å¹¶å°†ä¹‹å‰é‚£äº› fd å…¨éƒ¨å†åŠ åˆ°è¿™ä¸ªæ–°çš„ epoll fd ä¸Šã€‚æ‰€ä»¥è®°ä½è¿™æ¡å¿ å‘Šï¼š&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&lt;span&gt;1&lt;/span&gt;æ°¸è¿œè®°ç€å…ˆåœ¨è°ƒç”¨Â close()Â ä¹‹å‰ï¼Œæ˜¾ç¤ºçš„è°ƒç”¨Â epoll_ctl(EPOLL_CTL_DEL)&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3&gt;&lt;span&gt;4.1 æ€»ç»“&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;æ˜¾å¼çš„å°† fd ä» epoll ä¸Šé¢åˆ æ‰åœ¨è°ƒç”¨ &lt;code&gt;close()&lt;/code&gt; çš„è¯å¯ä»¥å·¥ä½œçš„å¾ˆå¥½ï¼Œå‰ææ˜¯ä½ å¯¹æ‰€æœ‰çš„ä»£ç éƒ½æœ‰æŒæ§åŠ›ã€‚ç„¶ååœ¨ä¸€äº›åœºæ™¯é‡Œå¹¶ä¸ä¸€ç›´æ˜¯è¿™æ ·ï¼Œè­¬å¦‚å½“å†™ä¸€ä¸ªå°è£… epoll çš„åº“ï¼Œæœ‰æ—¶ä½ å¹¶ä¸èƒ½ç¦æ­¢ç”¨æˆ·è°ƒç”¨ close(2) ç³»ç»Ÿè°ƒç”¨ã€‚å› æ­¤ï¼Œè¦å†™ä¸€ä¸ªåŸºäº epoll çš„è½»é‡çº§çš„æŠ½è±¡å±‚å¹¶ä¸æ˜¯ä¸€ä¸ªè½»æ¾çš„äº‹æƒ…ã€‚&lt;/p&gt;&lt;p&gt;å¦å¤–ï¼ŒIllumos ä¹Ÿå®ç°äº†ä¸€å¥— epoll() æœºåˆ¶ï¼Œåœ¨ä»–ä»¬çš„æ‰‹å†Œä¸Šï¼Œæ˜ç¡®æåˆ° Linux ä¸Šè¿™ä¸ª epoll()/close() çš„å¥‡æ€ªè¯­ä¹‰ï¼Œå¹¶ä¸”æ‹’ç»æ”¯æŒã€‚&lt;/p&gt;&lt;p&gt;å¸Œæœ›æœ¬æ‰€æåˆ°çš„é—®é¢˜å¯¹äºä½¿ç”¨ Linux ä¸Šè¿™ä¸ªç³Ÿç³•çš„ epoll() è®¾è®¡çš„äººæœ‰æ‰€å¸®åŠ©ã€‚&lt;/p&gt;&lt;hr/&gt;&lt;p&gt;æ³¨1ï¼šç¬”è€…è®¤ä¸ºè¯¥åœºæ™¯ä¸‹æˆ–è®¸ç›´æ¥ç”¨ä¸€ä¸ª master çº¿ç¨‹æ¥åšåˆ†å‘ï¼Œå¤šä¸ª worker çº¿ç¨‹åšå¤„ç† æˆ–è€…é‡‡ç”¨æ¯ä¸ª worker çº¿ç¨‹ä¸€ä¸ªè‡ªå·±ç‹¬ç«‹çš„ epoll fd å¯èƒ½æ˜¯æ›´å¥½çš„æ–¹æ¡ˆã€‚&lt;/p&gt;&lt;h3&gt;&lt;span&gt;5 å¼•ç”¨&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;span&gt;[1]https://idea.popcount.org/2016-11-01-a-brief-history-of-select2/&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;[2]https://idea.popcount.org/2017-01-06-select-is-fundamentally-broken/&lt;/span&gt;&lt;/p&gt;&lt;section&gt;&lt;p&gt;[3]https://idea.popcount.org/2017-02-20-epoll-is-fundamentally-broken-12/&lt;/p&gt;&lt;p&gt;[4]https://idea.popcount.org/2017-03-20-epoll-is-fundamentally-broken-22/&lt;/p&gt;&lt;p&gt;[5]https://lwn.net/Articles/542866/&lt;/p&gt;&lt;p&gt;[6]https://lwn.net/Articles/542866/&lt;/p&gt;&lt;p&gt;[7]https://kernel.taobao.org/2019/12/epoll-is-fundamentally-broken/&lt;/p&gt;&lt;p&gt;[8]https://zh.wikipedia.org/wiki/Epoll&lt;/p&gt;&lt;p&gt;&lt;span&gt;[9]https://stackoverflow.com/questions/4058368/what-does-eagain-mean&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;strong&gt;å¦‚æœè§‰å¾—æœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œå¯ä»¥ç‚¹å‡»ğŸ‘‡ğŸ»çš„ æ”¶è—ã€èµå’Œåœ¨çœ‹æ”¯æŒä¸€ä¸‹ä½œè€…å™¢&lt;/strong&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>