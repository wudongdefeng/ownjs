<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
            <channel>
            <title>开发者头条</title>
            <link>http://toutiao.io/</link>
            <description></description>
<item>
<guid>9044637ed4e70d8cd7c54d40f42e8878</guid>
<title>万字长文，SpringSecurity实现权限系统设计</title>
<link>https://toutiao.io/k/rb5lzmf</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content                           autoTypeSetting24psection&amp;#10;                          &quot; id=&quot;js_content&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;span&gt;（给&lt;/span&gt;&lt;span&gt;ImportNew&lt;/span&gt;&lt;span&gt;加星标，提高Java技能）&lt;br/&gt;&lt;/span&gt;&lt;/span&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3989071038251366&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcuPvyiaPesTIib1wSToEm2ZicYYKalqethnicgibT4akjyCMBaGJsPHdibW1g/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC权限分析&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC 全称为基于角色的权限控制，本段将会从什么是RBAC，模型分类，什么是权限，用户组的使用，实例分析等几个方面阐述RBAC&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;思维导图&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;绘制思维导图如下&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5448613376835236&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcL20VCkYTW3ZYAqygicESPaicmv0uMNcLglJicCKWI0Tia76X30oQD89ibRg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;613&quot;/&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;什么是RBAC&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC 全称为用户角色权限控制，通过角色关联用户，角色关联权限，这种方式，间阶的赋予用户的权限，如下图所示&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.1448087431693989&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNc0BZkibvvD3kgNIDlNA8cwAvWniaLU3byD6pv4fpldVMclLj2gc6nCXHg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;对于通常的系统而言，存在多个用户具有相同的权限，在分配的时候，要为指定的用户分配相关的权限，修改的时候也要依次的对这几个用户的权限进行修改，有了角色这个权限，在修改权限的时候，只需要对角色进行修改，就可以实现相关的权限的修改。这样做增加了效率，减少了权限漏洞的发生。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;模型分类&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;对于RBAC模型来说，分为以下几个模型 分别是RBAC0，RBAC1，RBAC2，RBAC3，这四个&lt;/span&gt;模型，这段将会依次介绍这四个模型，其中最常用的模型有RBAC0.&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC0&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC0是最简单的RBAC模型，这里面包含了两种。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;用户和角色是多对一的关系，即一个用户只充当一种角色，一个角色可以有多个角色的担当。用户和角色是多对多的关系，即，一个用户可以同时充当多个角色，一个角色可以有多个用户。 &lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;此系统功能单一，人员较少，这里举个栗子，张三既是行政，也负责财务，此时张三就有俩个权限，分别是行政权限，和财务权限两个部分。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC1&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;相对于RBAC0模型来说，增加了子角色，引入了继承的概念。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.21584699453551912&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcXiccUd8e99a9dpBj2MBCAYAn5icia1CATwXYufXvaJ6RHlstTpCzjQ2Tg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC2 模型&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里RBAC2模型，在RBAC0模型的基础上，增加了一些功能，以及限制&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;角色互斥&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，同一个用户不能拥有两个互斥的角色，举个例子，在财务系统中，一个用户不能拥有会计员和审计这两种角色。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基数约束&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，用一个角色，所拥有的成员是固定的，例如对于CEO这种角色，同一个角色，也只能有一个用户。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;先决条件&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，对于该角色来说，如果想要获得更高的角色，需要先获取低一级别的角色。举个栗子，对于副总经理和经理这两个权限来说，需要先有副总经理权限，才能拥有经理权限，其中副总经理权限是经理权限的先决条件。&lt;/span&gt;&lt;/p&gt;&lt;h4 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;运行时互斥&lt;/span&gt;&lt;/h4&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，一个用户可以拥有两个角色，但是这俩个角色不能同时使用，需要切换角色才能进入另外一个角色。举个栗子，对于总经理和专员这两个角色，系统只能在一段时间，拥有其一个角色，不能同时对这两种角色进行操作。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;RBAC3模型&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，RBAC1，RBAC2，两者模型全部累计，称为统一模型。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5748502994011976&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcZKkUicMNRHUlVhyVIFAJ1NSfiavu16AiaSPxksLL1IrkYRWNMqsGBZHOQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;501&quot;/&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;什么是权限&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;权限是资源的集合，这里的资源指的是软件中的所有的内容，即，对页面的操作权限，对页面的访问权限，对数据的增删查改的权限。举个栗子。对于下图中的系统而言，&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3551912568306011&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcj7eScIqF6GMdN5jeIdAL4oicIwvNhiaRnVsNxQ2FjCrGudYbiaskfgdzQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;拥有，计划管理，客户管理，合同管理，出入库通知单管理，粮食安全追溯，粮食统计查询，设备管理这几个页面，对这几个页面的访问，以及是否能够访问到菜单，都属于权限。&lt;/span&gt;&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;用户组的使用&lt;/span&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;对于用户组来说，是把众多的用户划分为一组，进行批量授予角色，即，批量授予权限。举个栗子，对于部门来说，一个部门拥有一万多个员工，这些员工都拥有相同的角色，如果没有用户组，可能需要一个个的授予相关的角色，在拥有了用户组以后，只需要，把这些用户全部划分为一组，然后对该组设置授予角色，就等同于对这些用户授予角色。&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;优点：减少工作量，便于理解，增加多级管理，等。&lt;span&gt;最新面试题整理好了，点击Java面试库小程序在线刷题。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;SpringSecurity 简单使用&lt;/span&gt;&lt;br/&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;首先添加依赖&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Spring Boot 基础就不介绍了，推荐下这个实战教程：https://github.com/javastacks/spring-boot-best-practice&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;lt;&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&amp;lt;&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&amp;lt;&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-security&lt;span&gt;&amp;lt;/&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;span&gt;&amp;lt;/&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;然后添加相关的访问接口&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;package&lt;/span&gt; com.example.demo.web;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.web.bind.&lt;span&gt;annotation&lt;/span&gt;.RequestMapping;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.web.bind.&lt;span&gt;annotation&lt;/span&gt;.RestController;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;@RestController&lt;/span&gt;&lt;br/&gt;&lt;span&gt;@RequestMapping(&lt;span&gt;&quot;/test&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;Test&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;@RequestMapping(&lt;span&gt;&quot;/test&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; String test(){&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;&quot;test&quot;&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;最后启动项目，在日志中查看相关的密码&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.1871584699453552&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcJfkAB2zSofXhjO2R0ENfpV8R1FU5ca4oXgK7hPcjoCic6QQZOZ4JJibw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;访问接口，可以看到相关的登录界面&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.36885245901639346&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNco4N8dNn6ndZjYCVvTrm8MeH32X18B98JFs34I81bzURSrJfOxbiaZDA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;输入用户名和相关的密码&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;用户名：user&lt;br/&gt;密码 984cccf2-ba82-468e-a404-7d32123d0f9c&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.34972677595628415&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNc5egEMb03cSFKrFicARnx3ib5Bkaib6gMwkpTmYiawqfevVBDXdEPlZ0IPA/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;登录成功&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;增加用户名和密码&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在配置文件中，书写相关的登录和密码&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;spring:&lt;br/&gt;  security:&lt;br/&gt;    user:&lt;br/&gt;      name: ming&lt;br/&gt;      password: 123456&lt;br/&gt;      roles: admin&lt;br/&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在登录页面，输入用户名和密码，即可正常登录。另外，Spring 系列面试题和答案全部整理好了，微信搜索Java技术栈，在后台发送：面试，可以在线阅读。&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;基于内存的认证&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;需要自定义类继承 WebSecurityConfigurerAdapter 代码如下&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;package&lt;/span&gt; com.example.demo.config;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.context.annotation.&lt;span&gt;Bean&lt;/span&gt;;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.context.annotation.&lt;span&gt;Configuration&lt;/span&gt;;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.config.annotation.authentication.builders.&lt;span&gt;AuthenticationManagerBuilder&lt;/span&gt;;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.config.annotation.web.configuration.&lt;span&gt;WebSecurityConfigurerAdapter&lt;/span&gt;;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.crypto.password.&lt;span&gt;NoOpPasswordEncoder&lt;/span&gt;;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.crypto.password.&lt;span&gt;PasswordEncoder&lt;/span&gt;;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;@Configuration&lt;/span&gt;&lt;br/&gt;public &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;MyWebSecurityConfig&lt;/span&gt; &lt;span&gt;extends&lt;/span&gt; &lt;span&gt;WebSecurityConfigurerAdapter&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;PasswordEncoder&lt;/span&gt; passwordEncoder(){&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;NoOpPasswordEncoder&lt;/span&gt;.getInstance();&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;protected&lt;/span&gt; void configure(&lt;span&gt;AuthenticationManagerBuilder&lt;/span&gt; auth) &lt;span&gt;throws&lt;/span&gt; &lt;span&gt;Exception&lt;/span&gt; {&lt;br/&gt;        auth.inMemoryAuthentication()&lt;br/&gt;                .withUser(&lt;span&gt;&quot;admin&quot;&lt;/span&gt;).password(&lt;span&gt;&quot;123&quot;&lt;/span&gt;).roles(&lt;span&gt;&quot;admin&quot;&lt;/span&gt;);&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，配置的用户名为admin，密码为123，角色为admin&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;HttpSecurity&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里对一些方法进行拦截&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;package com.ming.demo.interceptor;&lt;br/&gt;&lt;br/&gt;import org.springframework.beans.factory.annotation.Autowired;&lt;br/&gt;import org.springframework.context.annotation.Bean;&lt;br/&gt;import org.springframework.context.annotation.Configuration;&lt;br/&gt;import org.springframework.http.HttpMethod;&lt;br/&gt;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;&lt;br/&gt;import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;&lt;br/&gt;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&lt;br/&gt;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;&lt;br/&gt;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;&lt;br/&gt;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;&lt;br/&gt;import org.springframework.security.crypto.password.PasswordEncoder;&lt;br/&gt;import org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices;&lt;br/&gt;&lt;br/&gt;@Configuration&lt;br/&gt;@EnableWebSecurity&lt;br/&gt;public class SecurityConfig  extends WebSecurityConfigurerAdapter {&lt;br/&gt;    //基于内存的用户存储&lt;br/&gt;    @Override&lt;br/&gt;    public void configure(AuthenticationManagerBuilder auth) throws Exception {&lt;br/&gt;        auth.inMemoryAuthentication()&lt;br/&gt;                .withUser(&quot;itguang&quot;).password(&quot;123456&quot;).roles(&quot;USER&quot;).and()&lt;br/&gt;                .withUser(&quot;admin&quot;).password(&quot;{noop}&quot; + &quot;123456&quot;).roles(&quot;ADMIN&quot;);&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    //请求拦截&lt;br/&gt;    @Override&lt;br/&gt;    protected void configure(HttpSecurity http) throws Exception {&lt;br/&gt;        http.authorizeRequests()&lt;br/&gt;                .anyRequest().permitAll()&lt;br/&gt;                .and()&lt;br/&gt;                .formLogin()&lt;br/&gt;                .permitAll()&lt;br/&gt;                .and()&lt;br/&gt;                .logout()&lt;br/&gt;                .permitAll();&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，这里完成了对所有的方法访问的拦截。&lt;/span&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;SpringSecurity 集成JWT&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这是一个小demo，目的，登录以后返回jwt生成的token&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;推荐一个 Spring Boot 基础教程及实战示例：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://github.com/javastacks/spring-boot-best-practice&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;导入依赖&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;添加web依赖&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6612021857923497&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcOBDuAoTzunRgqeRZdbpu4iaeSYc12rWcO8Rd53AlLM2IvvltsTTZjsw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;导入JWT和Security依赖&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt; &lt;span&gt;&amp;lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt --&amp;gt;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&amp;lt;&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;io.jsonwebtoken&lt;span&gt;&amp;lt;/&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;jjwt&lt;span&gt;&amp;lt;/&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.9.1&lt;span&gt;&amp;lt;/&lt;span&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&amp;lt;/&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&amp;lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security --&amp;gt;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&amp;lt;&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;span&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-security&lt;span&gt;&amp;lt;/&lt;span&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;&amp;lt;&lt;span&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.3.1.RELEASE&lt;span&gt;&amp;lt;/&lt;span&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;&amp;lt;/&lt;span&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;创建一个JwtUser实现UserDetails&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;创建 一个相关的JavaBean&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;package com.example.demo;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.core.GrantedAuthority;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.core.userdetails.UserDetails;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; java.util.Collection;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; JwtUser &lt;span&gt;implements&lt;/span&gt; UserDetails {&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; username;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; password;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; Integer state;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; Collection&amp;lt;? &lt;span&gt;extends&lt;/span&gt; GrantedAuthority&amp;gt; authorities;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; JwtUser(){&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; JwtUser(&lt;span&gt;String&lt;/span&gt; username, &lt;span&gt;String&lt;/span&gt; password, Integer state,  Collection&amp;lt;? &lt;span&gt;extends&lt;/span&gt; GrantedAuthority&amp;gt; authorities){&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.username = username;&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.password = password;&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.state = state;&lt;br/&gt;        &lt;span&gt;this&lt;/span&gt;.authorities = authorities;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; Collection&amp;lt;? &lt;span&gt;extends&lt;/span&gt; GrantedAuthority&amp;gt; getAuthorities() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; authorities;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; getPassword() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;this&lt;/span&gt;.password;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; getUsername() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;this&lt;/span&gt;.username;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; isAccountNonExpired() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; isAccountNonLocked() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; isCredentialsNonExpired() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt; isEnabled() {&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写工具类生成令牌&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;编写工具类，用来生成token，以及刷新token，以及验证token&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;package com.example.demo;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; io.jsonwebtoken.Claims;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; io.jsonwebtoken.Jwts;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; io.jsonwebtoken.SignatureAlgorithm;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; org.springframework.security.core.userdetails.UserDetails;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; java.io.Serializable;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; java.util.Date;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; java.util.HashMap;&lt;br/&gt;&lt;span&gt;import&lt;/span&gt; java.util.Map;&lt;br/&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; JwtTokenUtil &lt;span&gt;implements&lt;/span&gt; Serializable {&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; secret;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; Long expiration;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; header;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; generateToken(Map&amp;lt;&lt;span&gt;String&lt;/span&gt;, &lt;span&gt;Object&lt;/span&gt;&amp;gt; claims) {&lt;br/&gt;        &lt;span&gt;Date&lt;/span&gt; expirationDate = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;Date&lt;/span&gt;(System.currentTimeMillis() + expiration);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; Jwts.builder().setClaims(claims).setExpiration(expirationDate).signWith(SignatureAlgorithm.HS512, secret).compact();&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; Claims getClaimsFromToken(&lt;span&gt;String&lt;/span&gt; token) {&lt;br/&gt;        Claims claims;&lt;br/&gt;        &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;            claims = Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();&lt;br/&gt;&lt;br/&gt;        } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;            claims = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;        }&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; claims;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; generateToken(UserDetails userDetails) {&lt;br/&gt;        Map&amp;lt;&lt;span&gt;String&lt;/span&gt;, &lt;span&gt;Object&lt;/span&gt;&amp;gt; claims = &lt;span&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;(&lt;span&gt;2&lt;/span&gt;);&lt;br/&gt;        claims.put(&lt;span&gt;&quot;sub&quot;&lt;/span&gt;, userDetails.getUsername());&lt;br/&gt;        claims.put(&lt;span&gt;&quot;created&quot;&lt;/span&gt;, &lt;span&gt;new&lt;/span&gt; &lt;span&gt;Date&lt;/span&gt;());&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; generateToken(claims);&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; getUsernameFromToken(&lt;span&gt;String&lt;/span&gt; token) {&lt;br/&gt;        &lt;span&gt;String&lt;/span&gt; username;&lt;br/&gt;        &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;            Claims claims = getClaimsFromToken(token);&lt;br/&gt;            username = claims.getSubject();&lt;br/&gt;&lt;br/&gt;        } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;            username = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;&lt;br/&gt;        }&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; username;&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;Boolean&lt;/span&gt; isTokenExpired(&lt;span&gt;String&lt;/span&gt; token) {&lt;br/&gt;        &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;            Claims claims = getClaimsFromToken(token);&lt;br/&gt;            &lt;span&gt;Date&lt;/span&gt; expiration = claims.getExpiration();&lt;br/&gt;            &lt;span&gt;return&lt;/span&gt; expiration.before(&lt;span&gt;new&lt;/span&gt; &lt;span&gt;Date&lt;/span&gt;());&lt;br/&gt;        } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;            &lt;span&gt;return&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;;&lt;br/&gt;        }&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;String&lt;/span&gt; refreshToken(&lt;span&gt;String&lt;/span&gt; token) {&lt;br/&gt;        &lt;span&gt;String&lt;/span&gt; refreshedToken;&lt;br/&gt;        &lt;span&gt;try&lt;/span&gt; {&lt;br/&gt;            Claims claims = getClaimsFromToken(token);&lt;br/&gt;            claims.put(&lt;span&gt;&quot;created&quot;&lt;/span&gt;, &lt;span&gt;new&lt;/span&gt; &lt;span&gt;Date&lt;/span&gt;());&lt;br/&gt;            refreshedToken = generateToken(claims);&lt;br/&gt;&lt;br/&gt;        } &lt;span&gt;catch&lt;/span&gt; (Exception e) {&lt;br/&gt;            refreshedToken = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;&lt;br/&gt;        }&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; refreshedToken;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;Boolean&lt;/span&gt; validateToken(&lt;span&gt;String&lt;/span&gt; token, UserDetails userDetails) {&lt;br/&gt;        JwtUser user = (JwtUser) userDetails;&lt;br/&gt;        &lt;span&gt;String&lt;/span&gt; username = getUsernameFromToken(token);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; (username.equals(user.getUsername()) &amp;amp;&amp;amp; !isTokenExpired(token));&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写拦截器&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写Filter 用来检测JWT&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;最新面试题整理好了，点击Java面试库小程序在线刷题。&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;package com.example.demo;&lt;br/&gt;&lt;br/&gt;import org.apache.commons.lang.StringUtils;&lt;br/&gt;import org.springframework.beans.factory.annotation.Autowired;&lt;br/&gt;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;&lt;br/&gt;import org.springframework.security.core.context.SecurityContextHolder;&lt;br/&gt;import org.springframework.security.core.userdetails.UserDetails;&lt;br/&gt;import org.springframework.security.core.userdetails.UserDetailsService;&lt;br/&gt;import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;&lt;br/&gt;import org.springframework.stereotype.Component;&lt;br/&gt;import org.springframework.web.filter.OncePerRequestFilter;&lt;br/&gt;&lt;br/&gt;import javax.servlet.FilterChain;&lt;br/&gt;import javax.servlet.ServletException;&lt;br/&gt;import javax.servlet.http.HttpServletRequest;&lt;br/&gt;import javax.servlet.http.HttpServletResponse;&lt;br/&gt;import java.io.IOException;&lt;br/&gt;&lt;br/&gt;@Component&lt;br/&gt;public class JwtAuthenticationTokenFilter  extends OncePerRequestFilter {&lt;br/&gt;    @Autowired&lt;br/&gt;    private UserDetailsService userDetailsService;&lt;br/&gt;    @Autowired&lt;br/&gt;    private JwtTokenUtil jwtTokenUtil;&lt;br/&gt;&lt;br/&gt;    @Override&lt;br/&gt;    protected void doFilterInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain) throws ServletException, IOException {&lt;br/&gt;        String authHeader = httpServletRequest.getHeader(jwtTokenUtil.getHeader());&lt;br/&gt;        if (authHeader != null &amp;amp;&amp;amp; StringUtils.isNotEmpty(authHeader)) {&lt;br/&gt;            String username = jwtTokenUtil.getUsernameFromToken(authHeader);&lt;br/&gt;            if (username != null &amp;amp;&amp;amp; SecurityContextHolder.getContext().getAuthentication() == null) {&lt;br/&gt;                UserDetails userDetails = this.userDetailsService.loadUserByUsername(username);&lt;br/&gt;                if (jwtTokenUtil.validateToken(authHeader, userDetails)) {&lt;br/&gt;                    UsernamePasswordAuthenticationToken authentication  =&lt;br/&gt;                    new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());&lt;br/&gt;                    authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(httpServletRequest));&lt;br/&gt;                    SecurityContextHolder.getContext().setAuthentication(authentication);&lt;br/&gt;&lt;br/&gt;                }&lt;br/&gt;            }&lt;br/&gt;        }&lt;br/&gt;        filterChain.doFilter(httpServletRequest, httpServletResponse);&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写userDetailsService的实现类&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;在上方代码中，编写userDetailsService，类，实现其验证过程&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;package com.example.demo;&lt;br/&gt;&lt;br/&gt;import org.springframework.beans.factory.annotation.Autowired;&lt;br/&gt;import org.springframework.security.core.authority.SimpleGrantedAuthority;&lt;br/&gt;import org.springframework.security.core.userdetails.User;&lt;br/&gt;import org.springframework.security.core.userdetails.UserDetails;&lt;br/&gt;import org.springframework.security.core.userdetails.UserDetailsService;&lt;br/&gt;import org.springframework.security.core.userdetails.UsernameNotFoundException;&lt;br/&gt;import org.springframework.stereotype.Service;&lt;br/&gt;&lt;br/&gt;import javax.management.relation.Role;&lt;br/&gt;import java.util.List;&lt;br/&gt;&lt;br/&gt;@Service&lt;br/&gt;public class JwtUserDetailsServiceImpl  implements UserDetailsService {&lt;br/&gt;    @Autowired&lt;br/&gt;    private UserMapper userMapper;&lt;br/&gt;&lt;br/&gt;    @Override&lt;br/&gt;    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {&lt;br/&gt;        User user = userMapper.selectByUserName(s);&lt;br/&gt;        if (user == null) {&lt;br/&gt;            throw new UsernameNotFoundException(String.format(&quot;&#x27;%s&#x27;.这个用户不存在&quot;, s));&lt;br/&gt;&lt;br/&gt;        }&lt;br/&gt;        List&amp;lt;SimpleGrantedAuthority&amp;gt; collect = user.getRoles().stream().map(Role::getRolename).map(SimpleGrantedAuthority::new).collect(Collectors.toList());&lt;br/&gt;        return new JwtUser(user.getUsername(), user.getPassword(), user.getState(), collect);&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写登录&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;编写登录业务的实现类 其login方法会返回一个JWTUtils 的token&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;Spring Boot 基础就不介绍了，推荐下这个实战教程：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;https://github.com/javastacks/spring-boot-best-practice&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Service&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;UserServiceImpl&lt;/span&gt;  &lt;span&gt;implements&lt;/span&gt; &lt;span&gt;UserService&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;@Autowired&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; UserMapper userMapper;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Autowired&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; AuthenticationManager authenticationManager;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Autowired&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; UserDetailsService userDetailsService;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Autowired&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; JwtTokenUtil jwtTokenUtil;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;&lt;span&gt;public&lt;/span&gt; User &lt;span&gt;findByUsername&lt;/span&gt;&lt;span&gt;(String username)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;        User user = userMapper.selectByUserName(username);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; user;&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;&lt;span&gt;public&lt;/span&gt; RetResult &lt;span&gt;login&lt;/span&gt;&lt;span&gt;(String username, String password)&lt;/span&gt; &lt;span&gt;throws&lt;/span&gt; AuthenticationException &lt;/span&gt;{&lt;br/&gt;        UsernamePasswordAuthenticationToken upToken = &lt;span&gt;new&lt;/span&gt; UsernamePasswordAuthenticationToken(username, password);&lt;br/&gt;        &lt;span&gt;final&lt;/span&gt; Authentication authentication = authenticationManager.authenticate(upToken);&lt;br/&gt;        SecurityContextHolder.getContext().setAuthentication(authentication);&lt;br/&gt;        UserDetails userDetails = userDetailsService.loadUserByUsername(username);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; RetResult(RetCode.SUCCESS.getCode(),jwtTokenUtil.generateToken(userDetails));&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;最后配置Config&lt;/span&gt;&lt;/h2&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;@EnableGlobalMethodSecurity(prePostEnabled = true)&lt;br/&gt;@EnableWebSecurity&lt;br/&gt;public class WebSecurity extends WebSecurityConfigurerAdapter {&lt;br/&gt;    @Autowired&lt;br/&gt;    private UserDetailsService userDetailsService;&lt;br/&gt;    @Autowired&lt;br/&gt;    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;&lt;br/&gt;&lt;br/&gt;    @Autowired&lt;br/&gt;    public void configureAuthentication(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {&lt;br/&gt;        authenticationManagerBuilder.userDetailsService(this.userDetailsService).passwordEncoder(passwordEncoder());&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)&lt;br/&gt;&lt;br/&gt;    @Override&lt;br/&gt;    public AuthenticationManager authenticationManagerBean() throws Exception {&lt;br/&gt;        return super.authenticationManagerBean();&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    @Bean&lt;br/&gt;    public PasswordEncoder passwordEncoder() {&lt;br/&gt;        return new BCryptPasswordEncoder();&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    @Override&lt;br/&gt;    protected void configure(HttpSecurity http) throws Exception {&lt;br/&gt;        http.csrf().disable().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)&lt;br/&gt;                .and().authorizeRequests()&lt;br/&gt;                .antMatchers(HttpMethod.OPTIONS, &quot;/**&quot;).permitAll()&lt;br/&gt;                .antMatchers(&quot;/auth/**&quot;).permitAll()&lt;br/&gt;                .anyRequest().authenticated()&lt;br/&gt;                .and().headers().cacheControl();&lt;br/&gt;&lt;br/&gt;        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);&lt;br/&gt;&lt;br/&gt;        ExpressionUrlAuthorizationConfigurer&amp;lt;HttpSecurity&amp;gt;.ExpressionInterceptUrlRegistry registry = http.authorizeRequests();&lt;br/&gt;&lt;br/&gt;        registry.requestMatchers(CorsUtils::isPreFlightRequest).permitAll();&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    @Bean&lt;br/&gt;    public CorsFilter corsFilter() {&lt;br/&gt;        final UrlBasedCorsConfigurationSource urlBasedCorsConfigurationSource = new UrlBasedCorsConfigurationSource();&lt;br/&gt;        final CorsConfiguration cors = new CorsConfiguration();&lt;br/&gt;        cors.setAllowCredentials(true);&lt;br/&gt;        cors.addAllowedOrigin(&quot;*&quot;);&lt;br/&gt;        cors.addAllowedHeader(&quot;*&quot;);&lt;br/&gt;        cors.addAllowedMethod(&quot;*&quot;);&lt;br/&gt;        urlBasedCorsConfigurationSource.registerCorsConfiguration(&quot;/**&quot;, cors);&lt;br/&gt;        return new CorsFilter(urlBasedCorsConfigurationSource);&lt;br/&gt;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;运行，返回token&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;运行，返回结果为token&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5245901639344263&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcYt6W7IAuZbRqEZicsmasm41AofYcVg8XQylC6kPdKA2bQysDRtQd7Mg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;732&quot;/&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;SpringSecurity JSON登录&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里配置SpringSecurity之JSON登录&lt;/span&gt;&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里需要重写UsernamePasswordAnthenticationFilter类，以及配置SpringSecurity&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;重写UsernamePasswordAnthenticationFilter&lt;/span&gt;&lt;/h2&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;public &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;CustomAuthenticationFilter&lt;/span&gt; &lt;span&gt;extends&lt;/span&gt; &lt;span&gt;UsernamePasswordAuthenticationFilter&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    public &lt;span&gt;Authentication&lt;/span&gt; attemptAuthentication(&lt;span&gt;HttpServletRequest&lt;/span&gt; request, &lt;span&gt;HttpServletResponse&lt;/span&gt; response) &lt;span&gt;throws&lt;/span&gt; &lt;span&gt;AuthenticationException&lt;/span&gt; {&lt;br/&gt;&lt;br/&gt;        &lt;span&gt;//attempt Authentication when Content-Type is json&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;if&lt;/span&gt;(request.getContentType().equals(&lt;span&gt;MediaType&lt;/span&gt;.&lt;span&gt;APPLICATION_JSON_UTF8_VALUE&lt;/span&gt;)&lt;br/&gt;                ||request.getContentType().equals(&lt;span&gt;MediaType&lt;/span&gt;.&lt;span&gt;APPLICATION_JSON_VALUE&lt;/span&gt;)){&lt;br/&gt;&lt;br/&gt;            &lt;span&gt;//use jackson to deserialize json&lt;/span&gt;&lt;br/&gt;            &lt;span&gt;ObjectMapper&lt;/span&gt; mapper = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;ObjectMapper&lt;/span&gt;();&lt;br/&gt;            &lt;span&gt;UsernamePasswordAuthenticationToken&lt;/span&gt; authRequest = &lt;span&gt;null&lt;/span&gt;;&lt;br/&gt;            &lt;span&gt;try&lt;/span&gt; (&lt;span&gt;InputStream&lt;/span&gt; is = request.getInputStream()){&lt;br/&gt;                &lt;span&gt;AuthenticationBean&lt;/span&gt; authenticationBean = mapper.readValue(is,&lt;span&gt;AuthenticationBean&lt;/span&gt;&lt;span&gt;.&lt;span&gt;class&lt;/span&gt;)&lt;/span&gt;;&lt;br/&gt;                authRequest = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;UsernamePasswordAuthenticationToken&lt;/span&gt;(&lt;br/&gt;                        authenticationBean.getUsername(), authenticationBean.getPassword());&lt;br/&gt;            }&lt;span&gt;catch&lt;/span&gt; (&lt;span&gt;IOException&lt;/span&gt; e) {&lt;br/&gt;                e.printStackTrace();&lt;br/&gt;                authRequest = &lt;span&gt;new&lt;/span&gt; &lt;span&gt;UsernamePasswordAuthenticationToken&lt;/span&gt;(&lt;br/&gt;                        &lt;span&gt;&quot;&quot;&lt;/span&gt;, &lt;span&gt;&quot;&quot;&lt;/span&gt;);&lt;br/&gt;            }&lt;span&gt;finally&lt;/span&gt; {&lt;br/&gt;                setDetails(request, authRequest);&lt;br/&gt;                &lt;span&gt;return&lt;/span&gt; &lt;span&gt;this&lt;/span&gt;.getAuthenticationManager().authenticate(authRequest);&lt;br/&gt;            }&lt;br/&gt;        }&lt;br/&gt;&lt;br/&gt;        &lt;span&gt;//transmit it to UsernamePasswordAuthenticationFilter&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;else&lt;/span&gt; {&lt;br/&gt;            &lt;span&gt;return&lt;/span&gt; &lt;span&gt;super&lt;/span&gt;.attemptAuthentication(request, response);&lt;br/&gt;        }&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;配置SecurityConfig&lt;/span&gt;&lt;/h2&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;@Override&lt;br/&gt;protected void configure(HttpSecurity http) throws Exception {&lt;br/&gt;    http&lt;br/&gt;            .cors().and()&lt;br/&gt;            .antMatcher(&quot;/**&quot;).authorizeRequests()&lt;br/&gt;            .antMatchers(&quot;/&quot;, &quot;/login**&quot;).permitAll()&lt;br/&gt;            .anyRequest().authenticated()&lt;br/&gt;            //这里必须要写formLogin()，不然原有的UsernamePasswordAuthenticationFilter不会出现，也就无法配置我们重新的UsernamePasswordAuthenticationFilter&lt;br/&gt;            .and().formLogin().loginPage(&quot;/&quot;)&lt;br/&gt;            .and().csrf().disable();&lt;br/&gt;&lt;br/&gt;    //用重写的Filter替换掉原有的UsernamePasswordAuthenticationFilter&lt;br/&gt;    http.addFilterAt(customAuthenticationFilter(),&lt;br/&gt;    UsernamePasswordAuthenticationFilter.class);&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;//注册自定义的UsernamePasswordAuthenticationFilter&lt;br/&gt;@Bean&lt;br/&gt;CustomAuthenticationFilter customAuthenticationFilter() throws Exception {&lt;br/&gt;    CustomAuthenticationFilter filter = new CustomAuthenticationFilter();&lt;br/&gt;    filter.setAuthenticationSuccessHandler(new SuccessHandler());&lt;br/&gt;    filter.setAuthenticationFailureHandler(new FailureHandler());&lt;br/&gt;    filter.setFilterProcessesUrl(&quot;/login/self&quot;);&lt;br/&gt;&lt;br/&gt;    //这句很关键，重用WebSecurityConfigurerAdapter配置的AuthenticationManager，不然要自己组装AuthenticationManager&lt;br/&gt;    filter.setAuthenticationManager(authenticationManagerBean());&lt;br/&gt;    return filter;&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这样就完成使用json登录SpringSecurity。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;最新面试题整理好了，点击Java面试库小程序在线刷题。&lt;/span&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;Spring Security 密码加密方式&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;需要在Config 类中配置如下内容&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt; &lt;span&gt;/**&lt;br/&gt;     * 密码加密&lt;br/&gt;     */&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;public&lt;/span&gt; BCryptPasswordEncoder passwordEncoder(){&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; BCryptPasswordEncoder();&lt;br/&gt;    }&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，使用此方法，对密码进行加密， 在业务层的时候，使用此加密的方法&lt;/span&gt;&lt;/p&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Service&lt;/span&gt;&lt;br/&gt;&lt;span&gt;@Transactional&lt;/span&gt;&lt;br/&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;UserServiceImpl&lt;/span&gt; &lt;span&gt;implements&lt;/span&gt; &lt;span&gt;UserService&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Resource&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; UserRepository userRepository;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Resource&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; BCryptPasswordEncoder bCryptPasswordEncoder;  &lt;span&gt;//注入bcryct加密&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&lt;span&gt;public&lt;/span&gt; User &lt;span&gt;add&lt;/span&gt;&lt;span&gt;(User user)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;        user.setPassword(bCryptPasswordEncoder.encode(user.getPassword())); &lt;span&gt;//对密码进行加密&lt;/span&gt;&lt;br/&gt;        User user2 = userRepository.save(user);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; user2;&lt;br/&gt;    }&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;&lt;span&gt;public&lt;/span&gt; ResultInfo &lt;span&gt;login&lt;/span&gt;&lt;span&gt;(User user)&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;        ResultInfo resultInfo=&lt;span&gt;new&lt;/span&gt; ResultInfo();&lt;br/&gt;        User user2 = userRepository.findByName(user.getName());&lt;br/&gt;        &lt;span&gt;if&lt;/span&gt; (user2==&lt;span&gt;null&lt;/span&gt;) {&lt;br/&gt;            resultInfo.setCode(&lt;span&gt;&quot;-1&quot;&lt;/span&gt;);&lt;br/&gt;            resultInfo.setMessage(&lt;span&gt;&quot;用户名不存在&quot;&lt;/span&gt;);&lt;br/&gt;            &lt;span&gt;return&lt;/span&gt; resultInfo;&lt;br/&gt;        }&lt;br/&gt;&lt;br/&gt;        &lt;span&gt;//判断密码是否正确&lt;/span&gt;&lt;br/&gt;        &lt;span&gt;if&lt;/span&gt; (!bCryptPasswordEncoder.matches(user.getPassword(),user2.getPassword())) {&lt;br/&gt;            resultInfo.setCode(&lt;span&gt;&quot;-1&quot;&lt;/span&gt;);&lt;br/&gt;            resultInfo.setMessage(&lt;span&gt;&quot;密码不正确&quot;&lt;/span&gt;);&lt;br/&gt;            &lt;span&gt;return&lt;/span&gt; resultInfo;&lt;br/&gt;        }&lt;br/&gt;        resultInfo.setMessage(&lt;span&gt;&quot;登录成功&quot;&lt;/span&gt;);&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; resultInfo;&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;即，使用BCryptPasswordEncoder 对密码进行加密，保存数据库&lt;/span&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;使用数据库认证&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里使用数据库认证SpringSecurity&lt;/span&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;设计数据表&lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里设计数据表&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6056737588652482&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ibQcycQwt0ecaRaakVIOBWIpnAzxHoFNcATVm8VQMV0HPicmJMbvR0XKnltaVBVzreFXctZbo7mOv5QKFjsnIljw/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;705&quot;/&gt;&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;着重配置SpringConfig&lt;/span&gt;&lt;/h2&gt;&lt;pre data-tool=&quot;mdnice编辑器&quot;&gt;&lt;code&gt;&lt;span&gt;@Configurable&lt;/span&gt;&lt;br/&gt;public &lt;span&gt;&lt;span&gt;class&lt;/span&gt; &lt;span&gt;WebSecurityConfig&lt;/span&gt; &lt;span&gt;extends&lt;/span&gt; &lt;span&gt;WebSecurityConfigurerAdapter&lt;/span&gt; &lt;/span&gt;{&lt;br/&gt;    &lt;span&gt;@Autowired&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;private&lt;/span&gt; &lt;span&gt;UserService&lt;/span&gt; userService;    &lt;span&gt;// service 层注入&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Bean&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;PasswordEncoder&lt;/span&gt; passwordEncoder(){&lt;br/&gt;        &lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; &lt;span&gt;BCryptPasswordEncoder&lt;/span&gt;();&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;protected&lt;/span&gt; void configure(&lt;span&gt;AuthenticationManagerBuilder&lt;/span&gt; auth) &lt;span&gt;throws&lt;/span&gt; &lt;span&gt;Exception&lt;/span&gt; {&lt;br/&gt;        &lt;span&gt;// 参数传入Service，进行验证&lt;/span&gt;&lt;br/&gt;        auth.userDetailsService(userService);&lt;br/&gt;    }&lt;br/&gt;&lt;br/&gt;    &lt;span&gt;@Override&lt;/span&gt;&lt;br/&gt;    &lt;span&gt;protected&lt;/span&gt; void configure(&lt;span&gt;HttpSecurity&lt;/span&gt; http) &lt;span&gt;throws&lt;/span&gt; &lt;span&gt;Exception&lt;/span&gt; {&lt;br/&gt;        http.authorizeRequests()&lt;br/&gt;                .antMatchers(&lt;span&gt;&quot;/admin/**&quot;&lt;/span&gt;).hasRole(&lt;span&gt;&quot;admin&quot;&lt;/span&gt;)&lt;br/&gt;                .anyRequest().authenticated()&lt;br/&gt;                .and()&lt;br/&gt;                .formLogin()&lt;br/&gt;                .loginProcessingUrl(&lt;span&gt;&quot;/login&quot;&lt;/span&gt;).permitAll()&lt;br/&gt;                .and()&lt;br/&gt;                .csrf().disable();&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;这里着重配置SpringConfig&lt;/span&gt;&lt;/p&gt;&lt;h1 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;小结&lt;/span&gt;&lt;/h1&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span&gt;着重讲解了RBAC的权限配置，以及简单的使用SpringSecurity，以及使用SpringSecurity + JWT 完成前后端的分离，以及配置json登录，和密码加密方式。&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;blockquote data-type=&quot;2&quot; data-url=&quot;&quot; data-author-name=&quot;&quot; data-content-utf8-length=&quot;26&quot; data-source-title=&quot;&quot;&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;来自：&lt;/span&gt;&lt;span&gt;小小____&lt;/span&gt;&lt;/p&gt;&lt;p&gt;链接：https://segmentfault.com/a/1190000023052493&lt;/p&gt;&lt;/section&gt;&lt;/blockquote&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;- EOF -&lt;/span&gt;&lt;/p&gt;&lt;section donone=&quot;shifuMouseDownCard(&#x27;shifu_c_030&#x27;)&quot; label=&quot;Copyright Reserved by PLAYHUDONG.&quot;&gt;&lt;section&gt;&lt;span&gt;推荐阅读&lt;/span&gt;  &lt;span&gt;点击标题可跳转&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;amp;mid=2651518974&amp;amp;idx=1&amp;amp;sn=38f3a7f53f81cdc02055b69023c17f55&amp;amp;chksm=bd259b818a5212973597341eca6bc2c70504551a6568ff07c0008db973801a81ad1bc6e5ff7b&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;分布式系统中的时间&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;11&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;分布式系统中的时间&lt;/span&gt;&lt;/a&gt;&lt;br/&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;amp;mid=2651519102&amp;amp;idx=1&amp;amp;sn=b1fc420d394e32f1df2917ca41672c15&amp;amp;chksm=bd2594018a521d17782356c8c98a46bedb54cc1795aa87e3f4f2567f9bc4e215d3f6818ee00d&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;用小白都能看懂的大白话告诉你：什么是分布式计算系统？&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;11&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;用小白都能看懂的大白话告诉你：什么是分布式计算系统？&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;amp;mid=2651517516&amp;amp;idx=1&amp;amp;sn=c9ff2e2c6c6e12917aa1aaa50d957c2e&amp;amp;chksm=bd259e338a52172567bca96bf9e4959e0aa4b314d07356b867eca9f33d37aabc336e82cfbd0e&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;记一次自定义 Redis 分布式锁导致的故障&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot; hasload=&quot;1&quot;&gt;&lt;span&gt;记一次自定义 Redis 分布式锁导致的故障&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;看完本文有收获？请转发分享给更多人&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;关注「ImportNew」，提升Java技能&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.9166666666666666&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg&amp;amp;wxfrom=5&amp;amp;wx_lazy=1&amp;amp;wx_co=1&quot; data-type=&quot;jpeg&quot; data-w=&quot;600&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span/&gt;&lt;span&gt;点赞和在看就是最大的支持&lt;/span&gt;&lt;span&gt;❤️&lt;/span&gt;&lt;span/&gt;&lt;/p&gt;&lt;/div&gt;

          

          
          &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>6ce9a31113171106acdd804a4abb71dc</guid>
<title>今天不写代码，聊聊热门的知识图谱技术</title>
<link>https://toutiao.io/k/xcu8n0i</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-tool=&quot;mdnice编辑器&quot; data-website=&quot;https://www.mdnice.com&quot;&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;哈喽大家好啊，我是Hydra。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;前一段时间，boss交给我个任务，让我调研一下知识图谱技术。虽说有点NLP的底子，不过研究起这个来还是满头的包，终于还是在搜集了不少资料后划拉出来50多页的PPT，那么今天就浅浅的给大家分享一下知识图谱的相关知识。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;概述&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;诞生&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识图谱的概念诞生于2012年，由谷歌公司首先提出。大家都知道，谷歌是做搜索引擎的，所以他们最早提出了&lt;code&gt;Google Knowledge Graph&lt;/code&gt;后，首先利用知识图谱技术改善了搜索引擎核心。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;注意上面的说法，虽然知识图谱诞生于2012年，但其实在更早的时间它还有另外一个名字，那就是&lt;strong&gt;语义&lt;/strong&gt;。那么语义又是什么呢？引用《统计自然语言处理基础》中的两句话来解答这个问题：&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;语义可以分成两部分，研究单个词的语义（即词义）以及单个词的含义是怎么联合起来组成句子（或者更大的单位）的含义。&lt;/p&gt;&lt;p&gt;语义研究的是词语的含义、结构和说话的方式。&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;那么，知识图谱究竟是个什么东西呢？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;你可以将它理解为是&lt;strong&gt;在自然界建立实体关系&lt;/strong&gt;的知识数据库，它的提出是为了准确地阐述人、事、物之间的关系。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;目前在学术界还没有给知识图谱一个统一的定义，但是在谷歌发布的文档中有明确的描述：&lt;strong&gt;“知识图谱是一种用图模型来描述知识和建模世界万物之间关联关系的技术方法”&lt;/strong&gt;。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;演进&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;谷歌的Singhal博士用三个词点出了知识图谱加入之后搜索发生的变化：&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;“Things，not string.”&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这寥寥的几个单词，点出了知识图谱的核心。以前的搜索，都是将要搜索的内容看作字符串，结果是和字符串进行匹配，将匹配程度高的排在前面，后面按照匹配度依次显示。而利用知识图谱之后，将搜索的内容不再看作字符串，而是看作客观世界的事物，也就是一个个的个体。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;举个例子，当我们在搜索比尔盖茨的时候，搜索引擎不是搜索“比尔盖茨”这个字符串，而是搜索比尔盖茨这个人，围绕比尔盖茨这个人，展示与他相关的人和事。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5070052539404554&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PDpssaCXRFmYNRBlgKdT0FxZuEEPg6v9CkHWhRTibI5ECThSChEf2LOQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1142&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在上面的图中，左侧百科会把比尔盖茨的主要情况列举出来，右侧显示比尔盖茨的微软产品和与他类似的人，主要是一些IT行业的创始人。这样，一个搜索结果页面就把和比尔盖茨的基本情况和他的主要关系都列出来了，搜索的人很容易找到自己感兴趣的结果。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;三要素&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在知识图谱中，通过三元组 &lt;strong&gt;&amp;lt;实体 × 关系 × 属性&amp;gt;&lt;/strong&gt; 集合的形式来描述事物之间的关系：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;实体：又叫作本体，指客观存在并可相互区别的事物，可以是具体的人、事、物，也可以是抽象的概念或联系，实体是知识图谱中最基本的元素&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;关系：在知识图谱中，边表示知识图谱中的关系，用来表示不同实体间的某种联系&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;属性：知识图谱中的实体和关系都可以有各自的属性&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这里所说的实体和普通意义上的实体略有不同，借用NLP中本体的概念来理解它会比较好：&lt;/p&gt;&lt;blockquote data-tool=&quot;mdnice编辑器&quot;&gt;&lt;p&gt;本体定义了组成&lt;strong&gt;主题领域&lt;/strong&gt;的词汇表的&lt;strong&gt;基本术语&lt;/strong&gt;及其&lt;strong&gt;关系&lt;/strong&gt;，以及结合这些术语和关系来定义词汇表外延的&lt;strong&gt;规则&lt;/strong&gt;。&lt;/p&gt;&lt;/blockquote&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;例如我们要描述&lt;strong&gt;大学&lt;/strong&gt;这一领域时，对它来说&lt;strong&gt;教工&lt;/strong&gt;、&lt;strong&gt;学生&lt;/strong&gt;、&lt;strong&gt;课程&lt;/strong&gt;就是相对比较重要的概念，并且教工和学生之间也存在一定的关联关系，此外对象之间还存在一定的约束关系，例如一个系的教职员工数量不能少于10人。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在了解了上面的三元组后，我们可以基于它构建下面这样的一个关系：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6045918367346939&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PObvT1Q7GGgQRqAgyQVKWz7NAHkU3ibgWKoveWJibKnHTexyZVzvK8p6Q/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;784&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;可以看到，女王和王储通过母子关系关联在一起，并且每个人拥有自己的属性。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当知识图谱中的节点逐渐增多后，它的表现形式就会类似于化学分子式的结构，一个知识图谱往往存在多种类型的实体与关系。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.3772609819121447&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5Pdvq8icVOgsCnMfVv78oHG4yASggwWePPWgBS6lSIldU8mq6qcibWc4cQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;774&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识图谱将非线性世界中的知识信息进行加工，做到这样的结构化、可视化，从而辅助人类进行推理、预判、归类。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;到这里，可以简单概括一下知识图谱的基本特征：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;知识结构网络化&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;网络结构复杂&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;网络由三元组构成&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;数据主要由知识库承载&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;场景&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;搜索&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;前面提到过，以前的搜索引擎是从海量的关键词中找出与查询匹配度最高的内容，按照查询结果把排序分值最高的一些结果返回给用户。在整个过程中，搜索引擎可能并不需要知道用户输入的是什么，因为系统不具备推理能力，在精准搜索方面也略显不足。而基于知识图谱的搜索引擎，除了能够直接回答用户的问题外，还具有一定的语义推理能力，大大提高了搜索的精确度。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;推荐&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在传统的推荐系统中，存在两个典型问题：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;数据稀疏问题：在实际应用场景中，用户和物品的交互信息往往是非常稀疏的，预测会产生过拟合风险&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;冷启动问题：对于新加入的用户或者物品，由于系统没有其历史交互信息，因此无法进行准确地建模和推荐&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;例如，在一个电影类网站中可能包含了上万部电影，然而一个用户打过分的电影可能平均只有几十部。使用如此少量的已观测数据来预测大量的未知信息，会极大地增加算法的过拟合风险。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;因此在推荐算法中会额外引入一些辅助信息作为输入，这些辅助信息可以丰富对用户和物品的描述，从而有效地弥补交互信息的稀疏或缺失。在各种辅助信息中，知识图谱作为一种新兴类型的辅助信息，这几年的相关研究比较多。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;下面就是一个基于知识图谱的推荐例子：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4383561643835616&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5P2FEUycicwbplA6ACIVicsbnZDZ9j3hzDEc46bh4ic80OR3m5FDVmeBrEA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;949&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在将知识图谱引入推荐系统后，具有以下优势：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;精确性：知识图谱为物品引入了更多的语义关系，可以深层次地发现用户兴趣&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;多样性：知识图谱提供了实体之间不同的关系连接种类，有利于推荐结果的发散，避免推荐结果局限于单一类型&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;可解释性：知识图谱可以连接用户的历史记录和推荐结果，从而提高用户对推荐结果的满意度和接受度，增强用户对推荐系统的信&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;此外，知识图谱技术还在问答与对话系统、语言理解、决策分析等多个领域被广泛应用，它被挂载在这些系统之后，充当背景知识库的角色。总的来说，在这些场景下的应用，可以概括整个AI的发展趋势，就是从&lt;strong&gt;感知&lt;/strong&gt;到&lt;strong&gt;认知&lt;/strong&gt;的一个过程。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;架构&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识图谱的构建目前已有一套比较完善的架构体系，可以先来看一下下面这张图，然后我们再慢慢解释：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5061295971978984&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5Pjliar3cvs99KsfmoHHbESvyLrcfYxtPVzdxLLN0WkDPQWicLxRRia3ghQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1142&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;总的来说，整体过程可以分为下面5步：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;1.数据获取：主要获取半结构化数据，为后续的实体与实体属性构建做准备。结构化数据则为数值属性做准备&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;2.知识获取：从文本数据集中自动识别出命名实体，包括抽取人名、地名、机构名等；从语料中抽取实体之间的关系，形成关系网络；从不同的信息源中采集特定的属性信息&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;3.知识融合：完成指示代词与先行词的合并；完成同一实体的歧义消除；将已识别的实体对象，无歧义地指向知识库中的目标实体&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;4.知识加工：构建知识概念模块，抽取本体；进行知识图谱推理，并对知识图谱的可信度进行量化评估，评估过关的知识图谱流入知识图谱库中存储，评估不过关的知识图谱返回一开始的数据环节进行调整，而后重复相同环节直到评估过关&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;5.知识存储与计算：存储是为了快速查询与运用知识，需支持底层数据描述与上层计算，有的主体计算包含在存储中&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;下面，我们拆解其中部分重要核心细节，来具体描述。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;知识获取&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;数据是知识图谱的根基，直接关系到知识图谱构建的效率和质量。所以我们先从数据源进行分析它们的优势与劣势：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;站内数据：优势在于类别明确，结构化好，易于获取；而劣势在于类型有限，已有数据并不是广义上的知识类型&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;垂直网站数据：优势在于类别明确；而劣势在于获取解析成本高，数据质量参差不齐&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;百科类网站数据：优势在于数据量大，内容丰富；而劣势在于没有分类信息，结构不完全固定&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;人工创建的数据：优势在于类别明确；而劣势在于类别明确&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;实体抽取&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;实体抽取，是指从数据中识别和抽取实体的属性与关系信息，这一过程还是针对不同结构的数据来看：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;结构化数据：包括站内/垂直网站信息、部分百科网站信息，可以利用策略模式，将抽取的具体规则用groovy脚本来实现&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;半结构化数据：包括百科网站中的表格以及列表，可以利用基于监督学习的包装器归纳方法进行抽取&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;非结构化数据：包括百科网站中的文本以及站内文本，可以利用自然语言处理的手段处理&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;关系抽取&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;回顾一下我们前面提到过的知识图谱三要素，分别是实体、关系和属性。关系抽取我们同样可以用一个三元组表示的&lt;code&gt;RDF graph&lt;/code&gt;：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5430579964850615&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PeKGnz4oeKicY7Z4qf6xZZOB7CeNhuyC0qPsMeBtjD7jbRlX6BstdExw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;569&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这样的一个（S,P,O）三元组，就可以将一份知识分解为主语、谓语、宾语。这样的SPO结构，在配合知识图谱进行存储时可以被用来当做存储单元。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在RDF中可以声明一些规则，从一些关系推导出另一些关系，这些规则被称为&lt;code&gt;RDF Schema&lt;/code&gt;。规则可以用一些词汇表示，如&lt;code&gt;class&lt;/code&gt;、&lt;code&gt;subClassOf&lt;/code&gt;、&lt;code&gt;type&lt;/code&gt;、&lt;code&gt;property&lt;/code&gt;、&lt;code&gt;subPropertyOf&lt;/code&gt;、&lt;code&gt;domain&lt;/code&gt;、&lt;code&gt;range&lt;/code&gt;等。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;下面这个例子中，节点到节点之间的关系就可以理解为前面提到的本体中的联系，而这一关联过程就可以被称为知识图谱中的推导或关联推理：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.3639661426844015&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5P8lVxxbyAHTCEepRIkFC4dBkRpF1WGQibM3ibbkGYH4CQMVSDPa5iaqVlQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;827&quot;/&gt;&lt;/figure&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;知识融合&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识融合这一过程中，主要包括指代消解、实体对齐、实体链接等过程，我们主要来看一下这个过程中比较重要的实体对齐（Object Alignment）。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;完成实体抽取后，存在实体ID不同但代表真实世界中同一对象的情况。知识融合即是将这些实体合并成一个具有全局唯一标识的实体对象，添加到知识图谱中。&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;首先在索引中根据名字、别名等字段查询出若干个可能是相同实体的候选列表，这个步骤的目的是减少接下来流程的计算量&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;然后经过实体判别模型，根据模型得分识别出待合并对齐的原始实体&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;最后经过属性融合模型，将各原始实体的属性字段进行融合，生成最终的实体。&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;这一过程可以用下面的图来表示：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img data-ratio=&quot;0.3132411067193676&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PC4Pic6O6wGfqlQIesWdFNy2WEtwbhBWH0nqJhIcDuwSMhsuPAiaNHbew/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1012&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;实际上，这个流程中的合并判断模型大家都比较熟悉，它就是通过机器学习训练生成的二分类器。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;知识图谱构建与补全&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识图谱普遍存在不完备的问题，在这一步需要做的，就是基于图谱里已有的关系，去推理出缺失的关系。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在下面的这张知识图谱的实体网络中，黄色的箭头表示已经存在的关系，红色的虚线则是缺失的关系。我们可以根据实体之间的关系，来补全缺失的e3到e4之间的关系。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5115740740740741&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PanS2ajaSbAJJKWK2wSWGIe1XcaynT5PBRTzZOEPP9jkWarFLbDF1Iw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;864&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;至于这一补全的过程，有很多现成的算法可以使用，例如基于路径查找的方法，基于强化学习的方法，基于推理规则的方法，基于元学习的方法等等。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;知识存储&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;知识图谱的存储依赖于图数据库及其引擎，不同厂商的实现可能大有不同，例如可以选用的图数据库有RDF4j、Virtuoso、Neo4j等。例如爱奇艺的图数据库引擎选择了JanusGraph，借助云平台的Hbase和ES集群，搭建了自己的JanusGraph分布式图数据库引擎。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.4588500563697858&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5POLNy8EoxweGklrGMFhq0m2cqnJa8dT3Oa0oxfPybWhianm20PN0OMQQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1774&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;JanusGraph通过借助外部的存储系统与外部索引系统的支持，支撑了上游的在线查询服务。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;补充&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;底层存储数据三元组的逻辑层次可以被称为数据层，通常通过本体库来管理数据层，本体库的概念相当于对象中“类”的概念。而建立在数据层之上的模式层，是知识图谱的核心，它借助本体库来管理公理、规则和约束条件，规范实体、关系、属性这些具体对象间的关系。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;从不同的视角去审视知识图谱，可以更方便我们对其进行了解：&lt;/p&gt;&lt;ul data-tool=&quot;mdnice编辑器&quot; class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;section&gt;在Web视角下，知识图谱如同简单文本之间的超链接一样，通过建立数据之间的语义链接，支持语义搜索&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;在自然语言处理视角下，知识图谱就是从文本中抽取语义和结构化的数据&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;在知识表示视角下，知识图谱是采用计算机符号表示和处理知识的方法&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;在人工智能视角下，知识图谱是利用知识库来辅助理解人类语言的工具&lt;/section&gt;&lt;/li&gt;&lt;li&gt;&lt;section&gt;在数据库视角下，知识图谱是利用图的方式去存储知识的方法&lt;/section&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;下面，就是一张构建完备后，比较易于我们理解的知识图谱举例：&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6437054631828979&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PcMa2ic9Q6ibj40nSXlA1PscSd5QBLtVr4blxUbicjBbUyVaqaGZnCOXZA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;842&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;看到这里，是不是感觉知识图谱的构建过程比较复杂，让我们难于上手？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;其实近些年来，深度学习和相关自然语言处理技术的迅猛发展使得非结构化数据的自动知识抽取少人化、乃至无人化成为了可能，现在已经提出了一些前沿的知识图谱自动构建技术。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在深度学习的基础上，艾伦人工智能实验室和微软的研究人员结合自然语言处理领域较为成功的预训练语言模型，提出了自动知识图谱构建模型 COMET（COMmonsEnse Transformers）。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.9082802547770701&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PPzWVeHNWfASZEcvI6Lu9nxWSZibCwMOlf0xCns6C6KnKnVcGqez7VtQ/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;785&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;该模型可以根据已有常识库中的自然语言内容自动生成丰富多样的常识描述，在 Atomic 和 ConcepNet 两个经典常识图谱上都取得了接近人类表现的高精度，证明了此类方法在常识知识图谱自动构建和补全方面替代传统方法的可行性。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;难点&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;数据治理困难&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;数据治理为知识图谱输送数据源，是知识图谱构建的前置环节与基础性工程。完备良好的数据治理不仅能确保知识图谱在搭建过程中获取真实可靠的数据原料，而且能从源头上改善信息质量，提升知识的准确度，建立符合人类认知体系的数据资源池。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;但是，数据治理在知识图谱建设卡点中是一个老生常谈的问题。知识图谱应用始终要围绕数据标签、数据清洗、数据归一、数据销毁等数据治理环节展开，应用开发人员往往需要在前期的数据治理工作中投入大量时间和人力，以确保数据源的真实性、可靠性、可用性、正确性。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;当前，数据标准不统一、数据噪声大、领域数据集缺失、数据可信度异常等数据治理难题依然困扰着知识图谱研发者，持续进行数据治理工程是业内参与者艰巨的使命与职责。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;专家缺乏&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;目前知识图谱行业整体处于开发资源待完善的局面，行业与技术专家资源稀缺属于其中的一部分情况。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;一方面，缺少具备深厚行业经验的专家。由于行业知识图谱与行业的关联度高，开发人员需要迅速了解业务与客户需求，在行业专家的指导下完成Schema构建，若涉及到文本抽取工作还需要行业专家进行数据标注，而各行各业中的行业专家往往仅有极少数。对此，供给方企业需要锁定行业业务的强项领域、提前招募培养行业专家、进行内外协作，以完成行业专家储备。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;另一方面，缺少技术复合型专家。整个知识图谱应用生产流程不仅涉及知识图谱算法，生产流程的靠前环节还涉及到底层的图数据存储与数据治理、NLP文本抽取和语义转换，同时各环节都渗透着机器学习这一底层人工智能技术。这意味着整个生产流程需要多个技术领域的工程师协同合作，而对整套技术均有了解的技术专家数量稀缺。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;底层存储&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;由于知识图谱是二维链接的图结构而非行或列的表结构，其需以图数据的形式描述并存储，该方式能直接反应知识图谱的内部结构，有利于知识查询，结合图计算算法进行知识的深度挖掘与推理。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;满足这一存储要求的数据库为近几年兴起的图数据库。相比于传统的关系型数据库，图数据库的数据模型以节点和边来体现，可大大缩短关联关系的查询执行时间，支持半结构化数据存储，展示多维度的关联关系。高效便捷的新技术往往意味着更高的研发门槛。&lt;/p&gt;&lt;h3 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;流程与算法&lt;span/&gt;&lt;/h3&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;在知识图谱的搭建过程中，仍然面临着各类算法难点，主要难点可归结为生产流程中的算法难点和算法性能上的难点。前者体现为知识获取受数据集限制、知识融合干扰因素较多、知识计算的数据集与算力不足等问题。&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;而后者体现为算法泛化能力不足、鲁棒性不足、缺乏统一测评指标等问题。算法上的难点有赖于供需双方、学术界、政府持续攻坚，而非一方努力即可收获成功。&lt;/p&gt;&lt;h2 data-tool=&quot;mdnice编辑器&quot;&gt;&lt;span/&gt;&lt;span&gt;最后的碎碎念&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;/h2&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;拖了好久没有更文，不知道大家有没有很期待~&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;其实我这里也已经存了不少文章的选题了，奈何最近工作上实在比较繁忙，下班时间基本上也都在配小肥羊玩，所以没有什么时间更文。就像这篇文章，也是我正在出差的高铁上，根据前几天汇报的PPT整理而成。&lt;/p&gt;&lt;figure data-tool=&quot;mdnice编辑器&quot;&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.562390158172232&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/zpom4BeZSicbxpibp8PTxbqUUOwiahxJp5PVfFmJoWRvKluTg8K706SSDBrQb9lpGd1C6kVFNrqYcQZMtHMVUtmlg/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;2276&quot;/&gt;&lt;/figure&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;怎么样，沿途的风景，是不是还可以？&lt;/p&gt;&lt;p data-tool=&quot;mdnice编辑器&quot;&gt;那么，这次的分享就到这里，我是Hydra，我们下篇再见。&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>23b92e949854ae366124473882571ed1</guid>
<title>整整修了6个小时，一次难料的分页慢查询事故……</title>
<link>https://toutiao.io/k/dqo2zr0</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;section data-role=&quot;paragraph&quot;&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;68&quot; data-backw=&quot;578&quot; data-galleryid=&quot;&quot; data-ratio=&quot;0.11849710982658959&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ufWcjcomw8b6Lib0A0eic09h7UM0oewibib4JBPLkw1Mvb2p6sOzeHRtSHexOpy15TTJxdbibwBu97iamYXeGnEAfibOw/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1038&quot;/&gt;&lt;/p&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot;&gt;&lt;mp-common-profile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzkwOTIxNDQ3OA==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/ufWcjcomw8YRIaicYx5pzj5Cxwick8DamnOgbTJu96QTibKyHEDZt1815yOV1r27oZ6HgoYTEYWYLRz4jIV4iasHgg/0?wx_fmt=png&quot; data-nickname=&quot;dbaplus社群&quot; data-alias=&quot;dbaplus&quot; data-signature=&quot;围绕Database、BigData、AIOps的企业级专业社群。资深大咖、技术干货，每天精品原创文章推送，每周线上技术分享，每月线下技术沙龙，每季度Gdevops&amp;amp;DAMS行业大会.&quot; data-from=&quot;0&quot; data-is_biz_ban=&quot;0&quot;/&gt;&lt;/section&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86122&quot; data-custom=&quot;#138bde&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;一、事故背景&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;这次事故也是我们组里遇到的一次关于分页慢查询的典型例子，通过这篇文章，你可以很清晰地跟随我们还原事故现场，以及每一步遇到问题做出的调整和改动。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86122&quot; data-custom=&quot;#138bde&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;二、事故问题现场&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;157&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.27175208581644816&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOyz8gCrHzvAbs4f7qzfuT1Dbmm7fZCpTZhtxT5nC9tr8cjObZZ6LPNyQ/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1678&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;159&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.2754491017964072&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOyKeGiaoKp0OdyNkiaicDHyeZxg8iaDZvzpceia4IKR65BzM3M940icV7RAWAQ/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1670&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;257&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.44471153846153844&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOygH6DzQjlsItibdxnOEaGISSqrOeqg82hDFEBBMb7G2j5fUL1EOYFia8w/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1664&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;276&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.47688243064729197&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOypVE5NFB7z3BBOv9fU2Yibsm0pZ2LKxHQ2nz5VCUJqYqvG93Wo6L4CgA/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1514&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;定位到这里，我们基本确定这个不是几分钟能解决的问题，于是我们分成两步去处理。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;ul class=&quot;list-paddingleft-1&quot;&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;第一步：打开限流，防止更多的慢sql请求进行&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;span&gt;第二步：分析慢sql，进行改造上线&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;查看慢SQL，⼤部分都是融合系统分⻚查询接⼝涉及到的SQL，同时由于上游系统在15:35左右对于该接⼝调⽤流量激增，和数据库CPU暴涨，接⼝TP999暴涨的时间吻合，推测是由于库存对于该接⼝的调⽤对于数据库造成了压⼒，导致接⼝耗时增加。但是该接⼝的调⽤量并不⾼，再次查看慢SQL，发现有⼤量已经遍历到⼏百⻚的慢SQL。推测是深分⻚的问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;327&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.5660847880299252&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOyGwmHl87WQmFibCumicZV46DLpibjsiawZxicbuIOibwtBAFaYUPaoXlIuDZg/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1604&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86122&quot; data-custom=&quot;#138bde&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;三、问题原因和解决⽅法&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86152&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;span data-bgopacity=&quot;40%&quot;/&gt;&lt;span data-bgopacity=&quot;25%&quot;/&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;1、深分页出现原因&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;问题SQL：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;1000&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;以上⾯的SQL为例，MySQL的limit⼯作原理就是先读取前⾯1000条记录，然后抛弃前1000条，读后⾯100条想要的，所以⻚码越⼤，偏移量越⼤，性能就越差。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86152&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;span data-bgopacity=&quot;40%&quot;/&gt;&lt;span data-bgopacity=&quot;25%&quot;/&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;2、深分页的几种解决方法&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;1）查询ID+基于ID查询&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;即先使⽤查询条件查询出来id,再通过id进⾏范围查询，也就是说我第⼀次优化的时候使⽤的⽅法&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;⾸先查询出来ID，以上⾯的SQL为例&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;1000&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;然后查询出来id后，使⽤id进⾏in查询，由于是直接基于主键的in查询，所以效率较⾼&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;in&lt;/span&gt; (&lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;5&lt;/span&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;2）基于ID查询优化&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;由于在第⼀次查询已经查询出来了所有符合条件的ID了，可以使⽤范围查询来替代in查询，效率更⾼(in&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;查询需要和集合里面的元素进⾏⽐对，但是范围查询只需要⽐较最大和最小即可)&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt;= &lt;span class=&quot;code-snippet__number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;lt;= &lt;span class=&quot;code-snippet__number&quot;&gt;5&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;使用子查询&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; a.id,a.dj_sku_id,a.jd_sku_id &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; a &lt;span class=&quot;code-snippet__keyword&quot;&gt;join&lt;/span&gt; (&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;jd_spu_sku &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;1000&lt;/span&gt;,&lt;span class=&quot;code-snippet__number&quot;&gt;5&lt;/span&gt;) b&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;on&lt;/span&gt; a.id = b.id;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;使用子查询可以减少和数据库的IO交互，也是⼀种常⽤的解决深分页的⽅法。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;3）使用滚动查询&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;每次接⼝都会返回查询出来的数据的最⼤的id（游标），下⼀次查询传⼊这个游标，服务端只需要根据&lt;span&gt;这个游标，取出id⼤于这个游标的n个数据即可。n为每⻚展示条数。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;10&lt;/span&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;这种⽅式服务端实现起来⽐较简单且性能很好。缺点是需要客户端修改，且需要保证ID是自增有序且结&lt;span&gt;果需要是按照ID排序的。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;span&gt;最终定下的是使用滚动查询的方法。&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;最终优化SQL上线后，表现平稳。第⼆周和库存⼀起重新优化了⾮多规格SKU的SQL。如下：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt;,dj_org_code,dj_sku_id,jd_sku_id,yn &lt;span class=&quot;code-snippet__keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;500&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;测试了没问题后上线。观察线上监控稳定。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;本以为高枕无忧的时候，⼀周之后，数据库再次出现了⼤量的慢查询，数据库CPU报警，观察接⼝监控:&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可以看到在调用量并不⼤的前提下，接⼝的耗时达到了60S。联系运维同学帮忙排查，发现了大量的慢&lt;span&gt;SQL：&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt;,dj_org_code,dj_sku_id,jd_sku_id,yn &lt;span class=&quot;code-snippet__keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;500&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;可以看出来，这就是我们优化后的SQL。运维同学explain这条sql后发现，这条SQL⾛了主键索引，没&lt;span&gt;有⾛我们以为应该要⾛的org_code的索引。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;和运维初步沟通后得出结论，在某些情况下，主键索引的优先级是会⾼于普通索引的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86122&quot; data-custom=&quot;#138bde&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;四、最终解决方案&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86152&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;span data-bgopacity=&quot;40%&quot;/&gt;&lt;span data-bgopacity=&quot;25%&quot;/&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;1、引用join&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;因为我们使用了&lt;span&gt;主键索引进⾏排序，且查询了不在索引树只在叶子节点中的字段。因此mysql认为主键索引更优，因为既可以排序，⼜不⽤回表，所以就使⽤主键索引最终导致了全表扫描。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;最终使用了先查询ID（不查询叶子节点字段保证使⽤索引），在通过join，使用查询出来的ID来查询对&lt;span&gt;应的数据的SQL：&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;select&lt;/span&gt; a.id &lt;span class=&quot;code-snippet__keyword&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt;,a.dj_org_code &lt;span class=&quot;code-snippet__keyword&quot;&gt;AS&lt;/span&gt; djOrgCode,a.dj_sku_id &lt;span class=&quot;code-snippet__keyword&quot;&gt;AS&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;djSkuId,a.jd_sku_id &lt;span class=&quot;code-snippet__keyword&quot;&gt;AS&lt;/span&gt; jdSkuId,a.yn &lt;span class=&quot;code-snippet__keyword&quot;&gt;AS&lt;/span&gt; yn &lt;span class=&quot;code-snippet__keyword&quot;&gt;from&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; a &lt;span class=&quot;code-snippet__keyword&quot;&gt;join&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;(&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;order&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;code-snippet__number&quot;&gt;500&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;) t &lt;span class=&quot;code-snippet__keyword&quot;&gt;on&lt;/span&gt; a.id=t.id;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;再次explain了下，可以发现⾛了我们既定的索引：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;161&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.27804295942720764&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOyuJILWRtnhZMxwBydktnPkQDRD7ey0uuK7saNqX99GCw6SwGHJ07ib8w/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1676&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;于是上线，解决问题。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;上线稳定后，分析之前的问题SQL，执⾏下⾯两条语句，同样的SQL，不同的商家，MYSQL的执⾏结果也是不⼀样的。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-backh=&quot;138&quot; data-backw=&quot;578&quot; data-ratio=&quot;0.2395709177592372&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz/ufWcjcomw8aED1RvkicFS1cFibzsvmWjOyXcKjSQuewD7xGJdibqgSgDic9IQr1qnpickERRBLXDm4EB7z2G0GiaeEJQ/640?wx_fmt=other&quot; data-type=&quot;other&quot; data-w=&quot;1678&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86152&quot; draggable=&quot;true&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;span data-bgopacity=&quot;40%&quot;/&gt;&lt;span data-bgopacity=&quot;25%&quot;/&gt;&lt;span/&gt;&lt;/section&gt;&lt;section&gt;&lt;section data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;2、查询资料找原因&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;查阅资料得知：&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;/&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;section class=&quot;code-snippet__fix code-snippet__js&quot;&gt;&lt;pre class=&quot;code-snippet__js&quot; data-lang=&quot;sql&quot;&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt;,dj_org_code,dj_sku_id,jd_sku_id,yn &lt;span class=&quot;code-snippet__keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;force&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__keyword&quot;&gt;index&lt;/span&gt;(idx_upc) &lt;span class=&quot;code-snippet__keyword&quot;&gt;where&lt;/span&gt; org_code = xxxx &lt;span class=&quot;code-snippet__keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &amp;gt; &lt;span class=&quot;code-snippet__number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;code-snippet__keyword&quot;&gt;limit&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;br/&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;span class=&quot;code-snippet_outer&quot;&gt;&lt;span class=&quot;code-snippet__number&quot;&gt;500&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/section&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;但是这种写死了索引名称的⽅式，如果以后修改了索引名，容易导致安全隐患。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-tools=&quot;135编辑器&quot; data-id=&quot;86122&quot; data-custom=&quot;#138bde&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;p data-brushtype=&quot;text&quot;&gt;&lt;span&gt;&lt;strong&gt;五、问题总结&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;p&gt;&lt;span&gt;1）B端系统也需要考虑对自己系统的保护，接⼊限流等，防止异常流量或者异常调用把自己的系统调&lt;span&gt;死。这次幸亏上游系统是通过MQ调⽤融合API的，可以暂停消费，如果是⽤API调⽤，且流量较⼤，持续让数据库处于⾼压状态，会影响到融合系统的整体稳定性。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;p&gt;&lt;span&gt;2）针对可能出现的风险点绝不姑息。这次这个分页查询sku的接⼝，之前就看到过，但是当&lt;span&gt;时觉得这个接⼝在数据量较少的情况下性能也还好，而且也有了商家维度的索引，就放过了，考虑后续优化。结果现在就爆出了问题。&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;p&gt;&lt;span&gt;3）针对SQL的优化，上线前要谨慎，而且需要同⼀条SQL，需要针对不同的边界情况（例如这次的多SKU的商家）进⾏反复测试，调整。&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-role=&quot;list&quot;&gt;&lt;section&gt;&lt;span&gt;作者丨树洞君&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;来源丨网址：https://juejin.cn/post/7126356005192990750&lt;/span&gt;&lt;/section&gt;&lt;section&gt;&lt;span&gt;dbaplus社群欢迎广大技术人员投稿，投稿邮箱：editor@dbaplus.cn&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.36086956521739133&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_jpg/ufWcjcomw8YY6J547ZhgwY87vBia8l2ic7vAeqPaIJicV0RiacMHFOs2HBwzojCN94ROMWN3hCF1Z5DAwEaibibQSLxQ/640?wx_fmt=jpeg&quot; data-type=&quot;jpeg&quot; data-w=&quot;1150&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.07734375&quot; data-s=&quot;300,640&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/ufWcjcomw8Zf2jiaBBH3vdgfP4A2rem5YEAHYH074dc4GibhojA5B3lLZrXLDRciaVnficveaHcAUCiaIPoDsTkAduA/640?wx_fmt=png&quot; data-type=&quot;png&quot; data-w=&quot;1280&quot;/&gt;&lt;/p&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>065c0c2cdd74556545fa1c888de428b3</guid>
<title>linux下使用tc控制和模拟网络流量</title>
<link>https://toutiao.io/k/gqlyhft</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;column&quot;&gt;
&lt;p&gt;在 linux 中,TC 有二种控制方法 CBQ 和 HTB.HTB 是设计用来替换 CBQ 的。它是一个层次式的过滤框架.&lt;/p&gt;
&lt;p&gt;TC 包括三个基本的构成块:&lt;/p&gt;
&lt;p&gt;队列规定 qdisc(queueing discipline )、类(class)和分类器(Classifiers)&lt;/p&gt;
&lt;p&gt;TC 中的队列(queueing discipline):&lt;br/&gt;用来实现控制网络的收发速度.通过队列,linux 可以将网络数据包缓存起来,然后根据用户的&lt;/p&gt;
&lt;p&gt;设置,在尽量不中断连接(如 TCP)的前提下来平滑网络流量.需要注意的是,linux 对接收队列的控制不够好,所以我们一般只用发送队列,即“控发不控收”.它封装了其他两个主要 TC 组件(类和分类器)。内核如果需要通过某个网络接口发送数据包,它都需要按照为这个接口配置的 qdisc(排队规则)把数据包加入队列。然后,内核会 尽可能多地从 qdisc 里面取出数据包,把它们交给网络适配器驱动模块。&lt;/p&gt;
&lt;p&gt;最简单的 QDisc 是 pfifo 它不对进入的数据包做任何的处理,数据包采用先入先出的方式通过队列。不过,它会保存网络接口一时无法处理的数据包。&lt;br/&gt;队列规则包括 FIFO(先进先出),RED(随机早期探测),SFQ(随机公平队列)和令牌桶(Token Bucket),类基队列(CBQ),CBQ 是一种超级队列,即它能够包含其它队列(甚至其它 CBQ)。&lt;/p&gt;
&lt;p&gt;TC 中的 Class 类&lt;br/&gt;class 用来表示控制策略.很显然,很多时候,我们很可能要对不同的 IP 实行不同的流量控制策略,这时候我们就得用不同的 class 来表示不同的控制策略了.&lt;/p&gt;
&lt;p&gt;TC 中的 Filter 规则&lt;br/&gt;filter 用来将用户划入到具体的控制策略中(即不同的 class 中).比如,现在,我们想对 xxa,xxb两个 IP 实行不同的控制策略(A,B),这时,我们可用 filter 将 xxa 划入到控制策略 A,将 xxb 划入到控制策略 B,filter 划分的标志位可用 u32 打标功能或 IPtables 的 set-mark (大多使用iptables 来做标记)功能来实现。&lt;br/&gt;目前,TC 可以使用的过滤器有:fwmark 分类器,u32 分类器,基于路由的分类器和 RSVP分类器(分别用于 IPV6、IPV4)等;其中,fwmark 分类器允许我们使用 Linux netfilter 代码选择流量,而 u32 分类器允许我们选择基于 ANY 头的流量 .需要注意的是,filter (过滤器)是在 QDisc 内部,它们不能作为主体。&lt;/p&gt;
&lt;p&gt;TC 的应用流程&lt;br/&gt;数据包-&amp;gt;iptables(在通过 iptables 时,iptables 根据不同的 ip 来设置不同的 mark)-&amp;gt;TC(class)-&lt;/p&gt;
&lt;p&gt;&amp;gt;TC(queue)&lt;/p&gt;
&lt;h2&gt;4. 应用举例&lt;/h2&gt;
&lt;p&gt;假设 eth0 位是服务器的外网网络接口。开始之前,先要清除 eth0 所有队列规则&lt;/p&gt;
&lt;p&gt;tc qdisc del dev eth0 root 2&amp;gt; /dev/null &amp;gt; /dev/null1) 定义最顶层(根)队列规则,并指定 default 类别编号&lt;/p&gt;
&lt;p&gt;tc qdisc add dev eth0 root handle 1: htb default 2&lt;/p&gt;










&lt;/div&gt;










&lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
<item>
<guid>c8a1c90b1ea53b1d67c18776d1e99156</guid>
<title>ARM架构的一次充电</title>
<link>https://toutiao.io/k/1kgpiwx</link>
<content:encoded>&lt;div&gt;&lt;div&gt;&lt;div class=&quot;rich_media_content                           autoTypeSetting24psection&amp;#10;                          &quot; id=&quot;js_content&quot;&gt;&lt;section class=&quot;mp_profile_iframe_wrp&quot; data-mpa-powered-by=&quot;yiban.io&quot;&gt;&lt;mp-common-profile class=&quot;js_uneditable custom_select_card mp_profile_iframe&quot; data-pluginname=&quot;mpprofile&quot; data-id=&quot;MzUxODkyODE0Mg==&quot; data-headimg=&quot;http://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr7asExq0Evsib5pHoD24M70jEAcyibfbqhMc6X4ZXy9ezVsmbY7Fictyz3GM6C3V7mu0KrenKlv0wwmw/0?wx_fmt=png&quot; data-nickname=&quot;小道安全&quot; data-alias=&quot;kdsafety&quot; data-signature=&quot;以安全开发、逆向破解、黑客技术、病毒技术、灰黑产攻防为基础，兼论程序研发相关的技术点滴分享。&quot; data-from=&quot;0&quot; data-is_biz_ban=&quot;0&quot;/&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;132&quot;&gt;&lt;section label=&quot;powered by wxb-style.com&quot;&gt;&lt;section data-id=&quot;86318&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;ARM架构基础&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;
&lt;/section&gt;&lt;p&gt; &lt;/p&gt;&lt;section&gt;&lt;strong&gt;ARM处理器使用精简指令集(RISC),&lt;/strong&gt;ARM（Advanced RISC Machines）ARM是一家公司的简称，其次ARM指一系列处理器的统称，同时ARM也是一种精简指令集架构。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5573366214549939&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZj2KtepwhvPXcdnDL5HMHgicxTRRMx4bRBFaCvOt9oL4Ribiaagnzsu9pIw/640?wx_fmt=png&amp;amp;random=0.530482253671585&amp;amp;random=0.67413364514766&amp;amp;random=0.23166023876641262&amp;amp;random=0.20487950915284858&amp;amp;random=0.1503127506195816&amp;amp;random=0.07192548923209618&quot; data-type=&quot;png&quot; data-w=&quot;811&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;Arm CPU构架由各种微构架进行实作，以提供各种功耗、性能以及面积组合的软件兼容性。&lt;/p&gt;&lt;p&gt;CPU构架定义基本指令集，以及操作系统和虚拟机管理器倚赖的例外处理和內存模型。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;CPU微构架由定义处理器的设计并涵盖以下内容以决定实作如何满足构架合约：功耗、性能、面积、管道长度及缓存等级。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;中央处理单元(CPU)主要由运算器、控制器、寄存器三部分组成，CPU有着处理指令、执行操作、控制时间、处理数据四大作用。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;当今处理器（CPU）一共有三个最强的架构，一个是以intel和AMD为代表的&lt;strong&gt;X86架构（CISC）&lt;/strong&gt;，一个是以手机、平板处理器所使用的&lt;strong&gt;ARM架构（RISC）&lt;/strong&gt;、最后一个我国龙芯处理器所选择的&lt;strong&gt;MIPS架构（RISC）&lt;/strong&gt;。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;ARM内核进行运算的核心部件是算术逻辑运算单元-ALU（arithmetic and logic unit）。它对两个操作数进行逻辑或者算术运算。为了提高嵌入式处理器的工作速度，以保证实时性的要求，ARM在处理器中尽可能多地设置了寄存器。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7001703577512777&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZjkZGgJPH97bHf7Sn8vqcmF4S55kHZYE2thTxSYllBau9LwP2bD0xyyg/640?wx_fmt=png&amp;amp;random=0.7354428074722308&amp;amp;random=0.8483282031232784&amp;amp;random=0.4727940658516685&amp;amp;random=0.12289023652268938&amp;amp;random=0.07697186401900691&amp;amp;random=0.5455133785732524&quot; data-type=&quot;png&quot; data-w=&quot;587&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;（图片来源网络）&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;架构（Architecture）指的是一系列的功能规范。ARM 架构 指的就是是基于 ARM 架构的处理器的功能规范，即 ARM CPU 架构。&lt;/p&gt;&lt;p&gt;微架构包含：总线、电源管理、缓存、ARM架构&lt;/p&gt;&lt;p&gt;AMR架构又称为ARM CPU架构，它包含：指令集、寄存器组、异常模型、内存模型、调试，跟踪和分析。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;Arm 架构的安全特性分为4类：防御性执行技术;隔离技术;通用平台安全服务;标准安全API。&lt;/strong&gt;&lt;/section&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;132&quot;&gt;&lt;section label=&quot;powered by wxb-style.com&quot;&gt;&lt;section data-id=&quot;86318&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;ARM体系架构发展&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;
&lt;/section&gt;&lt;p&gt; &lt;/p&gt;&lt;p&gt;ARM体系结构版本指的是ARM对应的各种指令集。从1985年ARMv1开始到2022年ARMV9，&lt;strong&gt;ARM体系结构定义了ARMv1~ARMv9共9个版本。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;分别为:ARMv1、ARMv2、ARMv3、ARMv4、ARMv5、ARMv6、ARMv7、ARMv8、ARMv9。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6818181818181818&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZjFsCpD1R3qfQ1ZoLZb4fhG87Gv30wia4HQyic2F2SlRzRKFqmd77cB42A/640?wx_fmt=png&amp;amp;random=0.3353926457130194&amp;amp;random=0.5323313465322266&amp;amp;random=0.08323435068067209&amp;amp;random=0.10413458276845344&amp;amp;random=0.8893623158286177&amp;amp;random=0.9658660211385144&quot; data-type=&quot;png&quot; data-w=&quot;660&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;(图片来源网络)&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv1、ARMv2 &lt;/strong&gt;这两代没有做CPU，没有商业化;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv3 &lt;/strong&gt;对应的 CPU 是 ARM6;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv4&lt;/strong&gt; 首次增加 Thumb 指令集;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv5&lt;/strong&gt; 改进了 Thumb，首次增加 E(增强型DSP指令)、J(Java加速器Jazelle);&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv6&lt;/strong&gt; 首次增加 SIMD，升级为 Thunmb-2，首次增加TrustZone;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv7&lt;/strong&gt; 首次增加 M(长乘法指令)，NEON(DSP+SIMD);&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMv8&lt;/strong&gt; 首次增加 指令集A64，可执行64位指令；可在 32位 和 64位 之间切换;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARMV9&lt;/strong&gt; 进阶SIMD与可扩展向量延伸指令集2(SVE2)、AArch32与AArch64、机密领域管理扩充。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;全新Armv9构架将形成下一波3,150亿个Arm构架芯片的领先优势。A系列构架的最新版本Armv9-A提供前所未有的最高性能，以及更高的安全性。&lt;/p&gt;&lt;p&gt;&lt;strong&gt;它主要特色包括：&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;进阶SIMD与可扩展向量延伸指令集2（SVE2）;AArch32与AArch64;机密领域管理扩充。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt; &lt;/p&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;132&quot;&gt;&lt;section label=&quot;powered by wxb-style.com&quot;&gt;&lt;section data-id=&quot;86318&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;ARM指令执行&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;ARM处理器(CPU)的字长是32位，则一条汇编指令的长度也是32位，也就是四个字节，而内存中一个地址单元是一个字节，也就是说一条指令要占据4个地址单元。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;在ARM的CPU中，一般一条指令的执行简单的划分为3部分:取指-&amp;gt;译码-&amp;gt;执行。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;在ARM的底层架构设计的术语中， CPU先进行fetch(取指令)，接着进行decode(译码)，然后进行excute(执行)，&lt;strong&gt;这也就是基于F D E的三步操作，才能完成CPU的运算，这种三步的完成称为三级流水。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;现在最新的ARM架构中已经扩展到5级的流水了: 取指-&amp;gt;译码-&amp;gt;执行-&amp;gt;存取-&amp;gt;保存结果.&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;在ARM架构中流水越多，过程越细，处理能力越强，可控制的情况也就越多，也就越复杂，一般来说，流水越多，也就说明体系架构越强大。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;分解指令过程：&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;1、&lt;/strong&gt;指令预读取(决定从内存的哪儿取指令)--perfetch&lt;/p&gt;&lt;p&gt;&lt;strong&gt;2、&lt;/strong&gt;指令读取(从内存系统中读取指令)--fetch&lt;/p&gt;&lt;p&gt;&lt;strong&gt;3、&lt;/strong&gt;指令译码(解读指令，并且生成控制信号)&lt;/p&gt;&lt;p&gt;&lt;strong&gt;4、&lt;/strong&gt;寄存器读取(提供寄存器的值给操作单元)&lt;/p&gt;&lt;p&gt;&lt;strong&gt;5、&lt;/strong&gt;分配(分配指令给执行单元，也就是分配给ALU)&lt;/p&gt;&lt;p&gt;&lt;strong&gt;6、&lt;/strong&gt;执行(实际的ALU单元处理)&lt;/p&gt;&lt;p&gt;&lt;strong&gt;7、&lt;/strong&gt;内存访问(数据的存取)&lt;/p&gt;&lt;p&gt;&lt;strong&gt;8、&lt;/strong&gt;寄存器回写(更新运行结果到寄存器)&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt; &lt;/p&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;132&quot;&gt;&lt;section label=&quot;powered by wxb-style.com&quot;&gt;&lt;section data-id=&quot;86318&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;ARM架构指令集&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM32共有37个32位寄存器，其中31个通用寄存器，6个状态寄存器。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;其中未分组寄存器R0-R7，分组寄存器R8-R14；&lt;/p&gt;&lt;p&gt;R0-R7被称为低寄存器组，R8-R15被称为高寄存器组;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R0-R12&lt;/strong&gt;是通用寄存器，用于存放通用数据;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R13&lt;/strong&gt;常用作存放堆栈指针，用户也可以使用其他寄存器存放堆栈指针，但在Thumb指令集下，某些指令强制要求使用R13存放堆栈指针。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R14&lt;/strong&gt;称为链接寄存器(LR全称Link Register)，当执行子程序时，R14可得到&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R15(PC)&lt;/strong&gt;寄存器的备份，执行完子程序后，又将R14的值赋值回PC寄存器，即使用R14保存返回地址。&lt;/p&gt;&lt;p&gt;R15称为程序计数器(PC)，在ARM状态下，位[1:0]为0，位[31:2]用于保存PC;在Thumb状态下,位[0]为0，位[31:1]用于保存PC。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R0-R3:&lt;/strong&gt; 一般用于函数参数及返回值的传递;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R4-R6, R8,R10-R11: &lt;/strong&gt;这些寄存器没有特殊规定，就是普通的通用寄存器;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R7: &lt;/strong&gt;栈帧指针(Frame Pointer)，指向前一个保存的栈帧(stack frame)和链接寄存器(link register)在栈上的地址;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R9: &lt;/strong&gt;操作系统保留;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R12: &lt;/strong&gt;称为IP(intra-procedure scratch);&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R13: &lt;/strong&gt;称为SP(stack pointer)，是栈顶指针，存储栈地址，程序跳转的时候，保存程序跳转的目标地址标识;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R14:&lt;/strong&gt;称为LR(link register)，链接寄存器，存放函数的返回地址;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;R15:&lt;/strong&gt;称为PC(program counter)，指向当前指令地址。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;str寄存器: &lt;/strong&gt;表示把寄存器内容存储到栈上;&lt;/p&gt;&lt;section&gt;&lt;strong&gt;ldr 寄存器：&lt;/strong&gt;表示把栈上内容载入到寄存器&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.6896918172157279&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZjmayXY5Q46KTY6XRQbTC87kdbrKjooe2p6sdGNuEn3kpPMOMgteYXpA/640?wx_fmt=png&amp;amp;random=0.48172778766325974&amp;amp;random=0.5332542480494264&amp;amp;random=0.4393082988415571&amp;amp;random=0.6276315028978543&amp;amp;random=0.4229143393990227&amp;amp;random=0.25250401918328524&quot; data-type=&quot;png&quot; data-w=&quot;941&quot;/&gt;&lt;/p&gt;&lt;p&gt;（图片来源网络）&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;在ARM64架构下, CPU提供了33个寄存器, 其中前31个(0~30)属于通用寄存器 (general-purpose integer registers)，最后2个(31,32)是专用寄存器（sp寄存器和pc寄存器)。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x0-x7:&lt;/strong&gt; 用于传递子程序的参数和返回值，使用时不需要保存，多余的参数用堆栈传递，64位的返回结果保存在x0中;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x8: &lt;/strong&gt;它是用于保存子程序的返回地址，使用时不需要保存;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x9-x15: &lt;/strong&gt;它是临时寄存器，也叫可变寄存器，子程序使用时不需要保存;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x16-x17: &lt;/strong&gt;子程序内部调用寄存器(IPx)，使用时不需要保存，尽量不要使用;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x18:&lt;/strong&gt; 它是平台寄存器, 它的使用与平台相关, 尽量不要使用;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x19-x28:&lt;/strong&gt; 它们是临时寄存器, 子程序使用时必须保存;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x29:&lt;/strong&gt; 它是帧指针寄存器(FP), 用于连接栈帧，使用时必须保存;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x30: &lt;/strong&gt;它是链接寄存器(LR), 用于保存子程序的返回地址;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;x31:&lt;/strong&gt; 它是堆栈指针寄存器(SP), 用于指向每个函数的栈顶;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM64该架构的 31 个通用寄存器中，每个寄存器都可用作 64 位 X 寄存器 (X0-X30)，或用作 32 位 W 寄存器 (W0-W30)。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;对于数据处理的指令，选择X或W决定操作的大小。使用X寄存器将用 64位计算，使用 W 寄存器将用32 位计算。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;例如执行32位整数加法:&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ADD W0, W1, W2&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;例如执行 64 位整数加法:&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ADD X0, X1, X2&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM64:  &lt;/strong&gt;A64 指令集是在 Armv8-A 中引入的，以支持 64 位架构。A64 指令集有固定的 32 位指令长度。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM32: &lt;/strong&gt;A32 指令集有固定的 32 位指令长度，并在 4 字节边界上对齐。A32 指令集就是在 Armv6 和 Armv7 架构中我们常说的 ARM 指令集，Armv8 及之后改名 A32 以与 A64 进行区分。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Thumb32: &lt;/strong&gt;T32 指令集最初是作为 16 位指令的补充集引入的，用于改进的用户代码的代码密度。随着时间的推移，T32 演变成 16 位和 32 位混合长度的指令集。32 指令集就是在在 Armv6 和 Armv7 架构中被我们所熟知的 Thumb 指令集，Armv8 及之后改名为 Thumb32。&lt;/p&gt;&lt;p&gt; &lt;/p&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;132&quot;&gt;&lt;section label=&quot;powered by wxb-style.com&quot;&gt;&lt;section data-id=&quot;86318&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section&gt;&lt;span&gt;ARM架构杂项&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM授权方式主要有三种：架构层级授权、内核层级授权、使用层级授权。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;其中指令集层级授权等级最高，企业就可以对ARM 指令集进行改造以实现自行设计处理器。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Arm 架构有2种异常类型:IRQ(外部中断异常)和FIQ(快速中断异常)&lt;/strong&gt;，旨在用于生成外设中断，在IRQ和FIQ都具有独立的路由控制，通常用于实现安全和非安全中断。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;在ARM中当发生异常时，会中断当前程序流程。处理元件 (PE) 将更新当前状态并分支到向量表中的某个位置。通常这个位置将包含通用代码，用于将当前程序的状态推送到堆栈上，然后分支到进一步的代码。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;异常产生的指令主要有2个:SWI和BKPT。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;SWI：软中断指令，产生软中断，处理器进入管理模式；&lt;/p&gt;&lt;p&gt;SWI 0 //产生软中断，中断立即数为0　&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;BKPT：断点中断指令，处理器产生软件中断；&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;ARM的异常模型主要细分为:&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;1、复位异常(Reset): &lt;/strong&gt;当处理器在工作时, 突然被按下重启键, 就会触发该异常;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;2、数据异常(Data Abort):&lt;/strong&gt; 当读取数据失败,就会触发数据异常;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;3、快速中断异常(FIQ): &lt;/strong&gt;快速中断要比普通中断响应速度要快一些;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;4、外部中断异常(IRQ): &lt;/strong&gt;普通中断;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;5、预取异常(Prefetch Abort):&lt;/strong&gt; 预取指令失败, ARM 在执行指令的过程中, 要先去预取指令准备执行，如果预取指令失败, 就会产生该异常;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;6、软中断异常(SWI): &lt;/strong&gt;软件中需要去打断处理器工作, 可以使用软中断来执行 ;&lt;/p&gt;&lt;p&gt;7、未定义指令异常(Undefined Instruction): 处理器无法识别指令的异常。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;ARM处理器的运行模式&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;运行不同的程序所需的硬件资源不同，因此ARM处理器它可以为不同程序提供7种不同的硬件资源组合，每一种硬件资源组合称为一种ARM的运行模式。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;1、USR(用户模式): ARM处理器正常程序执行模式;&lt;/p&gt;&lt;p&gt;2、FIQ(快速中断模式):用于高速数据传输或通道处理的执行模式;&lt;/p&gt;&lt;p&gt;3、IRQ(中断模式): 用于通用的中断处理的执行模式;&lt;/p&gt;&lt;p&gt;4、SVC(管理模式)：它是操作系统使用的保护模式;&lt;/p&gt;&lt;p&gt;5、ABT(终止模式)：当数据或指令预取出错时进入的模式;&lt;/p&gt;&lt;p&gt;6、SYS(系统模式)：运行具有特权的操作系统任务;&lt;/p&gt;&lt;section&gt;7、UND(未定义指令中止模式)：当处理器试图执行未定义指令时进入的模式。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.7654545454545455&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZjxZdo2djmt0ReGmh4PfWu5Ec2RZibHNtFeibiaB5S3xRuT4H8x2gicKnCmg/640?wx_fmt=png&amp;amp;random=0.9802458083717982&amp;amp;random=0.5112974057590736&amp;amp;random=0.9752958550026645&amp;amp;random=0.40199182784334453&amp;amp;random=0.8277417850031821&amp;amp;random=0.6705503595577473&quot; data-type=&quot;png&quot; data-w=&quot;550&quot;/&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;&lt;span&gt;&lt;strong&gt;ARM处理器工作状态&lt;/strong&gt;&lt;/span&gt;&lt;/section&gt;&lt;p&gt;从编程的角度来看，ARM微处理器的工作状态一般ARM和Thumb有两种，并支持在两种状态之间切换。&lt;/p&gt;&lt;p&gt;1、ARM状态：此时处理器执行32位的字对齐ARM指令，绝大部分工作在此状态。&lt;/p&gt;&lt;p&gt;2、Thumb状态：此时处理器执行16位的半字对齐的Thumb指令。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM处理器存储格式&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;ARM32体系结构将存储器看作是从0地址开始的字节的线性组合，它所支持的最大寻址空间为4GB。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;section&gt;用户空间(0—3G)，这段空间映射到物理内存的高端内存;&lt;/section&gt;&lt;section&gt;内核空间(3G—4G)，这段空间映射到低端内存，这段空间又分为以下4部分，它们分别为:&lt;/section&gt;&lt;section&gt;1、直接映射区(0—896M): 这段虚拟地址空间和低端内存地址存在线性的地址关系即虚拟地址3G+X = 物理地址X;&lt;/section&gt;&lt;section&gt;2、动态映射区(896—1016M): 这段空间具体映射到物理内存的什么位置不确定，该区域的地址由内核中的vmalloc来实现分配，其特点是虚拟地址空间连续，但是物理地址空间不一定连续。vmalloc函数返回的是虚拟地址，但是其映射的物理地址有可能在高端内存，也有可能在低端内存;&lt;/section&gt;&lt;section&gt;3、永久内存映射区(pkmap1016—1020M): 使用kmap函数将高端内存的地址映射到这部分区域，这样就可以通过这个虚拟地址来访问高端内存的地址。通过这4M的窗口可以重复映射所有的高端内存;&lt;/section&gt;&lt;section&gt;4、固定映射区(1020—1024M): 这4M的地址是有特定用途的固定地址，这4M的区域映射的物理内存作为ACPI电源管理等寄存器的地址。&lt;/section&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;ARM64架构处理器采用48位物理寻址，它最大可以支持256T的地址空间，但是虚拟地址依然采用64，虚拟地址远远大于物理地址。&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;所以在处理器架构设计上，把虚拟地址空间划分为3部分: 用户空间、非规范区、内核空间，其中内核空间和用户空间每个部分最大支持256T的访问。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;用户空间：（0x0000_0000_0000_0000——0x0000_FFFF_FFFF_FFFF）256T&lt;/p&gt;&lt;p&gt;内核空间：（0xFFFF_0000_0000_0000——0xFFFF_FFFF_FFFF_FFFF）256T&lt;/p&gt;&lt;p&gt;其余部分被称为非规范区域。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;strong&gt;内核空间又可细分为以下部分:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;1、Vmalloc区域：0xFFFF_0000_0000_0000——0xFFFF_7BFF_BFFF_0000（126974G）&lt;/p&gt;&lt;p&gt;2、Vmemmap区域：0xFFFF_7BFF_C000_0000——0xFFFF_7FFF_C000_0000（4096G）&lt;/p&gt;&lt;p&gt;3、PCI I/O区域：0xFFFF_7FFF_AE00_0000——0xFFFF_7FFF_BE00_0000（16M）&lt;/p&gt;&lt;p&gt;4、Moudules区域：0xFFFF_7FFF_C000_0000——0xFFFF_8000_0000_0000（64M）&lt;/p&gt;&lt;p&gt;5、Normal memory线性映射区：0xFFFF_8000_0000_0000——0xFFFF_FFFF_FFFF_FFFF（128T）&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;ARM体系结构可以用两种方法存储字数据，分别为大端模式和小端模式。&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;大端模式(高低高低): 字的高字节存储在低地址字节单元中，字的低字节存储在高地址字节单元中。&lt;/p&gt;&lt;section&gt;小端模式(高高低低): 字的高字节存储在高地址字节单元中，字的低字节存储在低地址字节单元中。&lt;/section&gt;&lt;p&gt;&lt;img class=&quot;rich_pages wxw-img&quot; data-ratio=&quot;0.5771929824561404&quot; data-src=&quot;https://mmbiz.qpic.cn/mmbiz_png/jVCRndy8Lr56wmbQFfFxNWeISBXiapTZj1oo5OSpoU0rSXkNe1ibDaX0Dduheg8vkvJqk1gWdlcBunJ7noeLk7Sg/640?wx_fmt=png&amp;amp;random=0.7104519849009281&amp;amp;random=0.34006647645156174&amp;amp;random=0.18129165829141836&amp;amp;random=0.9945198562275246&amp;amp;random=0.49046453935026957&amp;amp;random=0.7330181974289991&quot; data-type=&quot;png&quot; data-w=&quot;570&quot;/&gt;&lt;/p&gt;&lt;p&gt; &lt;/p&gt;&lt;section data-class=&quot;_mbEditor&quot; data-id=&quot;122&quot;&gt;&lt;section&gt;&lt;section&gt;&lt;section data-component-id=&quot;3v8Od6z&quot;&gt;&lt;span&gt;&lt;section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;结束&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;/section&gt;&lt;/span&gt;&lt;/section&gt;&lt;/section&gt;&lt;/section&gt;
&lt;/section&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt; 【推荐阅读】&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&amp;amp;mid=2247485442&amp;amp;idx=1&amp;amp;sn=f231b431428c6c1e04e222297c858da3&amp;amp;chksm=f9802a63cef7a37516f4a4c83d290542cf14de5911ffa27ac628847415ee553adcba1caddfda&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;你需要了解的APP安全&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;你需要了解的APP安全&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&amp;amp;mid=2247486296&amp;amp;idx=1&amp;amp;sn=4172fc587c598d68df6c9588c18cc848&amp;amp;chksm=f9802939cef7a02f1ca8377b19160c1032c75bcef811af00e84f554269aba45d19628dee6181&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;APP隐私合规&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;APP隐私合规&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;a target=&quot;_blank&quot; href=&quot;http://mp.weixin.qq.com/s?__biz=MzUxODkyODE0Mg==&amp;amp;mid=2247489000&amp;amp;idx=1&amp;amp;sn=a9ff1413307a7d20691ea0ca1696f20b&amp;amp;chksm=f9803789cef7be9f8b7617c063eefaa0ecd1bffb43de85a66fce7c453eb17b8c7b37edf1fa51&amp;amp;scene=21#wechat_redirect&quot; textvalue=&quot;APP应用安全检测&quot; linktype=&quot;text&quot; imgurl=&quot;&quot; imgdata=&quot;null&quot; data-itemshowtype=&quot;0&quot; tab=&quot;innerlink&quot; data-linktype=&quot;2&quot;&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;APP应用安全检测&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;

          

          
          &lt;/div&gt;&lt;/div&gt;</content:encoded>
</item>
</channel></rss>